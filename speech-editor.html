<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speech Editor - Campaign AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f8fafc;
            color: #334155;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .view-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .view-mode-selector {
            display: flex;
            gap: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 4px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-mode {
            padding: 6px 12px;
            border-radius: 4px;
            background: transparent;
            color: rgba(255,255,255,0.7);
        }

        .btn-mode:hover {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .btn-mode.active {
            background: white;
            color: #3b82f6;
            font-weight: 600;
        }

        .btn-primary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-primary:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-secondary {
            background: white;
            color: #3b82f6;
            border: 1px solid #3b82f6;
        }

        .btn-secondary:hover {
            background: #eff6ff;
        }

        .main-container {
            display: flex;
            height: calc(100vh - 72px);
        }

        .sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid #e2e8f0;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar h3 {
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .speech-info {
            background: #f1f5f9;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 14px;
        }

        .info-label {
            color: #64748b;
        }

        .info-value {
            color: #1e293b;
            font-weight: 500;
        }

        .section-list {
            margin-top: 20px;
        }

        .section-item {
            padding: 10px;
            margin: 4px 0;
            background: #f8fafc;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            border: 1px solid transparent;
        }

        .section-item:hover {
            background: #e2e8f0;
            border-color: #3b82f6;
        }

        .section-item.active {
            background: #eff6ff;
            border-color: #3b82f6;
            color: #1e40af;
        }

        .content-area {
            flex: 1;
            background: white;
            margin: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow-y: auto;
            position: relative;
        }

        .speech-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px;
        }

        /* Edit View Styles */
        .edit-view .speech-container {
            background: #f8fafc;
            border-radius: 8px;
        }

        .paste-area {
            width: 100%;
            min-height: 500px;
            padding: 20px;
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            font-size: 16px;
            line-height: 1.8;
            resize: vertical;
            background: white;
            font-family: 'Georgia', serif;
        }

        .paste-area:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .metadata-section {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .metadata-section h3 {
            margin: 0 0 16px 0;
            color: #374151;
            font-size: 16px;
            font-weight: 600;
        }

        .metadata-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .metadata-field {
            display: flex;
            flex-direction: column;
        }

        .metadata-field label {
            font-size: 13px;
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .metadata-field input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .metadata-field input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        @media (max-width: 768px) {
            .metadata-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Formatted View Styles */
        .formatted-view .speech-section {
            margin-bottom: 48px;
            padding: 20px;
            border-radius: 8px;
            background: white;
            transition: all 0.2s;
        }

        .formatted-view .speech-section:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .section-type {
            display: inline-block;
            padding: 4px 12px;
            background: #3b82f6;
            color: white;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .section-type.opening { background: #10b981; }
        .section-type.theme { background: #8b5cf6; }
        .section-type.point { background: #f59e0b; }
        .section-type.story { background: #ec4899; }
        .section-type.closing { background: #ef4444; }
        .section-type.callout { background: #06b6d4; }

        .speech-text {
            font-size: 18px;
            line-height: 1.8;
            font-family: 'Georgia', serif;
            color: #1e293b;
        }

        .speech-text p {
            margin-bottom: 32px;
        }

        .speech-emphasis {
            background: linear-gradient(to right, #fef3c7, transparent);
            padding: 2px 4px;
            font-weight: 500;
        }

        .speech-pause {
            color: #94a3b8;
            font-style: italic;
            font-size: 14px;
            margin: 12px 0;
        }

        /* SPEECH COACH STYLING: Professional teleprompter guidance */

        /* Primary emphasis - RED for maximum stress */
        .teleprompter-text .primary-emphasis {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            color: white;
            font-weight: 900;
            padding: 4px 8px;
            border-radius: 6px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
            border: 2px solid #b91c1c;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Secondary emphasis - GOLD for moderate stress */
        .teleprompter-text .secondary-emphasis {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            color: #1f2937;
            font-weight: 700;
            padding: 3px 6px;
            border-radius: 4px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            border: 1px solid #d97706;
        }

        /* Dramatic pause - PURPLE for maximum impact */
        .teleprompter-text .dramatic-pause {
            background: linear-gradient(135deg, #7c3aed, #8b5cf6);
            color: white;
            font-weight: 700;
            font-size: 20px;
            text-align: center;
            margin: 24px 0;
            padding: 16px;
            border: 3px solid #6d28d9;
            border-radius: 12px;
            display: block;
            animation: pulse 2s infinite;
        }

        /* Standard pause - BLUE for regular pauses */
        .teleprompter-text .standard-pause {
            background: rgba(59, 130, 246, 0.2);
            color: #1d4ed8;
            font-weight: 600;
            font-size: 16px;
            text-align: center;
            margin: 16px 0;
            padding: 12px;
            border: 2px dashed #3b82f6;
            border-radius: 8px;
            display: block;
        }

        /* Tactical pause - GREEN for quick impact */
        .teleprompter-text .tactical-pause {
            background: rgba(34, 197, 94, 0.2);
            color: #15803d;
            font-weight: 600;
            font-size: 14px;
            text-align: center;
            margin: 12px 0;
            padding: 8px;
            border: 2px solid #22c55e;
            border-radius: 6px;
            display: block;
        }

        /* Rhetorical pause - ORANGE for questions */
        .teleprompter-text .rhetorical-pause {
            background: rgba(249, 115, 22, 0.2);
            color: #ea580c;
            font-weight: 600;
            font-size: 16px;
            text-align: center;
            margin: 16px 0;
            padding: 12px;
            border: 2px solid #f97316;
            border-radius: 8px;
            display: block;
        }

        /* Breathing cue - subtle gray */
        .teleprompter-text .breath-cue {
            color: #6b7280;
            font-size: 12px;
            font-style: italic;
            opacity: 0.7;
        }

        /* Humor blocks - YELLOW for jokes and light moments */
        .teleprompter-text .humor-block {
            background: rgba(251, 191, 36, 0.3);
            color: #d97706;
            font-weight: 600;
            font-size: 16px;
            padding: 16px;
            margin: 20px 0;
            border: 2px solid #f59e0b;
            border-radius: 12px;
            display: block;
            position: relative;
        }

        .teleprompter-text .humor-block::before {
            content: "😄 HUMOR";
            position: absolute;
            top: -8px;
            left: 12px;
            background: #f59e0b;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }

        /* Story/anecdote blocks - PURPLE for personal stories */
        .teleprompter-text .story-block {
            background: rgba(139, 92, 246, 0.2);
            color: #6d28d9;
            font-style: italic;
            font-size: 16px;
            padding: 16px;
            margin: 20px 0;
            border-left: 4px solid #8b5cf6;
            border-radius: 0 8px 8px 0;
            display: block;
            position: relative;
        }

        .teleprompter-text .story-block::before {
            content: "📖 STORY";
            position: absolute;
            top: -8px;
            left: 12px;
            background: #8b5cf6;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }

        /* Call to action blocks - BRIGHT GREEN */
        .teleprompter-text .cta-block {
            background: rgba(16, 185, 129, 0.2);
            color: #047857;
            font-weight: bold;
            font-size: 18px;
            padding: 20px;
            margin: 24px 0;
            border: 3px solid #10b981;
            border-radius: 8px;
            text-align: center;
            display: block;
            position: relative;
        }

        .teleprompter-text .cta-block::before {
            content: "🎯 CALL TO ACTION";
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: #10b981;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        /* Paragraph spacing for teleprompter */
        .teleprompter-text .speech-paragraph {
            line-height: 1.8;
            margin-bottom: 40px;
        }

        /* Pulse animation for dramatic pauses */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Speech coaching interface elements */
        .speech-coach-header {
            text-align: center;
            padding: 16px;
            background: linear-gradient(135deg, #1f2937, #374151);
            color: white;
            border-bottom: 2px solid #4f46e5;
        }

        .speech-coach-header h3 {
            margin: 0 0 8px 0;
            font-size: 18px;
            color: #fbbf24;
        }

        .speech-coach-header p {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
        }

        .speech-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 12px;
            background: rgba(31, 41, 55, 0.8);
            border-top: 1px solid #374151;
            flex-wrap: wrap;
        }

        .legend-item {
            font-size: 12px;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .coaching-panel {
            background: linear-gradient(135deg, #1f2937, #111827);
            color: white;
            padding: 20px;
            border-top: 2px solid #4f46e5;
            max-height: 300px;
            overflow-y: auto;
        }

        .coaching-panel h4 {
            margin: 0 0 16px 0;
            color: #fbbf24;
            text-align: center;
        }

        .coaching-panel ul {
            list-style: none;
            padding: 0;
            margin: 0 0 16px 0;
        }

        .coaching-panel li {
            padding: 8px 0;
            border-bottom: 1px solid rgba(75, 85, 99, 0.3);
        }

        .coaching-panel em {
            color: #9ca3af;
            font-size: 14px;
            text-align: center;
            display: block;
            margin-top: 16px;
            padding: 12px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 8px;
        }

        .teleprompter-btn.primary {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            font-weight: 700;
            font-size: 16px;
        }

        .teleprompter-btn.coaching {
            background: linear-gradient(135deg, #7c3aed, #8b5cf6);
        }

        .teleprompter-btn.paused {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            animation: pulse 2s infinite;
        }

        /* Story Analysis Modal */
        .story-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .story-modal-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .story-header {
            background: linear-gradient(135deg, #1f2937, #374151);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }

        .story-score-section {
            padding: 20px;
            text-align: center;
        }

        .score-bar {
            background: #e5e7eb;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .score-fill {
            background: linear-gradient(90deg, #dc2626, #fbbf24, #22c55e);
            height: 100%;
            transition: width 0.5s ease;
        }

        .framework-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .framework-item {
            text-align: center;
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
        }

        .framework-item .count {
            font-size: 2em;
            font-weight: bold;
            color: #3b82f6;
            margin: 10px 0;
        }

        .element-checks {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px;
        }

        .check-item {
            padding: 12px;
            border-radius: 6px;
            font-weight: 500;
        }

        .check-item.present {
            background: #dcfce7;
            color: #166534;
        }

        .check-item.missing {
            background: #fef2f2;
            color: #991b1b;
        }

        .story-suggestions ul {
            padding: 20px;
            margin: 0;
        }

        .story-suggestions li {
            margin: 10px 0;
            padding: 10px;
            background: #f8fafc;
            border-left: 4px solid #3b82f6;
            border-radius: 4px;
        }

        .traditional-analysis {
            padding: 20px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
        }

        /* Teleprompter View */
        .teleprompter-view {
            background: #0f172a;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px;
        }

        .teleprompter-text {
            font-size: 48px;
            line-height: 1.5;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            text-align: center;
            max-width: 1000px;
            margin: 0 auto;
        }

        .teleprompter-controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            background: rgba(0,0,0,0.8);
            padding: 12px 20px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .teleprompter-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .teleprompter-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Speaker Notes */
        .speaker-note {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 12px 16px;
            margin: 16px 0;
            font-size: 14px;
            font-style: italic;
            color: #92400e;
            border-radius: 4px;
        }

        .time-marker {
            display: inline-block;
            background: #e0e7ff;
            color: #3730a3;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
        }

        .stats-bar {
            background: #f1f5f9;
            padding: 12px 20px;
            display: flex;
            gap: 24px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
        }

        .stat-item {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .stat-label {
            color: #64748b;
        }

        .stat-value {
            color: #1e293b;
            font-weight: 600;
        }

        .paste-prompt {
            text-align: center;
            color: #94a3b8;
            margin-top: 40px;
        }

        .paste-prompt h2 {
            font-size: 24px;
            color: #475569;
            margin-bottom: 12px;
        }

        .paste-prompt p {
            font-size: 16px;
            margin-bottom: 8px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .teleprompter-view.scrolling .teleprompter-text {
            animation: scroll linear infinite;
        }

        @keyframes scroll {
            0% { transform: translateY(100%); }
            100% { transform: translateY(-100%); }
        }

        /* Printout View Styles */
        .printout-view {
            background: white;
            max-width: 8.5in;
            margin: 0 auto;
            padding: 1in;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            font-family: 'Times New Roman', serif;
            line-height: 1.8;
        }

        .printout-view .speech-header {
            margin-bottom: 2rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 1rem;
        }

        .printout-view .speech-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 1rem;
            border: none;
            outline: none;
            width: 100%;
            text-align: center;
            background: transparent;
        }

        .printout-view .speech-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 1rem;
        }

        .printout-view .speech-content {
            font-size: 14pt;
            line-height: 2;
            min-height: 6in;
            outline: none;
            border: none;
        }

        .printout-view .speech-content p {
            margin-bottom: 3rem;
            text-indent: 2rem;
        }

        .printout-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }

        @media print {
            .printout-actions { display: none !important; }
            .view-controls { display: none !important; }
        }

        /* Structure View Styles */
        .structure-view {
            background: #f8fafc;
            padding: 2rem;
        }

        .structure-view .structure-header {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border-left: 4px solid #3b82f6;
        }

        .structure-view .structure-header h2 {
            margin: 0 0 0.5rem 0;
            color: #1f2937;
        }

        .wp-section {
            background: white;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border: 1px solid #e5e7eb;
            overflow: hidden;
            transition: all 0.2s;
        }

        .wp-section:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }

        .wp-section-header {
            background: #f9fafb;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .wp-section-type {
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .wp-section-actions {
            display: flex;
            gap: 0.5rem;
        }

        .wp-btn {
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .wp-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }

        .wp-btn.copy-btn:hover {
            background: #dbeafe;
            border-color: #3b82f6;
        }

        .wp-btn.delete-btn:hover {
            background: #fee2e2;
            border-color: #ef4444;
        }

        .wp-section-content {
            padding: 1rem;
            min-height: 3rem;
            outline: none;
            border: none;
            line-height: 1.6;
            font-family: inherit;
        }

        .wp-section-content:focus {
            background: #fffbeb;
        }

        .wp-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        /* Story Analysis Styles */
        .story-analysis {
            margin-top: 15px;
        }

        .analysis-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.875rem;
        }

        .analysis-label {
            color: #6b7280;
            font-weight: 500;
        }

        .analysis-value {
            color: #1e293b;
            font-weight: 600;
        }

        .sparkline-visual {
            margin: 15px 0;
            padding: 10px;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            min-height: 60px;
            position: relative;
        }

        .sparkline-chart {
            width: 100%;
            height: 50px;
            position: relative;
        }

        .sparkline-segment {
            position: absolute;
            height: 20px;
            border-radius: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: white;
            font-weight: 500;
        }

        .sparkline-segment.what-is {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            top: 25px;
        }

        .sparkline-segment.what-could-be {
            background: linear-gradient(135deg, #10b981, #059669);
            top: 5px;
        }

        .sparkline-segment:hover {
            transform: scale(1.05);
            z-index: 2;
        }

        .sparkline-legend {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.75rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 6px;
        }

        .legend-color.what-is {
            background: #ef4444;
        }

        .legend-color.what-could-be {
            background: #10b981;
        }

        /* Additional Structure View Styles */
        .structure-sections {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .structure-section {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 0;
            overflow: hidden;
            transition: all 0.2s;
        }

        .structure-section:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }

        .section-type-label {
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .section-stats {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .section-content {
            padding: 1rem;
            min-height: 3rem;
            outline: none;
            border: none;
            line-height: 1.6;
            font-family: inherit;
        }

        .section-content:focus {
            background: #fffbeb;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }

        .initial-paste-area {
            width: 100%;
            min-height: 200px;
            padding: 1rem;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            font-family: inherit;
            font-size: inherit;
            outline: none;
            margin-top: 1rem;
            resize: vertical;
        }

        .initial-paste-area:focus {
            border-color: #3b82f6;
            background: #f8fafc;
        }

        /* Story Workflow Styles */
        .story-workflow {
            margin-top: 15px;
        }

        .workflow-step {
            margin-bottom: 8px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            overflow: hidden;
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            cursor: pointer;
            background: #f9fafb;
            transition: background-color 0.2s;
        }

        .step-header:hover {
            background: #f3f4f6;
        }

        .step-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #3b82f6;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .step-title {
            flex: 1;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .step-status {
            font-size: 1.2rem;
            color: #9ca3af;
        }

        .step-status.completed {
            color: #10b981;
        }

        .step-content {
            padding: 12px;
            background: white;
            border-top: 1px solid #e5e7eb;
        }

        .step-content p {
            margin: 0 0 8px 0;
            font-size: 0.875rem;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🎤 Speech Editor</h1>
        <div class="view-controls">
            <div class="view-mode-selector">
                <button class="btn btn-mode" onclick="switchView('structure')" id="structure-mode">
                    ✏️ Edit
                </button>
                <button class="btn btn-mode active" onclick="switchView('printout')" id="printout-mode">
                    📄 Formatted
                </button>
                <button class="btn btn-mode" onclick="switchView('teleprompter')" id="teleprompter-mode">
                    📺 Teleprompter
                </button>
            </div>
            <button class="btn btn-secondary" onclick="analyzeStoryStructure()" title="Analyze story structure">
                🔍 Analyze
            </button>
            <button class="btn btn-secondary" onclick="exportSpeech()" title="Export speech">
                💾 Export
            </button>
            <button class="btn btn-secondary" onclick="saveSpeech()">💾 Save</button>
            <button class="btn btn-primary" onclick="newSpeech()">🗒️ New Speech</button>
            <button class="btn btn-secondary" onclick="openDashboard()">📋 Dashboard</button>
            <button class="btn btn-primary" onclick="window.close()">✕ Close</button>
        </div>
    </div>

    <div class="main-container" id="main-container">
        <div class="sidebar" id="sidebar">
            <h3>Speech Info</h3>
            <div class="speech-info">
                <div class="info-item">
                    <span class="info-label">Word Count:</span>
                    <span class="info-value" id="word-count">0</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Est. Duration:</span>
                    <span class="info-value" id="duration">0 min</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Sections:</span>
                    <span class="info-value" id="section-count">0</span>
                </div>
            </div>

            <h3>Structure</h3>
            <div class="section-list" id="section-list">
                <!-- Sections will be populated here -->
            </div>

            <h3>🎭 Story Analysis</h3>
            <div class="story-analysis" id="story-analysis">
                <div class="analysis-item">
                    <span class="analysis-label">Sparkline Score:</span>
                    <span class="analysis-value" id="sparkline-score">-</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">What Is Segments:</span>
                    <span class="analysis-value" id="what-is-count">0</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">What Could Be:</span>
                    <span class="analysis-value" id="what-could-be-count">0</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">Contrast Ratio:</span>
                    <span class="analysis-value" id="contrast-ratio">-</span>
                </div>
                <div class="sparkline-visual" id="sparkline-visual">
                    <!-- Sparkline chart will be populated here -->
                </div>
                <button class="btn btn-sm" onclick="analyzeStoryStructure()" style="margin-top: 10px;">
                    ⚡ Analyze Structure
                </button>
            </div>

            <h3>🎭 Story Development</h3>
            <div class="story-workflow" id="story-workflow">
                <div class="workflow-step" data-step="1">
                    <div class="step-header" onclick="toggleWorkflowStep(1)">
                        <span class="step-number">1</span>
                        <span class="step-title">Empathy Walk</span>
                        <span class="step-status" id="step-1-status">◯</span>
                    </div>
                    <div class="step-content" id="step-1-content" style="display: none;">
                        <p>Understand your audience deeply</p>
                        <button class="btn btn-sm" onclick="startEmpathyWalk()">🚶 Start Empathy Walk</button>
                    </div>
                </div>
                <div class="workflow-step" data-step="2">
                    <div class="step-header" onclick="toggleWorkflowStep(2)">
                        <span class="step-number">2</span>
                        <span class="step-title">Define Big Idea</span>
                        <span class="step-status" id="step-2-status">◯</span>
                    </div>
                    <div class="step-content" id="step-2-content" style="display: none;">
                        <p>Craft your core message</p>
                        <button class="btn btn-sm" onclick="defineBigIdea()">💡 Define Big Idea</button>
                    </div>
                </div>
                <div class="workflow-step" data-step="3">
                    <div class="step-header" onclick="toggleWorkflowStep(3)">
                        <span class="step-number">3</span>
                        <span class="step-title">Create Sparkline</span>
                        <span class="step-status" id="step-3-status">◯</span>
                    </div>
                    <div class="step-content" id="step-3-content" style="display: none;">
                        <p>Structure your What Is vs What Could Be flow</p>
                        <button class="btn btn-sm" onclick="showSparklineDialog()">🎭 Create Sparkline</button>
                        <button class="btn btn-sm" onclick="useStoryTemplate()">📝 Use Template</button>
                    </div>
                </div>
                <div class="workflow-step" data-step="4">
                    <div class="step-header" onclick="toggleWorkflowStep(4)">
                        <span class="step-number">4</span>
                        <span class="step-title">Write & Refine</span>
                        <span class="step-status" id="step-4-status">◯</span>
                    </div>
                    <div class="step-content" id="step-4-content" style="display: none;">
                        <p>Develop your speech content</p>
                        <button class="btn btn-sm" onclick="switchView('structure')">🏗️ Edit Structure</button>
                    </div>
                </div>
                <div class="workflow-step" data-step="5">
                    <div class="step-header" onclick="toggleWorkflowStep(5)">
                        <span class="step-number">5</span>
                        <span class="step-title">Practice & Deliver</span>
                        <span class="step-status" id="step-5-status">◯</span>
                    </div>
                    <div class="step-content" id="step-5-content" style="display: none;">
                        <p>Use teleprompter for delivery</p>
                        <button class="btn btn-sm" onclick="switchView('teleprompter')">📺 Teleprompter</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-area printout-view" id="content-area">
            <div class="stats-bar">
                <div class="stat-item">
                    <span class="stat-label">Characters:</span>
                    <span class="stat-value" id="char-count">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Paragraphs:</span>
                    <span class="stat-value" id="para-count">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Reading Speed:</span>
                    <span class="stat-value">150 words/min</span>
                </div>
            </div>

            <!-- Speech Metadata Section -->
            <div class="metadata-section" id="metadata-section" style="display: none;">
                <h3>📝 Speech Information</h3>
                <div class="metadata-grid">
                    <div class="metadata-field">
                        <label for="speech-description">Description/Title:</label>
                        <input type="text" id="speech-description" placeholder="e.g., Healthcare Initiative Announcement" oninput="updateMetadata()">
                    </div>
                    <div class="metadata-field">
                        <label for="speech-date">Date:</label>
                        <input type="text" id="speech-date" placeholder="e.g., September 23, 2024" oninput="updateMetadata()">
                    </div>
                    <div class="metadata-field">
                        <label for="speech-location">Location:</label>
                        <input type="text" id="speech-location" placeholder="e.g., Washington, D.C." oninput="updateMetadata()">
                    </div>
                    <div class="metadata-field">
                        <label for="speech-speaker">Speaker:</label>
                        <input type="text" id="speech-speaker" placeholder="e.g., John Doe, Candidate for Mayor" oninput="updateMetadata()">
                    </div>
                    <div class="metadata-field">
                        <label for="speech-source">Source:</label>
                        <input type="text" id="speech-source" placeholder="e.g., Campaign Press Release" oninput="updateMetadata()">
                    </div>
                </div>
            </div>

            <div class="speech-container" id="speech-container">
                <div class="paste-prompt">
                    <h2>Paste Your Speech Here</h2>
                    <p>Simply paste your speech text below and watch it transform</p>
                    <p>The AI will automatically detect sections, themes, and key moments</p>
                </div>
                <textarea class="paste-area" id="speech-input"
                    placeholder="Paste your speech here...

The editor will automatically:
• Detect opening, body, and closing sections
• Identify key themes and talking points
• Mark emphasis and pause points
• Calculate timing and pacing
• Format for easy reading or teleprompter use"></textarea>
            </div>
        </div>
    </div>

    <script>
        let currentView = 'printout';
        let speechData = {
            raw: '',
            sections: [],
            wordCount: 0,
            duration: 0,
            analysis: null,
            // Structured fields
            description: '',
            date: '',
            location: '',
            speaker: '',
            source: ''
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const speechInput = document.getElementById('speech-input');

            speechInput.addEventListener('input', handleSpeechInput);
            speechInput.addEventListener('paste', handlePaste);

            // Load from localStorage if available
            const saved = localStorage.getItem('speechDraft');
            const currentId = localStorage.getItem('currentSpeechId');

            if (saved) {
                speechInput.value = saved;
                speechData.raw = saved;

                // Load structured data if available
                if (currentId) {
                    loadSpeechMetadata(currentId);
                }

                handleSpeechInput();
                showMetadataSection();
                // If there's saved content, show it in the current view
                switchView(currentView);
            } else {
                // Initialize with empty printout view
                renderPrintoutView();
            }

            // Check for communications brief from communications director
            checkForCommunicationsBrief();
        });

        function loadSpeechMetadata(speechId) {
            const speechLibrary = JSON.parse(localStorage.getItem('speechLibrary') || '[]');
            const speech = speechLibrary.find(s => s.id === speechId);

            if (speech) {
                speechData.description = speech.description || '';
                // Handle legacy dateline or new separate fields
                if (speech.dateline) {
                    // Try to split legacy dateline into date and location
                    const parts = speech.dateline.split(/\s*[-–—]\s*/);
                    if (parts.length === 2) {
                        speechData.date = parts[0].trim();
                        speechData.location = parts[1].trim();
                    } else {
                        speechData.date = speech.dateline;
                        speechData.location = '';
                    }
                } else {
                    speechData.date = speech.date || '';
                    speechData.location = speech.location || '';
                }
                speechData.speaker = speech.speaker || '';
                speechData.source = speech.source || '';

                // Update UI fields
                document.getElementById('speech-description').value = speechData.description;
                document.getElementById('speech-date').value = speechData.date;
                document.getElementById('speech-location').value = speechData.location;
                document.getElementById('speech-speaker').value = speechData.speaker;
                document.getElementById('speech-source').value = speechData.source;
            }
        }

        function showMetadataSection() {
            document.getElementById('metadata-section').style.display = 'block';
        }

        function updateMetadata() {
            speechData.description = document.getElementById('speech-description').value;
            speechData.date = document.getElementById('speech-date').value;
            speechData.location = document.getElementById('speech-location').value;
            speechData.speaker = document.getElementById('speech-speaker').value;
            speechData.source = document.getElementById('speech-source').value;
        }

        function handleSpeechInput(e) {
            const text = document.getElementById('speech-input').value;
            speechData.raw = text;

            // Auto-save to localStorage
            localStorage.setItem('speechDraft', text);

            // Update stats
            updateStats(text);

            // Parse structure if enough content
            if (text.length > 100) {
                parseSpeechStructure(text);
            }
        }

        function handlePaste(e) {
            setTimeout(() => {
                const pastedContent = document.getElementById('speech-input').value;

                // Try to parse structured content and populate metadata fields
                if (pastedContent && pastedContent.length > 50) {
                    tryParseStructuredContent(pastedContent);
                }

                handleSpeechInput();
                showMetadataSection();

                // Auto-switch to formatted view after paste
                if (speechData.raw.length > 100) {
                    setTimeout(() => {
                        switchView('formatted');
                    }, 500);
                }
            }, 100);
        }

        function tryParseStructuredContent(content) {
            // Simple parsing logic for structured speeches
            const lines = content.split('\n').map(line => line.trim()).filter(line => line.length > 0);

            let foundStructure = false;

            for (let i = 0; i < Math.min(lines.length, 10); i++) {
                const line = lines[i];

                // Look for dateline patterns
                if (/^[A-Z\s]+,\s*[A-Z]{2,}\s*[-–—]\s*/.test(line) ||
                    /^\w+\s+\d{1,2},?\s+\d{4}/.test(line) ||
                    /^\d{1,2}\/\d{1,2}\/\d{4}/.test(line)) {
                    document.getElementById('speech-dateline').value = line;
                    speechData.dateline = line;
                    foundStructure = true;
                }

                // Look for speaker patterns
                if (line.includes('SPEAKER:') || line.includes('Speaker:') ||
                    /^[A-Z\s]{5,}:?\s*$/.test(line) ||
                    line.toLowerCase().includes('remarks by')) {
                    const speaker = line.replace(/^(SPEAKER|Speaker|Remarks by):?\s*/i, '').replace(/:+$/, '').trim();
                    document.getElementById('speech-speaker').value = speaker;
                    speechData.speaker = speaker;
                    foundStructure = true;
                }
            }

            // Look for source at the end
            for (let i = Math.max(0, lines.length - 5); i < lines.length; i++) {
                const line = lines[i];
                if (line.toLowerCase().includes('source:') ||
                    line.toLowerCase().startsWith('via ') ||
                    line.includes('http') || line.includes('www.')) {
                    const source = line.replace(/^source:?\s*/i, '').trim();
                    document.getElementById('speech-source').value = source;
                    speechData.source = source;
                    foundStructure = true;
                }
            }

            if (foundStructure) {
                showToast('📋 Detected structured content and populated metadata fields!', 'success');
            }
        }

        function updateStats(text) {
            const words = text.trim().split(/\s+/).filter(w => w.length > 0);
            const chars = text.length;
            const paragraphs = text.split(/\n\n+/).filter(p => p.trim().length > 0);

            speechData.wordCount = words.length;
            speechData.duration = Math.ceil(words.length / 150); // 150 words per minute

            document.getElementById('word-count').textContent = words.length.toLocaleString();
            document.getElementById('duration').textContent = `${speechData.duration} min`;
            document.getElementById('char-count').textContent = chars.toLocaleString();
            document.getElementById('para-count').textContent = paragraphs.length;
        }

        function parseSpeechStructure(text) {
            const paragraphs = text.split(/\n\n+/).filter(p => p.trim().length > 0);
            const sections = [];

            paragraphs.forEach((para, index) => {
                const section = analyzeParagraph(para, index, paragraphs.length);
                if (section) {
                    sections.push(section);
                }
            });

            speechData.sections = mergeSimilarSections(sections);
            document.getElementById('section-count').textContent = speechData.sections.length;

            renderSectionList();

            if (currentView === 'formatted') {
                renderFormattedView();
            }
        }

        function analyzeParagraph(text, index, total) {
            const trimmed = text.trim();
            const lower = trimmed.toLowerCase();
            let type = 'body';
            let title = '';

            // Detect Subject/Title (first line, often starts with transcript markers)
            if (index === 0) {
                // Remove TRANSCRIPT: prefix if present, keeping the actual title
                const cleanTitle = trimmed.replace(/^transcript:\s*/i, '').trim();
                type = 'subject';
                title = 'Speech Title';
                return {
                    type,
                    title,
                    content: cleanTitle,
                    wordCount: cleanTitle.split(/\s+/).length
                };
            }

            // Detect combined Date and Location (e.g., "September 16, 2025 - Washington, D.C.")
            if (index === 1 && /[-–—]/.test(trimmed)) {
                // Split by dash to separate date and location
                const parts = trimmed.split(/\s*[-–—]\s*/);
                if (parts.length === 2) {
                    const datePart = parts[0].trim();
                    const locationPart = parts[1].trim();

                    // Check if first part looks like a date
                    if (/\w+\s+\d{1,2},?\s+\d{4}|\d{1,2}\/\d{1,2}\/\d{4}|\d{4}-\d{2}-\d{2}/.test(datePart)) {
                        // This line contains both date and location - return as combined for now
                        // but mark it specially so we know it contains both
                        type = 'date-location';
                        title = 'Date & Location';
                        return {
                            type,
                            title,
                            content: trimmed,
                            wordCount: trimmed.split(/\s+/).length,
                            datePart: datePart,
                            locationPart: locationPart
                        };
                    }
                }
            }

            // Detect Date (second line, date patterns)
            if (index === 1 && (
                /^\w+\s+\d{1,2},?\s+\d{4}/.test(trimmed) ||          // "September 16, 2025"
                /^\d{1,2}\/\d{1,2}\/\d{4}/.test(trimmed) ||          // "9/16/2025"
                /^\d{4}-\d{2}-\d{2}/.test(trimmed)                   // "2025-09-16"
            )) {
                type = 'date';
                title = 'Date';
                return {
                    type,
                    title,
                    content: trimmed,
                    wordCount: trimmed.split(/\s+/).length
                };
            }

            // Detect Location (often third line, city/state patterns)
            if (index <= 2 && (
                /^[A-Z\s]+,\s*[A-Z]{2,}(\s*[-–—]\s*)?/.test(trimmed) || // "WASHINGTON, D.C. -"
                /^[A-Za-z\s]+,\s*[A-Z]{2}(\s*[-–—]\s*)?/.test(trimmed)  // "New York, NY -"
            )) {
                type = 'location';
                title = 'Location';
                return {
                    type,
                    title,
                    content: trimmed,
                    wordCount: trimmed.split(/\s+/).length
                };
            }

            // Detect Opening (greeting patterns)
            if (lower.includes('good morning') || lower.includes('good evening') ||
                lower.includes('thank you for') || lower.includes('honored to') ||
                lower.includes('delighted to') || lower.includes('pleased to') ||
                lower.includes('my fellow') || lower.includes('ladies and gentlemen')) {
                type = 'opening';
                title = 'Opening';
                return {
                    type,
                    title,
                    content: trimmed,
                    wordCount: trimmed.split(/\s+/).length
                };
            }

            // Detect Closing (conclusion patterns, typically in last 1-2 paragraphs)
            if (index >= total - 2 && (
                lower.includes('thank you') || lower.includes('god bless') ||
                lower.includes('together we') || lower.includes('let us') ||
                lower.includes('in conclusion') || lower.includes('to conclude') ||
                lower.includes('moving forward') || lower.includes('our future')
            )) {
                type = 'closing';
                title = 'Closing';
                return {
                    type,
                    title,
                    content: trimmed,
                    wordCount: trimmed.split(/\s+/).length
                };
            }

            // Detect Source (can be at the end or after the closing, contains attribution/context)
            if ((index >= total - 2) && (
                lower.includes('source:') || lower.includes('via ') ||
                lower.includes('transcript from') || lower.includes('http') ||
                lower.includes('www.') || lower.includes('statement from') ||
                lower.includes('press release') || lower.includes('remarks provided by') ||
                lower.includes('this transcript') || lower.includes('senate democratic') ||
                lower.includes('house democratic') || lower.includes('campaign') ||
                lower.includes('delivered at') || lower.includes('complete text')
            )) {
                type = 'source';
                title = 'Source';
                return {
                    type,
                    title,
                    content: trimmed,
                    wordCount: trimmed.split(/\s+/).length
                };
            }

            // Default to Body Paragraph with numbering
            const bodyNumber = calculateBodyParagraphNumber(index, total);
            type = 'body';
            title = `Body Paragraph ${bodyNumber}`;

            return {
                type,
                title,
                content: trimmed,
                wordCount: trimmed.split(/\s+/).length
            };
        }

        function calculateBodyParagraphNumber(index, total) {
            // Skip subject, date, location, opening when counting body paragraphs
            let bodyIndex = index;

            // Subtract estimated structure elements
            if (index > 0) bodyIndex--; // subject
            if (index > 1) bodyIndex--; // date (if present)
            if (index > 2) bodyIndex--; // location (if present)

            // Account for opening paragraph
            if (bodyIndex > 0) bodyIndex--;

            // Ensure we start at 1
            return Math.max(1, bodyIndex + 1);
        }

        function extractPointNumber(text) {
            const matches = text.match(/first|second|third|fourth|fifth|one|two|three|four|five/i);
            if (matches) {
                const numbers = {
                    'first': 1, 'one': 1,
                    'second': 2, 'two': 2,
                    'third': 3, 'three': 3,
                    'fourth': 4, 'four': 4,
                    'fifth': 5, 'five': 5
                };
                return numbers[matches[0].toLowerCase()] || '';
            }
            return '';
        }

        function mergeSimilarSections(sections) {
            const merged = [];
            let current = null;

            sections.forEach(section => {
                if (current && current.type === section.type &&
                    current.type === 'point' && merged.length > 0) {
                    current.content += '\n\n' + section.content;
                    current.wordCount += section.wordCount;
                } else {
                    if (current) merged.push(current);
                    current = { ...section };
                }
            });

            if (current) merged.push(current);
            return merged;
        }

        function renderSectionList() {
            const list = document.getElementById('section-list');
            list.innerHTML = '';

            speechData.sections.forEach((section, index) => {
                const item = document.createElement('div');
                item.className = 'section-item';
                item.innerHTML = `
                    <strong>${section.title}</strong>
                    <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">
                        ${section.wordCount} words • ${Math.ceil(section.wordCount / 150)} min
                    </div>
                `;
                item.onclick = () => scrollToSection(index);
                list.appendChild(item);
            });
        }

        function scrollToSection(index) {
            if (currentView !== 'formatted') {
                switchView('formatted');
            }

            setTimeout(() => {
                const sections = document.querySelectorAll('.speech-section');
                if (sections[index]) {
                    sections[index].scrollIntoView({ behavior: 'smooth', block: 'center' });

                    // Highlight briefly
                    sections[index].style.background = '#fef3c7';
                    setTimeout(() => {
                        sections[index].style.background = '';
                    }, 2000);
                }
            }, 300);
        }

        function switchView(view) {
            currentView = view;

            // Update buttons
            document.querySelectorAll('.btn-mode').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(view + '-mode').classList.add('active');

            // Update content area
            const contentArea = document.getElementById('content-area');
            contentArea.className = 'content-area ' + view + '-view';

            // Clean up any existing event listeners
            if (view !== 'teleprompter') {
                document.removeEventListener('keydown', teleprompterKeyHandler);
            }

            // Render appropriate view
            switch(view) {
                case 'printout':
                    renderPrintoutView();
                    break;
                case 'structure':
                    renderStructureView();
                    break;
                case 'flow':
                    renderFlowView();
                    break;
                case 'blocks':
                    renderBlocksView();
                    break;
                case 'teleprompter':
                    renderTeleprompterView();
                    break;
            }

            // Show sidebar for editable views
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.style.display = (view === 'teleprompter' || view === 'blocks') ? 'none' : 'block';
            }
        }

        // PRINTOUT VIEW: Clean formatted speech for printing/PDF
        function renderPrintoutView() {
            const container = document.getElementById('speech-container');

            if (!speechData.raw || speechData.raw.trim().length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h2>📄 Printout View</h2>
                        <p>Paste your speech content to see a clean, print-ready format</p>
                        <textarea class="initial-paste-area" id="printout-input"
                            placeholder="Paste your speech here to get started..."></textarea>
                    </div>
                `;

                document.getElementById('printout-input').addEventListener('input', (e) => {
                    speechData.raw = e.target.value;
                    parseAndStructureSpeech(e.target.value);
                    syncToAllViews('printout');
                });
                return;
            }

            container.innerHTML = `
                <div class="printout-view">
                    <div class="printout-header">
                        <h1 class="speech-title" contenteditable="true" id="printout-title">${extractSpeechTitle(speechData.raw)}</h1>
                        <div class="speech-meta">
                            <div class="speech-date">${new Date().toLocaleDateString()}</div>
                        </div>
                    </div>
                    <div class="printout-content" contenteditable="true" id="printout-content">
                        ${formatPrintoutContent(speechData.raw)}
                    </div>
                    <div class="printout-footer">
                        <p><em>Generated by Campaign AI Editor</em></p>
                    </div>
                </div>
            `;

            // Add editing event listeners
            setupEditingListeners('printout');
        }

        function formatPrintoutContent(text) {
            // Clean formatting for print - no coaching hints, just clean paragraphs
            const paragraphs = text.split(/\n+/).map(p => p.trim()).filter(p => p.length > 0);
            return paragraphs.map(p => `<p class="printout-paragraph">${p}</p>`).join('');
        }

        // WORDPRESS VIEW: Editable sections for CMS publishing
        function renderWordPressView() {
            const container = document.getElementById('speech-container');

            if (!speechData.raw || speechData.raw.trim().length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h2>📝 WordPress Sections</h2>
                        <p>Break your speech into individual content blocks for CMS publishing</p>
                        <textarea class="initial-paste-area" id="wordpress-input"
                            placeholder="Paste your speech here to create sections..."></textarea>
                    </div>
                `;

                document.getElementById('wordpress-input').addEventListener('input', (e) => {
                    speechData.raw = e.target.value;
                    parseAndStructureSpeech(e.target.value);
                    syncToAllViews('wordpress');
                });
                return;
            }

            const sections = createWordPressSections(speechData.raw);

            container.innerHTML = `
                <div class="wordpress-view">
                    <div class="wp-header">
                        <h2>📝 WordPress Content Blocks</h2>
                        <p>Each section below can be copied as individual WordPress blocks</p>
                    </div>
                    <div id="wp-sections-container">
                        ${sections.map((section, index) => `
                            <div class="wp-section" data-section="${index}">
                                <div class="wp-section-header">
                                    <span class="wp-section-type">${section.type}</span>
                                    <div class="wp-section-actions">
                                        <button class="wp-btn copy-btn" onclick="copySection(${index})" title="Copy this section">📋 Copy</button>
                                        <button class="wp-btn delete-btn" onclick="deleteSection(${index})" title="Delete this section">🗑️</button>
                                    </div>
                                </div>
                                <div class="wp-section-content" contenteditable="true" data-section-index="${index}">
                                    ${section.content}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="wp-actions">
                        <button class="wp-btn primary" onclick="addNewSection()">➕ Add Section</button>
                        <button class="wp-btn secondary" onclick="exportWordPress()">💾 Export All</button>
                    </div>
                </div>
            `;

            // Add editing event listeners for WordPress sections
            setupWordPressListeners();
        }

        function createWordPressSections(text) {
            const paragraphs = text.split(/\n+/).map(p => p.trim()).filter(p => p.length > 0);
            const sections = [];

            paragraphs.forEach((para, index) => {
                let type = 'Paragraph';

                // Detect section types based on content
                if (index === 0 || para.length < 100) {
                    type = 'Headline';
                } else if (para.includes('"') || para.includes('"') || para.includes('"')) {
                    type = 'Quote';
                } else if (para.toLowerCase().includes('thank you') && index === paragraphs.length - 1) {
                    type = 'Closing';
                } else if (para.toLowerCase().includes('fellow') || para.toLowerCase().includes('friends')) {
                    type = 'Opening';
                }

                sections.push({
                    type,
                    content: para
                });
            });

            return sections;
        }

        function formatSpeechText(text) {
            // SPEECH COACH GUIDANCE: Professional emphasis and pause formatting

            // Primary emphasis words (STRESS THESE - core message words)
            text = text.replace(/\b(must|will|never|always|together|unite|united|america|americans|freedom|justice|change|hope|future|believe|fight|stand|strong|strength|victory|succeed|truth|promise|commitment|serve|country|nation|people|citizens|families|children|generations|legacy|history|right|wrong)\b/gi,
                               '<span class="speech-emphasis primary-emphasis" title="PRIMARY EMPHASIS: Stress this word">$1</span>');

            // Secondary emphasis words (moderate stress - supporting concepts)
            text = text.replace(/\b(we|our|us|today|now|important|critical|essential|power|dedication|service|moment|time|opportunity|challenge|overcome|achieve|accomplish|build|create|transform|improve|better|best|great|greatest|lead|leadership|vision|dream|goal|mission|purpose|values|principles|can)\b/gi,
                               '<span class="speech-emphasis secondary-emphasis" title="SECONDARY EMPHASIS: Moderate stress">$1</span>');

            // SPEECH COACH GUIDANCE: Enhanced pause instructions
            text = text.replace(/\.\.\./g, '<div class="speech-pause dramatic-pause" title="DRAMATIC PAUSE: Hold for 2-3 seconds">[DRAMATIC PAUSE - 3 seconds]</div>');
            text = text.replace(/\[pause\]/gi, '<div class="speech-pause standard-pause" title="STANDARD PAUSE: Hold for 1-2 seconds">[PAUSE - 2 seconds]</div>');
            text = text.replace(/\(pause\)/gi, '<div class="speech-pause standard-pause" title="STANDARD PAUSE: Hold for 1-2 seconds">[PAUSE - 2 seconds]</div>');

            // SPEECH COACH GUIDANCE: Automatic tactical pauses
            text = text.replace(/([.!])\s+([A-Z])/g, '$1<div class="speech-pause tactical-pause" title="TACTICAL PAUSE: Brief pause for impact">[TACTICAL PAUSE - 1 second]</div> $2');
            text = text.replace(/([?])\s+([A-Z])/g, '$1<div class="speech-pause rhetorical-pause" title="RHETORICAL PAUSE: Let the question sink in">[RHETORICAL PAUSE - 2 seconds]</div> $2');

            // SPEECH COACH GUIDANCE: Breathing cues for long sentences
            text = text.replace(/,\s+([A-Z])/g, ', <span class="breath-cue" title="BREATHING CUE: Quick breath if needed">[breath]</span> $1');

            // HUMOR DETECTION: Identify jokes and humorous content
            text = text.replace(/\[joke\](.*?)\[\/joke\]/gis, '<div class="humor-block" title="HUMOR BLOCK: Deliver with timing and smile">$1</div>');
            text = text.replace(/\(joke\)(.*?)\(\/joke\)/gis, '<div class="humor-block" title="HUMOR BLOCK: Deliver with timing and smile">$1</div>');

            // Auto-detect humor patterns
            text = text.replace(/(.*(?:funny|hilarious|joke|laugh|chuckle|amusing|witty|humor).*)/gi, '<div class="humor-block" title="HUMOR DETECTED: Consider comedic timing">$1</div>');
            text = text.replace(/(.*(?:you know what they say|speaking of|reminds me of).*)/gi, '<div class="story-block" title="ANECDOTE/STORY: Personal connection moment">$1</div>');

            // CALL TO ACTION DETECTION
            text = text.replace(/\[cta\](.*?)\[\/cta\]/gis, '<div class="cta-block" title="CALL TO ACTION: Strong, clear directive">$1</div>');
            text = text.replace(/(.*(?:vote|join|support|help|donate|volunteer|register|sign up|get involved|take action|call|contact|visit).*)/gi, '<div class="cta-block" title="CALL TO ACTION DETECTED: Emphasize urgency">$1</div>');

            // Convert to paragraphs with coaching structure
            const paragraphs = text.split(/\n+/).map(p => p.trim()).filter(p => p.length > 0).map(p => `<p class="speech-paragraph">${p}</p>`).join('');

            return paragraphs;
        }

        function renderTeleprompterView() {
            const container = document.getElementById('speech-container');

            if (!speechData.raw || speechData.raw.trim().length === 0) {
                container.innerHTML = `
                    <div class="teleprompter-view">
                        <div class="empty-teleprompter">
                            <h2>🎤 Teleprompter</h2>
                            <p>Enter speech content to see scrolling text for delivery</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Get clean speech text - just continuous paragraphs
            const cleanSpeechText = getCleanTeleprompterText(speechData.raw);
            const hintButtonText = speechHintsEnabled ? '💡 Hide Coaching' : '💡 Show Coaching';

            container.innerHTML = `
                <div class="teleprompter-view" id="teleprompter">
                    <div class="teleprompter-controls-top">
                        <button class="teleprompter-btn primary" onclick="startScroll()" id="scroll-toggle-btn">▶ Start (SPACE)</button>
                        <button class="teleprompter-btn" onclick="resetScroll()">⏮ Reset (ESC)</button>
                        <button class="teleprompter-btn" onclick="adjustSpeed(-20)">🐌 Slower (↓)</button>
                        <button class="teleprompter-btn" onclick="adjustSpeed(20)">🐰 Faster (↑)</button>
                        <button class="teleprompter-btn" onclick="toggleTextToSpeech()" id="tts-btn" title="Play speech with text-to-speech">🔊 Listen</button>
                        <button class="teleprompter-btn coaching" onclick="toggleCoachingTips()" title="Toggle coaching hints">${hintButtonText}</button>
                    </div>

                    <div class="teleprompter-text-container" id="teleprompter-text">
                        <div class="teleprompter-content">
                            ${speechHintsEnabled ? formatSpeechText(speechData.raw) : cleanSpeechText}
                        </div>
                    </div>

                    <div class="teleprompter-status">
                        <span id="scroll-speed-display">Speed: ${Math.round(((200 - scrollSpeed) / 180) * 100)}% (Normal)</span>
                        <span id="tts-status"></span>
                    </div>
                </div>
            `;

            // Add teleprompter-specific CSS
            if (!document.getElementById('teleprompter-enhanced-styles')) {
                const style = document.createElement('style');
                style.id = 'teleprompter-enhanced-styles';
                style.textContent = `
                    .teleprompter-view {
                        height: 100vh;
                        display: flex;
                        flex-direction: column;
                        background: #000;
                        color: #fff;
                        font-family: Georgia, serif;
                        overflow: hidden;
                    }

                    .teleprompter-controls-top {
                        display: flex;
                        justify-content: center;
                        gap: 10px;
                        padding: 15px;
                        background: rgba(0,0,0,0.8);
                        backdrop-filter: blur(10px);
                        border-bottom: 1px solid #333;
                        flex-shrink: 0;
                    }

                    .teleprompter-btn {
                        background: #333;
                        color: #fff;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                        transition: all 0.2s;
                    }

                    .teleprompter-btn:hover {
                        background: #555;
                    }

                    .teleprompter-btn.primary {
                        background: #3b82f6;
                    }

                    .teleprompter-btn.primary:hover {
                        background: #2563eb;
                    }

                    .teleprompter-btn.coaching {
                        background: #8b5cf6;
                    }

                    .teleprompter-btn.coaching:hover {
                        background: #7c3aed;
                    }

                    .teleprompter-text-container {
                        flex: 1;
                        overflow-y: auto;
                        padding: 40px 80px;
                        scroll-behavior: smooth;
                        line-height: 2.2;
                    }

                    .teleprompter-content {
                        font-size: 28px;
                        line-height: 2.2;
                        text-align: center;
                        max-width: 800px;
                        margin: 0 auto;
                    }

                    .teleprompter-content p {
                        margin: 0 0 40px 0;
                        padding: 0;
                    }

                    .clean-teleprompter-text {
                        display: block;
                        margin: 0 0 40px 0;
                        font-size: 28px;
                        line-height: 2.2;
                    }

                    .teleprompter-status {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 10px 20px;
                        background: rgba(0,0,0,0.8);
                        border-top: 1px solid #333;
                        font-size: 12px;
                        color: #999;
                        flex-shrink: 0;
                    }

                    .empty-teleprompter {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        height: 100vh;
                        color: #666;
                        text-align: center;
                    }

                    /* Coaching hints in teleprompter */
                    .speech-emphasis {
                        background: rgba(220, 38, 38, 0.3);
                        color: #fca5a5;
                        font-weight: bold;
                    }
                    .secondary-emphasis {
                        background: rgba(245, 158, 11, 0.3);
                        color: #fbbf24;
                        font-weight: 600;
                    }
                    .speech-pause {
                        display: inline-block;
                        background: rgba(139, 92, 246, 0.3);
                        color: #c4b5fd;
                        padding: 2px 6px;
                        border-radius: 3px;
                        font-size: 14px;
                        margin: 0 8px;
                    }
                    .humor-block {
                        background: rgba(245, 158, 11, 0.2);
                        border-left: 3px solid #f59e0b;
                        padding: 10px 15px;
                        margin: 20px 0;
                    }
                    .cta-block {
                        background: rgba(16, 185, 129, 0.2);
                        border-left: 3px solid #10b981;
                        padding: 10px 15px;
                        margin: 20px 0;
                        font-weight: 600;
                    }
                `;
                document.head.appendChild(style);
            }

            // Hide sidebar and setup keyboard controls
            document.getElementById('sidebar').style.display = 'none';
            setupTeleprompterKeyboard();
        }

        // BLOCKS VIEW: Shows speech with all content blocks highlighted and categorized
        function renderBlocksView() {
            const container = document.getElementById('speech-container');

            if (!speechData.raw || speechData.raw.trim().length === 0) {
                container.innerHTML = `
                    <div class="blocks-view">
                        <div class="empty-state">
                            <h2>🧩 Content Blocks View</h2>
                            <p>This view will show your speech broken down into different content types:</p>
                            <ul style="text-align: left; display: inline-block;">
                                <li><strong>😄 Humor Blocks:</strong> Jokes and light moments</li>
                                <li><strong>📖 Story Blocks:</strong> Personal anecdotes and examples</li>
                                <li><strong>🎯 Call-to-Action:</strong> Directives for audience action</li>
                                <li><strong>⏸️ Pause Markers:</strong> Timing and emphasis cues</li>
                                <li><strong>💡 Key Words:</strong> Primary and secondary emphasis</li>
                            </ul>
                            <p>Enter your speech content to see the block breakdown!</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Analyze speech for block statistics
            const processedText = formatSpeechText(speechData.raw);
            const humorBlocks = (processedText.match(/humor-block/g) || []).length;
            const storyBlocks = (processedText.match(/story-block/g) || []).length;
            const ctaBlocks = (processedText.match(/cta-block/g) || []).length;
            const pauseBlocks = (processedText.match(/speech-pause/g) || []).length;
            const emphasisWords = (processedText.match(/speech-emphasis/g) || []).length;

            container.innerHTML = `
                <div class="blocks-view">
                    <div class="blocks-header">
                        <h2>🧩 Content Blocks Analysis</h2>
                        <div class="block-stats">
                            <div class="stat-item">😄 ${humorBlocks} Humor</div>
                            <div class="stat-item">📖 ${storyBlocks} Stories</div>
                            <div class="stat-item">🎯 ${ctaBlocks} Call-to-Actions</div>
                            <div class="stat-item">⏸️ ${pauseBlocks} Pauses</div>
                            <div class="stat-item">💡 ${emphasisWords} Key Words</div>
                        </div>
                    </div>

                    <div class="blocks-legend">
                        <div class="legend-section">
                            <h4>Block Types:</h4>
                            <div class="legend-grid">
                                <div class="legend-item"><span style="background:#f59e0b;color:white;padding:3px 8px;border-radius:4px;">😄 HUMOR</span> Jokes & light moments</div>
                                <div class="legend-item"><span style="background:#8b5cf6;color:white;padding:3px 8px;border-radius:4px;">📖 STORY</span> Personal anecdotes</div>
                                <div class="legend-item"><span style="background:#10b981;color:white;padding:3px 8px;border-radius:4px;">🎯 ACTION</span> Calls to action</div>
                                <div class="legend-item"><span style="background:#7c3aed;color:white;padding:3px 8px;border-radius:4px;">⏸️ PAUSE</span> Timing markers</div>
                                <div class="legend-item"><span style="background:#dc2626;color:white;padding:3px 8px;border-radius:4px;">💡 EMPHASIS</span> Key words</div>
                            </div>
                        </div>
                    </div>

                    <div class="blocks-content">
                        <div class="speech-text-blocks">
                            ${processedText}
                        </div>
                    </div>

                    <div class="blocks-tips">
                        <h4>💡 Tips for Using Content Blocks:</h4>
                        <ul>
                            <li><strong>Humor:</strong> Use sparingly (1-2 per speech). Test with friendly audiences first.</li>
                            <li><strong>Stories:</strong> Keep personal, brief (30-60 seconds), and relevant to your message.</li>
                            <li><strong>Call-to-Actions:</strong> Be specific and actionable. One primary CTA per speech.</li>
                            <li><strong>Pauses:</strong> Practice timing. Dramatic pauses should feel slightly uncomfortable.</li>
                            <li><strong>Emphasis:</strong> Don't over-stress. Let natural passion drive key words.</li>
                        </ul>
                    </div>
                </div>
            `;

            // Add CSS for blocks view if not already present
            if (!document.getElementById('blocks-view-styles')) {
                const style = document.createElement('style');
                style.id = 'blocks-view-styles';
                style.textContent = `
                    .blocks-view {
                        padding: 20px;
                        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                    }
                    .blocks-header {
                        text-align: center;
                        margin-bottom: 30px;
                        padding-bottom: 20px;
                        border-bottom: 2px solid #e5e7eb;
                    }
                    .block-stats {
                        display: flex;
                        justify-content: center;
                        gap: 20px;
                        margin-top: 15px;
                        flex-wrap: wrap;
                    }
                    .stat-item {
                        background: #f3f4f6;
                        padding: 8px 16px;
                        border-radius: 8px;
                        font-weight: 600;
                        font-size: 14px;
                        color: #374151;
                    }
                    .blocks-legend {
                        background: #f9fafb;
                        padding: 20px;
                        border-radius: 12px;
                        margin-bottom: 30px;
                    }
                    .legend-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 10px;
                        margin-top: 10px;
                    }
                    .blocks-legend .legend-item {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        font-size: 13px;
                    }
                    .speech-text-blocks {
                        background: white;
                        padding: 30px;
                        border-radius: 12px;
                        border: 1px solid #e5e7eb;
                        font-size: 16px;
                        line-height: 1.8;
                        min-height: 400px;
                    }
                    .blocks-tips {
                        margin-top: 30px;
                        background: #fffbeb;
                        padding: 20px;
                        border-radius: 12px;
                        border: 1px solid #f59e0b;
                    }
                    .blocks-tips h4 {
                        color: #d97706;
                        margin-bottom: 12px;
                    }
                    .blocks-tips ul {
                        margin: 0;
                        padding-left: 20px;
                        color: #92400e;
                    }
                    .blocks-tips li {
                        margin-bottom: 8px;
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // TEXT-TO-SPEECH FUNCTIONALITY
        let speechSynthesis = window.speechSynthesis;
        let currentUtterance = null;
        let isSpeaking = false;
        let speechRate = 1.0; // Normal speed
        let selectedVoice = null;

        function toggleTextToSpeech() {
            const btn = document.getElementById('tts-btn');

            if (isSpeaking) {
                stopTextToSpeech();
            } else {
                startTextToSpeech();
            }
        }

        function startTextToSpeech() {
            if (!speechData.raw) {
                showToast('❌ No speech content to read', 'error');
                return;
            }

            // Stop any existing speech
            speechSynthesis.cancel();

            // Clean text for speech (remove HTML tags and coaching markers)
            let cleanText = speechData.raw;
            cleanText = cleanText.replace(/<[^>]*>/g, ''); // Remove HTML tags
            cleanText = cleanText.replace(/\[.*?\]/g, ''); // Remove [PAUSE] markers
            cleanText = cleanText.replace(/\(.*?\)/g, ''); // Remove (pause) markers
            cleanText = cleanText.replace(/\.\.\./g, '. '); // Replace ... with period
            cleanText = cleanText.replace(/\s+/g, ' '); // Normalize whitespace
            cleanText = cleanText.trim();

            if (!cleanText) {
                showToast('❌ No readable text found', 'error');
                return;
            }

            // Create utterance
            currentUtterance = new SpeechSynthesisUtterance(cleanText);

            // Configure speech settings
            currentUtterance.rate = speechRate;
            currentUtterance.pitch = 1.0;
            currentUtterance.volume = 0.8;

            // Select a professional voice if available
            const voices = speechSynthesis.getVoices();
            const preferredVoices = voices.filter(voice =>
                voice.lang.startsWith('en') &&
                (voice.name.includes('Professional') ||
                 voice.name.includes('Premium') ||
                 voice.name.includes('Enhanced') ||
                 voice.name.includes('Natural') ||
                 voice.name.includes('Google') ||
                 voice.name.includes('Microsoft'))
            );

            if (preferredVoices.length > 0) {
                currentUtterance.voice = preferredVoices[0];
            } else if (voices.length > 0) {
                // Fallback to first English voice
                const englishVoices = voices.filter(voice => voice.lang.startsWith('en'));
                if (englishVoices.length > 0) {
                    currentUtterance.voice = englishVoices[0];
                }
            }

            // Event handlers
            currentUtterance.onstart = () => {
                isSpeaking = true;
                updateTTSButton();
                updateTTSStatus('🔊 Playing speech...');
                showToast('🔊 Speech playback started', 'info');
            };

            currentUtterance.onend = () => {
                isSpeaking = false;
                updateTTSButton();
                updateTTSStatus('');
                showToast('✅ Speech playback completed', 'success');
            };

            currentUtterance.onerror = (event) => {
                isSpeaking = false;
                updateTTSButton();
                updateTTSStatus('❌ Playback error');
                showToast(`❌ Speech error: ${event.error}`, 'error');
            };

            currentUtterance.onpause = () => {
                updateTTSStatus('⏸️ Speech paused');
                showToast('⏸️ Speech paused', 'info');
            };

            currentUtterance.onresume = () => {
                updateTTSStatus('🔊 Playing speech...');
                showToast('▶️ Speech resumed', 'info');
            };

            // Start speaking
            speechSynthesis.speak(currentUtterance);
        }

        function stopTextToSpeech() {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            isSpeaking = false;
            updateTTSButton();
            updateTTSStatus('');
            showToast('⏹️ Speech playback stopped', 'info');
        }

        function updateTTSStatus(message) {
            const statusEl = document.getElementById('tts-status');
            if (statusEl) {
                statusEl.textContent = message;
            }
        }

        function updateTTSButton() {
            const btn = document.getElementById('tts-btn');
            if (btn) {
                if (isSpeaking) {
                    btn.innerHTML = '⏹️ Stop';
                    btn.title = 'Stop text-to-speech playback';
                    btn.style.background = '#dc2626';
                } else {
                    btn.innerHTML = '🔊 Listen';
                    btn.title = 'Play speech with text-to-speech';
                    btn.style.background = '';
                }
            }
        }

        function adjustSpeechRate(change) {
            speechRate = Math.max(0.5, Math.min(2.0, speechRate + change));

            if (isSpeaking && currentUtterance) {
                // Need to restart with new rate
                const wasPlaying = speechSynthesis.speaking;
                speechSynthesis.cancel();

                if (wasPlaying) {
                    setTimeout(() => {
                        startTextToSpeech();
                    }, 100);
                }
            }

            const speedDescription = speechRate < 0.8 ? 'Very Slow' :
                                   speechRate < 1.0 ? 'Slow' :
                                   speechRate > 1.5 ? 'Fast' :
                                   speechRate > 1.2 ? 'Slightly Fast' : 'Normal';

            showToast(`🎙️ Speech rate: ${speedDescription} (${speechRate.toFixed(1)}x)`, 'info');
        }

        // Initialize voices when available
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = () => {
                // Voices are now available
                const voices = speechSynthesis.getVoices();
                console.log('Available voices:', voices.length);
            };
        }

        // Clean teleprompter text without coaching hints
        function getCleanTeleprompterText(text) {
            // Convert to clean paragraphs without emphasis or pause markers
            const paragraphs = text.split(/\n+/).map(p => p.trim()).filter(p => p.length > 0);
            return paragraphs.map(p => `<p class="clean-teleprompter-text">${p}</p>`).join('');
        }

        // TELEPROMPTER CONTROLS: Enhanced scroll management with coaching feedback and keyboard
        let scrollSpeed = 80;  // Start with reasonable speed
        let scrollInterval = null;
        let isScrolling = false;
        let currentScrollPosition = 0;

        function startScroll() {
            const element = document.getElementById('teleprompter-text');
            if (!element) {
                console.error('Teleprompter text element not found');
                showToast('❌ Teleprompter element not found - try switching views', 'error');
                return;
            }

            // If already scrolling, pause instead
            if (isScrolling) {
                pauseScroll();
                return;
            }

            // Clear any existing interval
            if (scrollInterval) clearInterval(scrollInterval);

            isScrolling = true;
            updateScrollButton();

            // Make sure element is scrollable
            const hasScrollContent = element.scrollHeight > element.clientHeight;
            if (!hasScrollContent) {
                showToast('⚠️ No content to scroll - add speech content first', 'warning');
                pauseScroll();
                return;
            }

            scrollInterval = setInterval(() => {
                if (!element) {
                    pauseScroll();
                    return;
                }

                element.scrollTop += 1; // Smooth 1px increments
                currentScrollPosition = element.scrollTop;

                // Check if we've reached the end
                if (element.scrollTop >= (element.scrollHeight - element.clientHeight - 5)) {
                    pauseScroll();
                    showToast('🎯 Speech completed! Great job!', 'success');
                }
            }, scrollSpeed);

            showToast('📺 Teleprompter started - use SPACEBAR to pause/resume!', 'info');
        }

        function pauseScroll() {
            if (scrollInterval) {
                clearInterval(scrollInterval);
                scrollInterval = null;
            }
            isScrolling = false;
            updateScrollButton();

            if (currentScrollPosition > 0) {
                showToast('⏸️ Paused - press SPACEBAR to resume', 'info');
            }
        }

        function resetScroll() {
            pauseScroll();
            const element = document.getElementById('teleprompter-text');
            if (element) {
                element.scrollTop = 0;
                currentScrollPosition = 0;
                showToast('⏮️ Reset to beginning - press SPACEBAR to start', 'info');
            }
        }

        function adjustSpeed(change) {
            // Invert the change logic - lower number = faster scroll
            scrollSpeed = Math.max(20, Math.min(200, scrollSpeed + change));

            const speedDescription = scrollSpeed > 120 ? 'Very Slow' :
                                   scrollSpeed > 80 ? 'Slow' :
                                   scrollSpeed > 50 ? 'Normal' :
                                   scrollSpeed > 30 ? 'Fast' : 'Very Fast';

            // Update speed display
            const speedDisplay = document.getElementById('scroll-speed-display');
            if (speedDisplay) {
                const speedPercent = Math.round(((200 - scrollSpeed) / 180) * 100);
                speedDisplay.textContent = `Speed: ${speedPercent}% (${speedDescription})`;
            }

            showToast(`🎛️ Speed: ${speedDescription}`, 'info');

            // Restart if currently scrolling
            if (isScrolling) {
                pauseScroll();
                setTimeout(startScroll, 100);
            }
        }

        function updateScrollButton() {
            const startBtn = document.getElementById('scroll-toggle-btn');
            if (startBtn) {
                if (isScrolling) {
                    startBtn.innerHTML = '⏸️ Pause (SPACE)';
                    startBtn.classList.add('paused');
                } else {
                    startBtn.innerHTML = '▶️ Start (SPACE)';
                    startBtn.classList.remove('paused');
                }
            }
        }

        // KEYBOARD CONTROLS FOR TELEPROMPTER
        function setupTeleprompterKeyboard() {
            // Remove any existing listeners first
            document.removeEventListener('keydown', teleprompterKeyHandler);

            // Add new listener
            document.addEventListener('keydown', teleprompterKeyHandler);

            // Also ensure the page has focus for keyboard events
            if (document.activeElement && document.activeElement.blur) {
                document.activeElement.blur();
            }

            // Focus the teleprompter container to ensure keyboard events work
            const teleprompterContainer = document.getElementById('teleprompter');
            if (teleprompterContainer) {
                teleprompterContainer.setAttribute('tabindex', '0');
                teleprompterContainer.focus();
            }

            showToast('🎹 Keyboard controls active: SPACE=start/pause, ↑↓=speed, ESC=reset', 'info');
        }

        function teleprompterKeyHandler(event) {
            // Only work in teleprompter mode
            if (currentView !== 'teleprompter') return;

            // Prevent default for our handled keys
            switch(event.code) {
                case 'Space':
                    event.preventDefault();
                    if (isScrolling) {
                        pauseScroll();
                    } else {
                        startScroll();
                    }
                    break;

                case 'ArrowUp':
                    event.preventDefault();
                    adjustSpeed(-20); // Faster (lower interval)
                    break;

                case 'ArrowDown':
                    event.preventDefault();
                    adjustSpeed(20); // Slower (higher interval)
                    break;

                case 'Escape':
                    event.preventDefault();
                    resetScroll();
                    break;
            }
        }

        function analyzeStructure() {
            if (!speechData.raw) {
                alert('Please add speech content first');
                return;
            }

            // NANCY DUARTE STORYTELLING ANALYSIS
            const storyAnalysis = analyzeStoryFramework(speechData.raw);
            const structuralSuggestions = generateStorySuggestions(storyAnalysis);

            // Traditional analysis
            const themes = extractThemes(speechData.raw);
            const tone = analyzeTone(speechData.raw);

            showStoryAnalysis(storyAnalysis, structuralSuggestions, themes, tone);
        }

        // NANCY DUARTE STORYTELLING FRAMEWORK ANALYSIS - Enhanced AI-Driven Version
        function analyzeStoryFramework(text) {
            const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 10);
            const paragraphs = text.split(/\n+/).filter(p => p.trim().length > 20);
            const wordCount = text.split(/\s+/).length;

            // Advanced "What Is" vs "What Could Be" patterns with weight scoring
            const whatIsMarkers = /\b(current|now|today|present|status quo|reality|problem|challenge|struggle|facing|difficult|crisis|issue|broken|existing|as it stands|currently|at present)\b/gi;
            const whatCouldBeMarkers = /\b(future|vision|imagine|tomorrow|could be|should be|will be|transform|change|better|improve|achieve|possibility|potential|dream|goal|opportunity|envision|picture|conceive)\b/gi;
            const newBlissMarkers = /\b(success|victory|triumph|accomplish|together|unite|strong|prosperous|free|hope|bright future|legacy|generations|thriving|flourishing|paradise|utopia|fulfillment)\b/gi;

            // Advanced AI techniques - Sparkline analysis
            const contrastMarkers = /\b(but|however|yet|instead|rather|although|despite|while|whereas|on the other hand|in contrast|different|opposite)\b/gi;
            const bridgeMarkers = /\b(therefore|thus|so|hence|consequently|as a result|this means|which leads to|enabling|allowing)\b/gi;

            const whatIsMatches = (text.match(whatIsMarkers) || []).length;
            const whatCouldBeMatches = (text.match(whatCouldBeMarkers) || []).length;
            const newBlissMatches = (text.match(newBlissMarkers) || []).length;
            const contrastMatches = (text.match(contrastMarkers) || []).length;
            const bridgeMatches = (text.match(bridgeMarkers) || []).length;

            // Advanced AI: Sparkline Analysis (oscillation between What Is/What Could Be)
            const sparklinePattern = analyzeSparkline(text);

            // Enhanced story structure with AI insights
            const hasOpeningHook = /^.{1,200}\b(imagine|what if|picture this|fellow|friends|today|moment|story|journey|let me tell you|once upon|there was a time)\b/i.test(text);
            const hasCallToAction = /\b(act|action|vote|support|join|together|must|will|fight|stand|move forward|take action|call upon|urge|demand|it's time|now is|step up)\b/gi.test(text);
            const hasEmotionalElements = /\b(heart|feel|emotion|passion|love|hope|fear|anger|joy|pride|family|children|home|mother|father|parent|dream|tears|laughter|smile)\b/gi.test(text);

            // Advanced tension and release with weighted scoring
            const tensionWords = (text.match(/\b(but|however|yet|although|despite|challenge|problem|crisis|danger|threat|struggle|difficulty|obstacle|unfortunately|sadly|tragically)\b/gi) || []).length;
            const releaseWords = (text.match(/\b(solution|answer|way forward|overcome|triumph|victory|success|together|unite|resolve|achieve|breakthrough|salvation|hope)\b/gi) || []).length;

            // Hero's journey elements (audience as hero) - Enhanced AI version
            const heroJourneyMarkers = /\b(you|your|we|our|us|together|community|people|citizens|americans|nation|humanity|everyone|each of us|all of us)\b/gi;
            const heroJourneyMatches = (text.match(heroJourneyMarkers) || []).length;

            // Advanced AI: Persuasion techniques detection
            const persuasionTechniques = analyzePersuasionTechniques(text);

            // Advanced AI: Narrative momentum analysis
            const narrativeMomentum = analyzeNarrativeMomentum(sentences);

            // Advanced AI: Audience engagement predictors
            const engagementScore = calculateEngagementScore(text, wordCount);

            return {
                whatIsScore: whatIsMatches,
                whatCouldBeScore: whatCouldBeMatches,
                newBlissScore: newBlissMatches,
                contrastScore: contrastMatches,
                bridgeScore: bridgeMatches,
                hasOpeningHook,
                hasCallToAction,
                hasEmotionalElements,
                tensionReleaseRatio: tensionWords > 0 ? releaseWords / tensionWords : 0,
                paragraphCount: paragraphs.length,
                averageParagraphLength: paragraphs.reduce((a, p) => a + p.length, 0) / paragraphs.length,
                heroJourneyScore: heroJourneyMatches,
                sparklinePattern,
                persuasionTechniques,
                narrativeMomentum,
                engagementScore,
                storyStructureScore: (hasOpeningHook ? 20 : 0) + (hasCallToAction ? 20 : 0) + (hasEmotionalElements ? 20 : 0) + (Math.min(whatCouldBeMatches / Math.max(whatIsMatches, 1) * 20, 20)) + (engagementScore * 0.2)
            };
        }

        // ADVANCED AI ANALYSIS FUNCTIONS - Story Method Enhanced

        function analyzeSparkline(text) {
            // Story "sparkline" - the oscillation between What Is and What Could Be
            const paragraphs = text.split(/\n+/).filter(p => p.trim().length > 20);
            const sparkline = [];

            paragraphs.forEach((para, index) => {
                const whatIsCount = (para.match(/\b(current|now|today|problem|challenge|crisis|struggle|difficulty)\b/gi) || []).length;
                const whatCouldBeCount = (para.match(/\b(future|vision|imagine|transform|better|achieve|dream|opportunity)\b/gi) || []).length;

                let sentiment = 0; // neutral
                if (whatCouldBeCount > whatIsCount) sentiment = 1; // positive/aspirational
                if (whatIsCount > whatCouldBeCount) sentiment = -1; // negative/problematic

                sparkline.push(sentiment);
            });

            // Calculate sparkline health - good presentations oscillate
            const oscillations = sparkline.filter((val, i) => i > 0 && val !== sparkline[i-1]).length;
            const sparklineHealth = oscillations / Math.max(sparkline.length - 1, 1);

            return {
                pattern: sparkline,
                oscillations,
                health: sparklineHealth,
                recommendation: sparklineHealth > 0.3 ? "Good tension/release pattern" : "Add more contrast between problems and solutions"
            };
        }

        function analyzePersuasionTechniques(text) {
            const techniques = {
                repetition: (text.match(/\b(\w+)\b.*?\b\1\b/gi) || []).length,
                triads: (text.match(/\b\w+,\s*\w+,\s*(and\s+)?\w+\b/gi) || []).length,
                metaphors: (text.match(/\b(like|as|is like|metaphor|symbol)\b/gi) || []).length,
                questions: (text.match(/\?/g) || []).length,
                personalPronouns: (text.match(/\b(I|you|we|us|our|your)\b/gi) || []).length,
                powerWords: (text.match(/\b(because|proven|results|guaranteed|instant|amazing|breakthrough|revolutionary)\b/gi) || []).length
            };

            const totalScore = Object.values(techniques).reduce((a, b) => a + b, 0);
            return { ...techniques, totalScore };
        }

        function analyzeNarrativeMomentum(sentences) {
            // Analyze sentence length progression for momentum
            const lengths = sentences.map(s => s.trim().length);
            const avgLength = lengths.reduce((a, b) => a + b, 0) / lengths.length;

            let momentum = 0;
            for (let i = 1; i < lengths.length; i++) {
                if (lengths[i] > lengths[i-1]) momentum += 1;
                if (lengths[i] < lengths[i-1]) momentum -= 0.5;
            }

            return {
                averageSentenceLength: Math.round(avgLength),
                momentum: momentum / lengths.length,
                recommendation: momentum > 0.1 ? "Good narrative build" : "Consider varying sentence length for better flow"
            };
        }

        function calculateEngagementScore(text, wordCount) {
            // AI-driven engagement prediction based on storytelling research
            let score = 0;

            // Readability factors
            const avgWordsPerSentence = wordCount / (text.split(/[.!?]+/).length - 1);
            if (avgWordsPerSentence > 10 && avgWordsPerSentence < 20) score += 20;

            // Emotional language
            const emotionalWords = (text.match(/\b(love|hate|fear|hope|angry|happy|excited|worried|proud|grateful)\b/gi) || []).length;
            score += Math.min(emotionalWords * 2, 30);

            // Questions and direct address
            const questions = (text.match(/\?/g) || []).length;
            const directAddress = (text.match(/\byou\b/gi) || []).length;
            score += Math.min(questions * 5 + directAddress * 2, 25);

            // Concrete vs abstract language
            const concreteWords = (text.match(/\b(see|hear|feel|touch|taste|red|blue|hot|cold|loud|soft)\b/gi) || []).length;
            score += Math.min(concreteWords * 1, 25);

            return Math.min(score, 100);
        }

        function generateStorySuggestions(analysis) {
            const suggestions = [];

            // Story Structure Recommendations
            if (analysis.storyStructureScore < 50) {
                suggestions.push("📚 STORY STRUCTURE: Your speech needs stronger narrative elements. Consider the 3-act structure: What Is → What Could Be → New Bliss.");
            }

            // What Is vs What Could Be Balance
            if (analysis.whatIsScore === 0) {
                suggestions.push("🎯 WHAT IS: Establish current reality first. Help audience understand where we are now with phrases like 'Today we face...' or 'The current challenge is...'");
            }

            if (analysis.whatCouldBeScore === 0) {
                suggestions.push("🌟 WHAT COULD BE: Paint a vision of transformation. Use phrases like 'Imagine a future where...' or 'We could achieve...'");
            }

            if (analysis.whatIsScore > analysis.whatCouldBeScore * 2) {
                suggestions.push("⚖️ BALANCE: Too much focus on current problems. Add more inspiring vision of 'What Could Be'. Spend equal time painting the positive future.");
            }

            if (analysis.whatCouldBeScore > analysis.whatIsScore * 3) {
                suggestions.push("🔧 GROUNDING: Add more acknowledgment of current reality to make your vision credible. Start with shared understanding of today's challenges.");
            }

            // New Bliss Analysis
            if (analysis.newBlissScore < 2) {
                suggestions.push("🎉 NEW BLISS: End with a compelling vision of transformation. Show the audience their better future state with words like 'together', 'success', 'thriving'.");
            }

            // Opening Hook
            if (!analysis.hasOpeningHook) {
                suggestions.push("🎣 OPENING HOOK: Start with 'Imagine...', 'What if...', 'Picture this...', or a compelling story to immediately grab attention.");
            }

            // Call to Action
            if (!analysis.hasCallToAction) {
                suggestions.push("📢 CALL TO ACTION: Include clear next steps. What specific action do you want the audience to take? Use action words like 'vote', 'support', 'join', 'act'.");
            }

            // Emotional Connection
            if (!analysis.hasEmotionalElements) {
                suggestions.push("❤️ EMOTIONAL CONNECTION: Add personal stories, family references, or emotional appeals. Connect to hearts, not just minds.");
            }

            // Tension and Release
            if (analysis.tensionReleaseRatio < 0.5) {
                suggestions.push("🎭 TENSION & RELEASE: For every problem you raise, provide a solution or path forward. Balance creates engagement and hope.");
            }

            // Hero's Journey (Audience as Hero)
            if (analysis.heroJourneyScore < text.length / 20) {
                suggestions.push("🦸 AUDIENCE AS HERO: Make the audience the hero of your story. Use 'you', 'we', 'our' more often. They should be the protagonists of change.");
            }

            // Paragraph Structure
            if (analysis.averageParagraphLength > 200) {
                suggestions.push("📝 PARAGRAPH LENGTH: Break up long sections for better pacing and emphasis. Shorter paragraphs create more impact.");
            }

            if (suggestions.length === 0) {
                suggestions.push("🏆 EXCELLENT: Your speech follows strong storytelling principles! You've created a compelling narrative arc.");
            }

            return suggestions;
        }

        function showStoryAnalysis(analysis, suggestions, themes, tone) {
            const modal = document.createElement('div');
            modal.className = 'story-modal';
            modal.innerHTML = `
                <div class="story-modal-content">
                    <div class="story-header">
                        <h2>📊 Story Structure Analysis</h2>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="close-btn">✕</button>
                    </div>

                    <div class="story-score-section">
                        <h3>Story Structure Score: ${Math.round(analysis.storyStructureScore)}/100</h3>
                        <div class="score-bar">
                            <div class="score-fill" style="width: ${analysis.storyStructureScore}%"></div>
                        </div>
                    </div>

                    <div class="story-framework">
                        <h3>🎭 Story Framework Analysis</h3>
                        <div class="framework-grid">
                            <div class="framework-item">
                                <h4>What Is (Current Reality)</h4>
                                <div class="count">${analysis.whatIsScore}</div>
                                <p>References to current state, problems, challenges</p>
                            </div>
                            <div class="framework-item">
                                <h4>What Could Be (Vision)</h4>
                                <div class="count">${analysis.whatCouldBeScore}</div>
                                <p>References to future possibilities, transformation</p>
                            </div>
                            <div class="framework-item">
                                <h4>New Bliss (Outcome)</h4>
                                <div class="count">${analysis.newBlissScore}</div>
                                <p>References to success, unity, bright future</p>
                            </div>
                        </div>
                    </div>

                    <div class="story-elements">
                        <h3>🎯 Story Elements</h3>
                        <div class="element-checks">
                            <div class="check-item ${analysis.hasOpeningHook ? 'present' : 'missing'}">
                                ${analysis.hasOpeningHook ? '✅' : '❌'} Opening Hook
                            </div>
                            <div class="check-item ${analysis.hasCallToAction ? 'present' : 'missing'}">
                                ${analysis.hasCallToAction ? '✅' : '❌'} Call to Action
                            </div>
                            <div class="check-item ${analysis.hasEmotionalElements ? 'present' : 'missing'}">
                                ${analysis.hasEmotionalElements ? '✅' : '❌'} Emotional Connection
                            </div>
                            <div class="check-item ${analysis.tensionReleaseRatio >= 0.5 ? 'present' : 'missing'}">
                                ${analysis.tensionReleaseRatio >= 0.5 ? '✅' : '❌'} Tension & Release Balance
                            </div>
                        </div>
                    </div>

                    <div class="story-suggestions">
                        <h3>📝 Story-Based Recommendations</h3>
                        <ul>
                            ${suggestions.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                    </div>

                    <div class="traditional-analysis">
                        <h3>📈 Additional Analysis</h3>
                        <p><strong>Themes:</strong> ${themes.join(', ')}</p>
                        <p><strong>Tone:</strong> ${tone}</p>
                        <p><strong>Structure:</strong> ${speechData.sections.map(s => s.title).join(' → ')}</p>
                        <p><strong>Paragraphs:</strong> ${analysis.paragraphCount}</p>
                        <p><strong>Hero Journey References:</strong> ${analysis.heroJourneyScore}</p>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function extractThemes(text) {
            const themes = [];
            const lower = text.toLowerCase();

            if (lower.includes('healthcare') || lower.includes('health')) themes.push('Healthcare');
            if (lower.includes('education') || lower.includes('school')) themes.push('Education');
            if (lower.includes('economy') || lower.includes('jobs')) themes.push('Economy');
            if (lower.includes('climate') || lower.includes('environment')) themes.push('Environment');
            if (lower.includes('justice') || lower.includes('equality')) themes.push('Social Justice');
            if (lower.includes('community') || lower.includes('together')) themes.push('Community');

            return themes.length > 0 ? themes : ['General'];
        }

        function analyzeTone(text) {
            const lower = text.toLowerCase();

            if (lower.includes('fight') || lower.includes('must') || lower.includes('demand')) {
                return 'Assertive & Motivational';
            } else if (lower.includes('thank') || lower.includes('grateful') || lower.includes('appreciate')) {
                return 'Grateful & Appreciative';
            } else if (lower.includes('hope') || lower.includes('dream') || lower.includes('vision')) {
                return 'Hopeful & Visionary';
            } else {
                return 'Informative & Professional';
            }
        }

        function generateSuggestions(data) {
            const suggestions = [];

            if (data.duration > 10) {
                suggestions.push('• Consider breaking into smaller segments for better pacing');
            }

            if (!data.sections.find(s => s.type === 'story')) {
                suggestions.push('• Add a personal story to connect with audience');
            }

            if (!data.sections.find(s => s.type === 'callout')) {
                suggestions.push('• Include a clear call to action');
            }

            if (data.wordCount < 500) {
                suggestions.push('• Expand key points for more depth');
            }

            return suggestions.length > 0 ? suggestions : ['• Speech structure looks good!'];
        }

        function newSpeech() {
            // Check if there's current work to save
            if (speechData.raw && speechData.raw.trim()) {
                const currentId = localStorage.getItem('currentSpeechId');
                const hasUnsavedChanges = !currentId || needsSaving();

                if (hasUnsavedChanges) {
                    const choice = confirm('You have unsaved changes. Would you like to save your current speech before starting a new one?\n\nClick OK to save first, or Cancel to start fresh without saving.');

                    if (choice) {
                        // Save first, then create new
                        saveSpeech();
                        setTimeout(createNewSpeechAfterSave, 1000);
                        return;
                    }
                }
            }

            createNewSpeechAfterSave();
        }

        function createNewSpeechAfterSave() {
            // Clear all data
            speechData = {
                raw: '',
                sections: [],
                wordCount: 0,
                duration: 0,
                analysis: null
            };

            // Clear localStorage
            localStorage.removeItem('speechDraft');
            localStorage.removeItem('currentSpeechId');

            // Clear the main input field
            const speechInput = document.getElementById('speech-input');
            if (speechInput) {
                speechInput.value = '';
                speechInput.focus();
            }

            // Clear all view inputs
            const inputs = ['printout-input', 'structure-input', 'flow-input'];
            inputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) input.value = '';
            });

            // Reset UI elements
            updateStats();
            resetAllAnalysis();

            // Switch to first view and show paste prompt
            switchView('printout');

            // Show toast notification
            showToast('🗒️ Ready for new speech! Paste your content to get started.', 'success');
        }

        function needsSaving() {
            const currentId = localStorage.getItem('currentSpeechId');
            if (!currentId) return true;

            const speechLibrary = JSON.parse(localStorage.getItem('speechLibrary') || '[]');
            const savedSpeech = speechLibrary.find(s => s.id === currentId);

            if (!savedSpeech) return true;

            // Compare current content with saved content
            return savedSpeech.content !== speechData.raw;
        }

        function saveSpeech() {
            if (!speechData.raw || !speechData.raw.trim()) {
                showToast('⚠️ No content to save. Please add speech content first.', 'warning');
                return;
            }

            const currentId = localStorage.getItem('currentSpeechId');
            const isUpdate = currentId && currentId !== 'null';

            const title = prompt(
                isUpdate ? 'Update speech title:' : 'Enter a title for your speech:',
                isUpdate ? getCurrentSpeechTitle() : generateAutoTitle()
            );

            if (!title) return;

            const speechLibrary = JSON.parse(localStorage.getItem('speechLibrary') || '[]');

            // Make sure metadata is up to date
            updateMetadata();

            const speechEntry = {
                id: isUpdate ? currentId : Date.now().toString(),
                title: title,
                content: speechData.raw,
                preview: speechData.raw.substring(0, 150) + (speechData.raw.length > 150 ? '...' : ''),
                wordCount: speechData.wordCount,
                createdAt: isUpdate ? getCurrentSpeechCreatedDate() : new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                status: 'draft',
                sections: speechData.sections.length,
                duration: speechData.duration,
                // Include structured metadata
                description: speechData.description,
                dateline: speechData.dateline,
                speaker: speechData.speaker,
                source: speechData.source
            };

            if (isUpdate) {
                const index = speechLibrary.findIndex(s => s.id === currentId);
                if (index !== -1) {
                    speechLibrary[index] = speechEntry;
                    showToast('💾 Speech updated successfully!', 'success');
                }
            } else {
                speechLibrary.unshift(speechEntry);
                localStorage.setItem('currentSpeechId', speechEntry.id);
                showToast('💾 Speech saved successfully!', 'success');
            }

            localStorage.setItem('speechLibrary', JSON.stringify(speechLibrary));
        }

        function getCurrentSpeechTitle() {
            const currentId = localStorage.getItem('currentSpeechId');
            if (!currentId) return '';

            const speechLibrary = JSON.parse(localStorage.getItem('speechLibrary') || '[]');
            const speech = speechLibrary.find(s => s.id === currentId);
            return speech ? speech.title : '';
        }

        function getCurrentSpeechCreatedDate() {
            const currentId = localStorage.getItem('currentSpeechId');
            if (!currentId) return new Date().toISOString();

            const speechLibrary = JSON.parse(localStorage.getItem('speechLibrary') || '[]');
            const speech = speechLibrary.find(s => s.id === currentId);
            return speech ? speech.createdAt : new Date().toISOString();
        }

        function generateAutoTitle() {
            if (!speechData.raw) return 'Untitled Speech';

            const lines = speechData.raw.split('\n');
            const firstLine = lines.find(line => line.trim().length > 10);

            if (firstLine) {
                let title = firstLine.trim();
                // Remove common speech prefixes
                title = title.replace(/^(my fellow|dear|hello|good morning|good evening|ladies and gentlemen)/i, '').trim();
                // Limit length
                if (title.length > 50) {
                    title = title.substring(0, 47) + '...';
                }
                return title || 'Untitled Speech';
            }

            return 'Untitled Speech';
        }

        function openDashboard() {
            // Save current work before leaving
            if (speechData.raw && speechData.raw.trim()) {
                localStorage.setItem('speechDraft', speechData.raw);
            }

            window.open('writers-dashboard.html', '_blank');
        }

        function resetAllAnalysis() {
            // Reset analysis display values
            document.getElementById('sparkline-score').textContent = '-';
            document.getElementById('what-is-count').textContent = '0';
            document.getElementById('what-could-be-count').textContent = '0';
            document.getElementById('contrast-ratio').textContent = '-';

            // Clear sections list
            const sectionsList = document.getElementById('section-list');
            if (sectionsList) {
                sectionsList.innerHTML = '';
            }

            // Clear sparkline visual
            const sparklineVisual = document.getElementById('sparkline-visual');
            if (sparklineVisual) {
                sparklineVisual.innerHTML = '';
            }

            // Reset workflow steps
            const workflowSteps = document.querySelectorAll('.workflow-step .step-status');
            workflowSteps.forEach(status => {
                status.textContent = '◯';
                status.classList.remove('completed');
            });
        }

        function exportSpeech() {
            const formats = ['Plain Text', 'Formatted HTML', 'Teleprompter', 'Speaker Notes', 'LD-JSON for Website'];
            const choice = prompt('Export format:\n1. Plain Text\n2. Formatted HTML\n3. Teleprompter\n4. Speaker Notes\n5. LD-JSON for Website\n\nEnter number:');

            if (!choice || !speechData.raw) return;

            let content = '';
            let filename = 'speech';

            switch(choice) {
                case '1':
                    const header = generateSpeechHeader('text');
                    content = header + speechData.raw;
                    filename += '.txt';
                    break;
                case '2':
                    content = generateHTML();
                    filename += '.html';
                    break;
                case '3':
                    content = generateTeleprompter();
                    filename += '-teleprompter.html';
                    break;
                case '4':
                    content = generateSpeakerNotes();
                    filename += '-notes.txt';
                    break;
                case '5':
                    content = generateLDJSON();
                    filename = 'speech-schema.json';
                    break;
            }

            downloadFile(content, filename);
        }

        // LD-JSON GENERATOR FOR WEBSITE PUBLISHING
        function generateLDJSON() {
            const speechTitle = extractSpeechTitle(speechData.raw);
            const speechDate = new Date().toISOString().split('T')[0];
            const themes = extractThemes(speechData.raw);
            const storyAnalysis = analyzeStoryFramework(speechData.raw);

            const ldJson = {
                "@context": "https://schema.org",
                "@type": "SpeechEvent",
                "name": speechTitle,
                "description": `Political speech focusing on ${themes.join(', ')}`,
                "startDate": speechDate,
                "endDate": speechDate,
                "eventStatus": "https://schema.org/EventScheduled",
                "eventAttendanceMode": "https://schema.org/OfflineEventAttendanceMode",
                "location": {
                    "@type": "Place",
                    "name": "Campaign Event Location",
                    "address": {
                        "@type": "PostalAddress",
                        "addressCountry": "US"
                    }
                },
                "organizer": {
                    "@type": "Person",
                    "name": "Campaign Candidate",
                    "@id": "#candidate"
                },
                "performer": {
                    "@type": "Person",
                    "name": "Campaign Candidate",
                    "@id": "#candidate"
                },
                "audience": {
                    "@type": "Audience",
                    "audienceType": "voters, supporters, community members"
                },
                "about": themes.map(theme => ({
                    "@type": "Thing",
                    "name": theme
                })),
                "text": speechData.raw,
                "transcript": {
                    "@type": "MediaObject",
                    "contentUrl": "#speech-transcript",
                    "encodingFormat": "text/plain",
                    "description": "Full transcript of the political speech"
                },
                "keywords": themes.join(', '),
                "inLanguage": "en-US",
                "genre": "Political Speech",
                "educationalLevel": "General Public",
                "learningResourceType": "Speech",
                "copyrightHolder": {
                    "@type": "Organization",
                    "name": "Campaign Organization"
                },
                "datePublished": speechDate,
                "dateModified": new Date().toISOString(),
                "publisher": {
                    "@type": "Organization",
                    "name": "Campaign Website",
                    "url": window.location.origin
                },
                "mainEntity": {
                    "@type": "Article",
                    "headline": speechTitle,
                    "articleBody": speechData.raw,
                    "author": {
                        "@type": "Person",
                        "name": "Campaign Candidate"
                    },
                    "datePublished": speechDate,
                    "publisher": {
                        "@type": "Organization",
                        "name": "Campaign Website"
                    }
                },
                "workExample": {
                    "@type": "CreativeWork",
                    "name": "Speech Analysis",
                    "description": "Story Framework Analysis Results",
                    "about": {
                        "storyStructureScore": storyAnalysis.storyStructureScore,
                        "whatIsScore": storyAnalysis.whatIsScore,
                        "whatCouldBeScore": storyAnalysis.whatCouldBeScore,
                        "newBlissScore": storyAnalysis.newBlissScore,
                        "hasOpeningHook": storyAnalysis.hasOpeningHook,
                        "hasCallToAction": storyAnalysis.hasCallToAction,
                        "hasEmotionalElements": storyAnalysis.hasEmotionalElements
                    }
                }
            };

            return JSON.stringify(ldJson, null, 2);
        }

        function extractSpeechTitle(text) {
            // Try to find a title in the first 200 characters
            const firstLine = text.split('\n')[0];
            if (firstLine.length < 100) {
                return firstLine.trim();
            }

            // Look for common speech openings
            const titleMatch = text.match(/^(.*?(?:speech|address|remarks|statement).*?)[\.\n]/i);
            if (titleMatch) {
                return titleMatch[1].trim();
            }

            // Extract from common political phrases
            const politicalMatch = text.match(/^(.*?(?:america|nation|future|together|change).*?)[\.\n]/i);
            if (politicalMatch && politicalMatch[1].length < 100) {
                return politicalMatch[1].trim();
            }

            // Default fallback
            return `Political Speech - ${new Date().toLocaleDateString()}`;
        }

        // Generate header with speaker/event information
        function generateSpeechHeader(format = 'text') {
            const speechTitle = extractSpeechTitle(speechData.raw) || 'Campaign Speech';
            const currentDate = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const currentTime = new Date().toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });

            // Extract location from speech content or use default
            const locationMatch = speechData.raw.match(/\b([A-Z][A-Z\s,]+(?:NY|CA|TX|FL|IL|PA|OH|GA|NC|MI|NJ|VA|WA|MA|IN|AZ|TN|MO|MD|WI|CO|MN|SC|AL|LA|KY|OR|OK|CT|IA|MS|AR|KS|UT|NV|NM|WV|NE|ID|HI|NH|ME|RI|MT|DE|SD|ND|AK|DC|VT|WY))\b/);
            const location = locationMatch ? locationMatch[0] : 'Location TBD';

            if (format === 'html') {
                return `
<div style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 40px;">
    <h1 style="margin: 0; font-size: 24px; color: #333;">${speechTitle}</h1>
    <h2 style="margin: 10px 0; font-size: 18px; color: #666; font-weight: normal;">OFFICIAL TRANSCRIPT</h2>
    <div style="margin-top: 15px; font-size: 14px; color: #555;">
        <p style="margin: 5px 0;"><strong>Speaker:</strong> [CANDIDATE NAME]</p>
        <p style="margin: 5px 0;"><strong>Date:</strong> ${currentDate}</p>
        <p style="margin: 5px 0;"><strong>Time:</strong> ${currentTime}</p>
        <p style="margin: 5px 0;"><strong>Location:</strong> ${location}</p>
    </div>
</div>`;
            } else {
                return `${speechTitle}
OFFICIAL TRANSCRIPT

Speaker: [CANDIDATE NAME]
Date: ${currentDate}
Time: ${currentTime}
Location: ${location}

${'='.repeat(60)}

`;
            }
        }

        function generateHTML() {
            const header = generateSpeechHeader('html');
            return `<!DOCTYPE html>
<html><head><title>Speech Transcript</title></head>
<body style="max-width: 800px; margin: 0 auto; padding: 40px; font-family: Georgia, serif; line-height: 1.8;">
${header}
${speechData.sections.map(s => `
    <div style="margin-bottom: 30px;">
        <h3>${s.title}</h3>
        ${formatSpeechText(s.content)}
    </div>
`).join('')}
</body></html>`;
        }

        function generateTeleprompter() {
            const header = generateSpeechHeader('html').replace(/style="[^"]*"/g, 'style="color: white; text-align: center;"');
            return `<!DOCTYPE html>
<html><head><title>Teleprompter</title></head>
<body style="background: black; color: white; font-size: 48px; line-height: 1.5; padding: 40px; text-align: center;">
<div style="font-size: 24px; margin-bottom: 60px; border-bottom: 2px solid white; padding-bottom: 30px;">
${header}
</div>
${speechData.raw.split(/\n+/).map(p => `<p>${p}</p>`).join('')}
</body></html>`;
        }

        function generateSpeakerNotes() {
            const header = generateSpeechHeader('text');
            const notes = speechData.sections.map(s =>
                `[${s.title}] (${Math.ceil(s.wordCount / 150)} min)\n${'-'.repeat(40)}\n${s.content}\n\n`
            ).join('');
            return header + notes;
        }

        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // SPEECH COACHING FUNCTIONS
        let speechHintsEnabled = true; // Default to showing hints

        function toggleCoachingTips() {
            speechHintsEnabled = !speechHintsEnabled;
            const btn = document.querySelector('.teleprompter-btn.coaching');

            if (speechHintsEnabled) {
                btn.innerHTML = '💡 Hide Hints';
                btn.title = 'Hide speech coaching hints (emphasis, pauses)';
                showToast('🎯 Speech hints enabled - emphasis and pauses visible', 'info');
            } else {
                btn.innerHTML = '👁️ Show Hints';
                btn.title = 'Show speech coaching hints (emphasis, pauses)';
                showToast('📝 Speech hints disabled - clean text only', 'info');
            }

            // Re-render teleprompter if we're currently in that view
            if (currentView === 'teleprompter') {
                renderTeleprompterView();
            }
        }

        // FUTURE: Speech pattern capture module will go here
        function initializePatternCapture() {
            // This function will be implemented later to:
            // 1. Record microphone input during speech delivery
            // 2. Analyze actual emphasis patterns vs. intended emphasis
            // 3. Detect pause timing and duration
            // 4. Provide feedback on delivery consistency
            // 5. Generate personalized coaching recommendations
            console.log('Pattern capture module placeholder - future implementation');
        }

        // WordPress View Functions
        function setupWordPressListeners() {
            // Add listeners for WordPress section content editing
            document.querySelectorAll('.wp-section-content').forEach((element, index) => {
                element.addEventListener('input', (e) => {
                    // Update the section in our data
                    const sectionIndex = parseInt(e.target.dataset.sectionIndex);
                    if (speechData.sections[sectionIndex]) {
                        speechData.sections[sectionIndex].content = e.target.textContent;
                    }
                    // Sync to other views
                    syncToAllViews();
                });
            });
        }

        function copySection(index) {
            const section = document.querySelector(`[data-section="${index}"] .wp-section-content`);
            if (section) {
                const content = section.textContent;
                navigator.clipboard.writeText(content).then(() => {
                    showToast(`📋 Section ${index + 1} copied to clipboard`, 'success');
                }).catch(err => {
                    showToast('❌ Failed to copy to clipboard', 'error');
                });
            }
        }

        function deleteSection(index) {
            if (confirm('Are you sure you want to delete this section?')) {
                const sectionElement = document.querySelector(`[data-section="${index}"]`);
                if (sectionElement) {
                    sectionElement.remove();
                    // Remove from data
                    if (speechData.sections[index]) {
                        speechData.sections.splice(index, 1);
                    }
                    // Re-render the WordPress view to update indices
                    renderWordPressView();
                    syncToAllViews();
                    showToast('🗑️ Section deleted', 'success');
                }
            }
        }

        function addNewSection() {
            const newSection = {
                type: 'Paragraph',
                content: 'Enter your new content here...'
            };
            speechData.sections.push(newSection);
            renderWordPressView();
            showToast('➕ New section added', 'success');
        }

        function exportWordPress() {
            const sections = [];
            document.querySelectorAll('.wp-section-content').forEach((element, index) => {
                const type = document.querySelector(`[data-section="${index}"] .wp-section-type`).textContent;
                const content = element.textContent;
                sections.push(`<!-- wp:paragraph -->\n<p><strong>[${type}]</strong></p>\n<!-- /wp:paragraph -->\n\n<!-- wp:paragraph -->\n<p>${content}</p>\n<!-- /wp:paragraph -->`);
            });

            const wpContent = sections.join('\n\n');
            navigator.clipboard.writeText(wpContent).then(() => {
                showToast('📋 WordPress blocks copied to clipboard', 'success');
            }).catch(err => {
                // Fallback: show content in a dialog for manual copying
                const dialog = document.createElement('div');
                dialog.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                        <div style="background: white; padding: 20px; border-radius: 8px; max-width: 80%; max-height: 80%; overflow-y: auto;">
                            <h3>WordPress Content Blocks</h3>
                            <p>Copy the content below:</p>
                            <textarea style="width: 100%; height: 300px; font-family: monospace; font-size: 12px;">${wpContent}</textarea>
                            <button onclick="this.closest('div').parentElement.remove()" style="margin-top: 10px; padding: 8px 16px;">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(dialog);
            });
        }

        // Synchronization Functions
        function syncToAllViews() {
            // Update the raw text from sections
            speechData.raw = speechData.sections.map(section => section.content).join('\n\n');

            // Update the speech input textarea
            const speechInput = document.getElementById('speech-input');
            if (speechInput) {
                speechInput.value = speechData.raw;
            }

            // Re-render current view if it's not the one being edited
            if (currentView === 'printout') {
                renderPrintoutView();
            } else if (currentView === 'structure') {
                renderStructureView();
            } else if (currentView === 'teleprompter') {
                renderTeleprompterView();
            }

            // Update stats
            updateStats(speechData.raw);

            // Save to localStorage
            localStorage.setItem('speechDraft', speechData.raw);
        }

        function renderPrintoutView() {
            const container = document.getElementById('content-area');
            container.innerHTML = `
                <div class="printout-view">
                    <div class="speech-header">
                        <h1 class="speech-title" contenteditable="true" placeholder="Speech Title">Speech Draft</h1>
                        <div class="speech-meta">
                            <div class="meta-item">
                                <strong>Date:</strong> <span contenteditable="true" class="meta-date">${new Date().toLocaleDateString()}</span>
                            </div>
                            <div class="meta-item">
                                <strong>Duration:</strong> <span class="meta-duration">${speechData.duration} minutes</span>
                            </div>
                            <div class="meta-item">
                                <strong>Words:</strong> <span class="meta-words">${speechData.wordCount}</span>
                            </div>
                        </div>
                    </div>
                    <div class="speech-content" contenteditable="true">
                        ${speechData.raw.split('\n\n').map(para => `<p>${para}</p>`).join('')}
                    </div>
                    <div class="printout-actions">
                        <button class="btn" onclick="window.print()">🖨️ Print</button>
                        <button class="btn" onclick="exportPDF()">📄 Export PDF</button>
                    </div>
                </div>
            `;
            setupPrintoutListeners();
        }

        function setupPrintoutListeners() {
            const contentArea = document.querySelector('.speech-content');
            if (contentArea) {
                contentArea.addEventListener('input', (e) => {
                    // Update speech data from printout content
                    speechData.raw = contentArea.textContent;
                    // Parse back into sections
                    parseSpeechStructure(speechData.raw);
                    syncToAllViews();
                });
            }

            const titleArea = document.querySelector('.speech-title');
            if (titleArea) {
                titleArea.addEventListener('input', (e) => {
                    // Store title separately if needed
                    localStorage.setItem('speechTitle', titleArea.textContent);
                });
            }
        }

        function exportPDF() {
            // Simple PDF export using print functionality
            const printCSS = `
                @media print {
                    body * { visibility: hidden; }
                    .printout-view, .printout-view * { visibility: visible; }
                    .printout-actions { display: none !important; }
                    .speech-content { font-size: 14pt; line-height: 1.6; }
                }
            `;
            const style = document.createElement('style');
            style.textContent = printCSS;
            document.head.appendChild(style);

            window.print();

            setTimeout(() => {
                document.head.removeChild(style);
            }, 1000);
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 6px;
                color: white;
                font-weight: 500;
                z-index: 9999;
                animation: slideInRight 0.3s ease;
                max-width: 300px;
            `;

            switch(type) {
                case 'success':
                    toast.style.backgroundColor = '#10b981';
                    break;
                case 'error':
                    toast.style.backgroundColor = '#ef4444';
                    break;
                case 'warning':
                    toast.style.backgroundColor = '#f59e0b';
                    break;
                default:
                    toast.style.backgroundColor = '#3b82f6';
            }

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // Story Analysis Functions
        function analyzeStoryStructure() {
            if (!speechData.raw || speechData.raw.length < 100) {
                showToast('⚠️ Please add more content to analyze', 'warning');
                return;
            }

            const analysis = performStoryAnalysis(speechData.raw);
            updateStoryDisplay(analysis);
            showToast(`🎭 Story analysis complete - ${analysis.sparklineScore}% narrative strength`, 'success');
        }

        function performStoryAnalysis(text) {
            const paragraphs = text.split(/\n+/).map(p => p.trim()).filter(p => p.length > 0);
            const segments = [];

            paragraphs.forEach((para, index) => {
                const sentiment = classifySegment(para, index, paragraphs.length);
                segments.push({
                    text: para.substring(0, 100) + (para.length > 100 ? '...' : ''),
                    type: sentiment.type,
                    confidence: sentiment.confidence,
                    position: index / (paragraphs.length - 1) * 100
                });
            });

            const whatIsCount = segments.filter(s => s.type === 'what-is').length;
            const whatCouldBeCount = segments.filter(s => s.type === 'what-could-be').length;
            const totalSegments = segments.length;

            // Calculate sparkline score based on alternation and balance
            const sparklineScore = calculateSparklineScore(segments);
            const contrastRatio = whatCouldBeCount > 0 ?
                (whatIsCount / whatCouldBeCount).toFixed(1) + ':1' :
                'No contrast detected';

            return {
                segments,
                whatIsCount,
                whatCouldBeCount,
                sparklineScore,
                contrastRatio,
                totalSegments
            };
        }

        function classifySegment(text, position, total) {
            const lower = text.toLowerCase();

            // "What Could Be" indicators (positive vision, possibilities, solutions)
            const visionWords = [
                'will', 'can', 'could', 'should', 'imagine', 'vision', 'future', 'possibility',
                'opportunity', 'potential', 'hope', 'dream', 'achieve', 'success', 'together',
                'solution', 'better', 'improve', 'transform', 'change', 'new', 'innovation'
            ];

            // "What Is" indicators (problems, current state, challenges)
            const problemWords = [
                'problem', 'challenge', 'issue', 'difficulty', 'struggle', 'crisis', 'concern',
                'currently', 'today', 'now', 'present', 'existing', 'status quo', 'unfortunately',
                'however', 'but', 'yet', 'still', 'remain', 'continue', 'persist'
            ];

            let visionScore = 0;
            let problemScore = 0;

            // Count vision and problem indicators
            visionWords.forEach(word => {
                if (lower.includes(word)) visionScore++;
            });

            problemWords.forEach(word => {
                if (lower.includes(word)) problemScore++;
            });

            // Consider position in speech
            const positionWeight = position / total;

            // Opening and closing tend to be more visionary
            if (positionWeight < 0.2 || positionWeight > 0.8) {
                visionScore += 2;
            }

            // Middle sections often describe current problems
            if (positionWeight > 0.3 && positionWeight < 0.7) {
                problemScore += 1;
            }

            // Determine classification
            const confidence = Math.min(Math.max(Math.abs(visionScore - problemScore) * 0.2, 0.3), 0.9);

            if (visionScore > problemScore) {
                return { type: 'what-could-be', confidence };
            } else if (problemScore > visionScore) {
                return { type: 'what-is', confidence };
            } else {
                // Default based on position
                return {
                    type: positionWeight > 0.5 ? 'what-could-be' : 'what-is',
                    confidence: 0.3
                };
            }
        }

        function calculateSparklineScore(segments) {
            if (segments.length < 2) return 20;

            let alternationScore = 0;
            let balanceScore = 0;
            let transitionCount = 0;

            // Check for alternation between what-is and what-could-be
            for (let i = 1; i < segments.length; i++) {
                if (segments[i].type !== segments[i-1].type) {
                    alternationScore += 10;
                    transitionCount++;
                }
            }

            // Balance score - ideal ratio is around 1:1 to 2:1 (problems to solutions)
            const whatIsCount = segments.filter(s => s.type === 'what-is').length;
            const whatCouldBeCount = segments.filter(s => s.type === 'what-could-be').length;

            if (whatIsCount > 0 && whatCouldBeCount > 0) {
                const ratio = whatIsCount / whatCouldBeCount;
                if (ratio >= 0.5 && ratio <= 2.5) {
                    balanceScore = 30;
                } else {
                    balanceScore = 15;
                }
            }

            // Confidence bonus
            const avgConfidence = segments.reduce((sum, s) => sum + s.confidence, 0) / segments.length;
            const confidenceScore = avgConfidence * 20;

            // Final score (0-100)
            return Math.min(Math.round(alternationScore + balanceScore + confidenceScore), 100);
        }

        function updateStoryDisplay(analysis) {
            document.getElementById('sparkline-score').textContent = analysis.sparklineScore + '%';
            document.getElementById('what-is-count').textContent = analysis.whatIsCount;
            document.getElementById('what-could-be-count').textContent = analysis.whatCouldBeCount;
            document.getElementById('contrast-ratio').textContent = analysis.contrastRatio;

            renderSparklineChart(analysis.segments);
        }

        function renderSparklineChart(segments) {
            const container = document.getElementById('sparkline-visual');

            container.innerHTML = `
                <div class="sparkline-chart" id="sparkline-chart">
                    ${segments.map((segment, index) => `
                        <div class="sparkline-segment ${segment.type}"
                             style="left: ${segment.position}%; width: ${100/segments.length - 2}%"
                             title="${segment.text} (${Math.round(segment.confidence * 100)}% confidence)">
                            ${index + 1}
                        </div>
                    `).join('')}
                </div>
                <div class="sparkline-legend">
                    <div class="legend-item">
                        <div class="legend-color what-is"></div>
                        <span>What Is (Current Problems)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color what-could-be"></div>
                        <span>What Could Be (Future Vision)</span>
                    </div>
                </div>
            `;
        }

        function showSparklineDialog() {
            // Get stored context
            const audienceProfile = JSON.parse(localStorage.getItem('audienceProfile') || '{}');
            const bigIdeaProfile = JSON.parse(localStorage.getItem('bigIdeaProfile') || '{}');

            const modal = document.createElement('div');
            modal.className = 'workflow-modal';
            modal.innerHTML = `
                <div class="workflow-modal-content" style="max-width: 900px;">
                    <div class="workflow-header">
                        <h2>🎭 Step 3: Create Your Sparkline</h2>
                        <p>Alternate between "What Is" (current problems) and "What Could Be" (future vision)</p>
                        <button onclick="this.closest('.workflow-modal').remove()" class="close-btn">✕</button>
                    </div>

                    <div class="workflow-form">
                        ${bigIdeaProfile.bigIdea ? `
                        <div class="context-section">
                            <h4>💡 Your Big Idea</h4>
                            <div class="big-idea-reminder">"${bigIdeaProfile.bigIdea}"</div>
                        </div>
                        ` : ''}

                        <div class="sparkline-builder">
                            <div class="sparkline-instructions">
                                <p><strong>📝 Instructions:</strong> Create 5-7 segments that alternate between describing problems (What Is) and painting visions of solutions (What Could Be).</p>
                            </div>

                            <div class="sparkline-segments" id="sparkline-segments">
                                <!-- Segment 1: Opening - What Could Be -->
                                <div class="sparkline-segment" data-segment="1">
                                    <div class="segment-header what-could-be">
                                        <span class="segment-number">1</span>
                                        <span class="segment-type">🌟 Opening Vision (What Could Be)</span>
                                    </div>
                                    <textarea class="segment-content" placeholder="Start with an inspiring vision. Example: 'Imagine a community where every family can afford a home, where our children attend world-class schools...'" rows="3"></textarea>
                                </div>

                                <!-- Segment 2: What Is -->
                                <div class="sparkline-segment" data-segment="2">
                                    <div class="segment-header what-is">
                                        <span class="segment-number">2</span>
                                        <span class="segment-type">⚠️ Current Reality (What Is)</span>
                                    </div>
                                    <textarea class="segment-content" placeholder="Describe the current problem. Example: 'But today, we face a different reality. Housing costs have doubled, our schools are underfunded...'" rows="3"></textarea>
                                </div>

                                <!-- Segment 3: What Could Be -->
                                <div class="sparkline-segment" data-segment="3">
                                    <div class="segment-header what-could-be">
                                        <span class="segment-number">3</span>
                                        <span class="segment-type">💡 Solution Vision (What Could Be)</span>
                                    </div>
                                    <textarea class="segment-content" placeholder="Present your solution. Example: 'We can change this by building affordable housing, investing in our schools...'" rows="3"></textarea>
                                </div>

                                <!-- Segment 4: What Is -->
                                <div class="sparkline-segment" data-segment="4">
                                    <div class="segment-header what-is">
                                        <span class="segment-number">4</span>
                                        <span class="segment-type">🚧 Obstacles (What Is)</span>
                                    </div>
                                    <textarea class="segment-content" placeholder="Acknowledge challenges. Example: 'The obstacles are real - special interests oppose change, resources are limited...'" rows="3"></textarea>
                                </div>

                                <!-- Segment 5: What Could Be -->
                                <div class="sparkline-segment" data-segment="5">
                                    <div class="segment-header what-could-be">
                                        <span class="segment-number">5</span>
                                        <span class="segment-type">🚀 Path Forward (What Could Be)</span>
                                    </div>
                                    <textarea class="segment-content" placeholder="Show how to overcome. Example: 'But together, we have the power to overcome these obstacles by...'" rows="3"></textarea>
                                </div>

                                <!-- Segment 6: Call to Action -->
                                <div class="sparkline-segment" data-segment="6">
                                    <div class="segment-header call-to-action">
                                        <span class="segment-number">6</span>
                                        <span class="segment-type">📢 Call to Action (New Bliss)</span>
                                    </div>
                                    <textarea class="segment-content" placeholder="End with action. Example: 'Join me in creating this future. Vote on November 5th. Together, we will...'" rows="3"></textarea>
                                </div>
                            </div>

                            <div class="sparkline-actions">
                                <button onclick="addSparklineSegment()" class="btn-add-segment">➕ Add Segment</button>
                                <button onclick="removeLastSegment()" class="btn-remove-segment">➖ Remove Last</button>
                            </div>

                            <div class="sparkline-preview">
                                <h4>📊 Sparkline Preview</h4>
                                <div class="sparkline-visualization" id="sparkline-preview-viz">
                                    <!-- Will be populated dynamically -->
                                </div>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button onclick="processSparkline()" class="btn-primary">🎯 Create Speech Structure</button>
                            <button onclick="this.closest('.workflow-modal').remove()" class="btn-secondary">Cancel</button>
                        </div>
                    </div>
                </div>
            `;

            // Add sparkline-specific styles
            if (!document.getElementById('sparkline-dialog-styles')) {
                const style = document.createElement('style');
                style.id = 'sparkline-dialog-styles';
                style.textContent = `
                    .big-idea-reminder {
                        background: #fef3c7;
                        padding: 12px;
                        border-radius: 6px;
                        border-left: 4px solid #f59e0b;
                        font-style: italic;
                        color: #92400e;
                    }
                    .sparkline-builder {
                        margin-top: 20px;
                    }
                    .sparkline-instructions {
                        background: #f0f9ff;
                        border: 1px solid #0ea5e9;
                        border-radius: 8px;
                        padding: 12px;
                        margin-bottom: 20px;
                    }
                    .sparkline-instructions p {
                        margin: 0;
                        color: #075985;
                        font-size: 14px;
                    }
                    .sparkline-segments {
                        display: flex;
                        flex-direction: column;
                        gap: 16px;
                    }
                    .sparkline-segment {
                        border: 2px solid #e5e7eb;
                        border-radius: 8px;
                        overflow: hidden;
                        transition: all 0.2s;
                    }
                    .sparkline-segment:hover {
                        border-color: #3b82f6;
                        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
                    }
                    .segment-header {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 12px;
                        font-weight: 600;
                        font-size: 14px;
                    }
                    .segment-header.what-is {
                        background: linear-gradient(135deg, #fef2f2, #fee2e2);
                        color: #991b1b;
                    }
                    .segment-header.what-could-be {
                        background: linear-gradient(135deg, #ecfdf5, #d1fae5);
                        color: #064e3b;
                    }
                    .segment-header.call-to-action {
                        background: linear-gradient(135deg, #fef3c7, #fed7aa);
                        color: #92400e;
                    }
                    .segment-number {
                        width: 24px;
                        height: 24px;
                        border-radius: 50%;
                        background: rgba(0, 0, 0, 0.1);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 12px;
                        font-weight: bold;
                    }
                    .segment-content {
                        width: 100%;
                        padding: 12px;
                        border: none;
                        outline: none;
                        font-size: 14px;
                        line-height: 1.6;
                        resize: vertical;
                        font-family: inherit;
                    }
                    .segment-content:focus {
                        background: #fffbeb;
                    }
                    .sparkline-actions {
                        display: flex;
                        gap: 12px;
                        justify-content: center;
                        margin: 20px 0;
                    }
                    .btn-add-segment, .btn-remove-segment {
                        padding: 8px 16px;
                        border-radius: 6px;
                        border: 1px solid #d1d5db;
                        background: white;
                        cursor: pointer;
                        font-size: 14px;
                        transition: all 0.2s;
                    }
                    .btn-add-segment:hover {
                        background: #ecfdf5;
                        border-color: #10b981;
                    }
                    .btn-remove-segment:hover {
                        background: #fef2f2;
                        border-color: #ef4444;
                    }
                    .sparkline-preview {
                        background: #f9fafb;
                        border-radius: 8px;
                        padding: 16px;
                        margin-top: 20px;
                    }
                    .sparkline-preview h4 {
                        margin: 0 0 12px 0;
                        color: #374151;
                        font-size: 14px;
                    }
                    .sparkline-visualization {
                        height: 60px;
                        background: white;
                        border-radius: 4px;
                        display: flex;
                        align-items: center;
                        padding: 10px;
                        gap: 4px;
                    }
                    .viz-segment {
                        flex: 1;
                        height: 30px;
                        border-radius: 4px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 11px;
                        color: white;
                        font-weight: bold;
                    }
                    .viz-segment.what-is {
                        background: #ef4444;
                        margin-top: 15px;
                    }
                    .viz-segment.what-could-be {
                        background: #10b981;
                        margin-bottom: 15px;
                    }
                    .viz-segment.call-to-action {
                        background: #f59e0b;
                    }
                `;
                document.head.appendChild(style);
            }

            document.body.appendChild(modal);

            // Update preview on input
            const updatePreview = () => {
                const segments = modal.querySelectorAll('.sparkline-segment');
                const viz = modal.querySelector('#sparkline-preview-viz');
                viz.innerHTML = '';

                segments.forEach((segment, index) => {
                    const header = segment.querySelector('.segment-header');
                    const vizSegment = document.createElement('div');
                    vizSegment.className = 'viz-segment';

                    if (header.classList.contains('what-is')) {
                        vizSegment.classList.add('what-is');
                    } else if (header.classList.contains('what-could-be')) {
                        vizSegment.classList.add('what-could-be');
                    } else {
                        vizSegment.classList.add('call-to-action');
                    }

                    vizSegment.textContent = index + 1;
                    viz.appendChild(vizSegment);
                });
            };

            // Add input listeners
            modal.querySelectorAll('.segment-content').forEach(textarea => {
                textarea.addEventListener('input', updatePreview);
            });

            // Initialize preview
            updatePreview();
        }

        function addSparklineSegment() {
            const modal = document.querySelector('.workflow-modal');
            const segments = modal.querySelector('#sparkline-segments');
            const currentCount = segments.children.length;

            if (currentCount >= 10) {
                showToast('Maximum of 10 segments allowed', 'warning');
                return;
            }

            // Determine type based on alternation
            const isWhatIs = currentCount % 2 === 1;
            const typeClass = isWhatIs ? 'what-is' : 'what-could-be';
            const typeLabel = isWhatIs ? '⚠️ Current Reality (What Is)' : '💡 Solution Vision (What Could Be)';

            const newSegment = document.createElement('div');
            newSegment.className = 'sparkline-segment';
            newSegment.dataset.segment = currentCount + 1;
            newSegment.innerHTML = `
                <div class="segment-header ${typeClass}">
                    <span class="segment-number">${currentCount + 1}</span>
                    <span class="segment-type">${typeLabel}</span>
                </div>
                <textarea class="segment-content" placeholder="Enter your content for this segment..." rows="3"></textarea>
            `;

            segments.appendChild(newSegment);

            // Add input listener
            newSegment.querySelector('.segment-content').addEventListener('input', () => {
                const modal = document.querySelector('.workflow-modal');
                const segments = modal.querySelectorAll('.sparkline-segment');
                const viz = modal.querySelector('#sparkline-preview-viz');
                viz.innerHTML = '';

                segments.forEach((segment, index) => {
                    const header = segment.querySelector('.segment-header');
                    const vizSegment = document.createElement('div');
                    vizSegment.className = 'viz-segment';

                    if (header.classList.contains('what-is')) {
                        vizSegment.classList.add('what-is');
                    } else if (header.classList.contains('what-could-be')) {
                        vizSegment.classList.add('what-could-be');
                    } else {
                        vizSegment.classList.add('call-to-action');
                    }

                    vizSegment.textContent = index + 1;
                    viz.appendChild(vizSegment);
                });
            });
        }

        function removeLastSegment() {
            const modal = document.querySelector('.workflow-modal');
            const segments = modal.querySelector('#sparkline-segments');

            if (segments.children.length <= 3) {
                showToast('Minimum of 3 segments required', 'warning');
                return;
            }

            segments.removeChild(segments.lastElementChild);

            // Update preview
            const viz = modal.querySelector('#sparkline-preview-viz');
            viz.innerHTML = '';

            modal.querySelectorAll('.sparkline-segment').forEach((segment, index) => {
                const header = segment.querySelector('.segment-header');
                const vizSegment = document.createElement('div');
                vizSegment.className = 'viz-segment';

                if (header.classList.contains('what-is')) {
                    vizSegment.classList.add('what-is');
                } else if (header.classList.contains('what-could-be')) {
                    vizSegment.classList.add('what-could-be');
                } else {
                    vizSegment.classList.add('call-to-action');
                }

                vizSegment.textContent = index + 1;
                viz.appendChild(vizSegment);
            });
        }

        function processSparkline() {
            const modal = document.querySelector('.workflow-modal');
            const segments = [];

            modal.querySelectorAll('.sparkline-segment').forEach((segment, index) => {
                const header = segment.querySelector('.segment-header');
                const content = segment.querySelector('.segment-content').value;

                let type = 'what-could-be';
                if (header.classList.contains('what-is')) {
                    type = 'what-is';
                } else if (header.classList.contains('call-to-action')) {
                    type = 'call-to-action';
                }

                segments.push({
                    order: index + 1,
                    type: type,
                    content: content
                });
            });

            // Validate at least some content
            const hasContent = segments.some(s => s.content.trim().length > 0);
            if (!hasContent) {
                showToast('❌ Please add content to at least one segment', 'error');
                return;
            }

            // Create full speech from segments
            const speechContent = segments
                .filter(s => s.content.trim())
                .map(s => s.content.trim())
                .join('\n\n');

            // Store sparkline data
            localStorage.setItem('sparklineStructure', JSON.stringify(segments));

            // Update speech data
            speechData.raw = speechContent;
            document.getElementById('speech-input').value = speechContent;

            // Parse and update
            updateStats(speechContent);
            parseSpeechStructure(speechContent);

            // Close modal
            modal.remove();

            // Mark complete
            markStepComplete(3);

            showToast('🎭 Sparkline structure created! Your speech has been populated.', 'success');

            // Switch to structure view to see the result
            setTimeout(() => {
                switchView('structure');
                toggleWorkflowStep(4);
            }, 1500);
        }

        function useStoryTemplate() {
            const template = `[Opening - What Could Be]
Good morning, everyone. Imagine a future where [YOUR VISION - what could be different/better].

[What Is - Current Challenge]
But today, we face a different reality. Currently, [DESCRIBE THE PROBLEM - what is happening now that needs to change].

[What Could Be - Possibility]
However, we have the power to change this. We can create a world where [EXPAND YOUR VISION - what becomes possible].

[What Is - Obstacle]
The challenge before us is real. [DETAIL THE OBSTACLES - what stands in the way].

[What Could Be - Solution Path]
But here's what we can do together. [YOUR SOLUTION - how we get to the better future].

[What Is - Current Action Needed]
This requires us to act now. Today, [WHAT NEEDS TO HAPPEN IMMEDIATELY].

[Call to Action - What Could Be]
Together, we will [YOUR CALL TO ACTION]. Thank you.

---
DUARTE METHOD GUIDELINES:
• Alternate between "What Is" (current problems/challenges) and "What Could Be" (future vision/possibilities)
• Each section should contrast the current reality with the desired future
• Create emotional tension by highlighting the gap between present and future
• End with a compelling call to action that bridges that gap
• Use concrete examples and vivid imagery
• Keep the audience engaged with the emotional journey

Replace the bracketed sections with your specific content while maintaining the alternating structure.`;

            // Switch to printout view and insert template
            if (currentView !== 'printout') {
                switchView('printout');
            }

            setTimeout(() => {
                const contentArea = document.querySelector('.speech-content');
                if (contentArea) {
                    contentArea.innerHTML = template.split('\n').map(line => `<p>${line}</p>`).join('');
                    speechData.raw = template;
                    updateStats(template);
                    markStepComplete(3);
                    showToast('🎭 Story template loaded! Now refine your content in Structure view.', 'success');
                    setTimeout(() => toggleWorkflowStep(4), 1000);
                }
            }, 500);
        }

        // Structure View Functions
        function renderStructureView() {
            const container = document.getElementById('content-area');

            // Try to get content from speech-input textarea if speechData.raw is empty
            if (!speechData.raw || speechData.raw.trim().length === 0) {
                const speechInput = document.getElementById('speech-input');
                if (speechInput && speechInput.value && speechInput.value.trim().length > 0) {
                    speechData.raw = speechInput.value;
                    updateStats(speechData.raw);
                    parseSpeechStructure(speechData.raw);
                }
            }

            if (!speechData.raw || speechData.raw.trim().length === 0) {
                container.innerHTML = `
                    <div class="structure-view">
                        <div class="empty-state">
                            <h2>🏗️ Speech Structure</h2>
                            <p>View and edit the structural components of your speech</p>
                            <textarea class="initial-paste-area" id="structure-input"
                                placeholder="Paste your speech here to see its structure..."></textarea>
                        </div>
                    </div>
                `;
                const structureInput = document.getElementById('structure-input');
                if (structureInput) {
                    structureInput.addEventListener('input', (e) => {
                        speechData.raw = e.target.value;
                        updateStats(e.target.value);
                        parseSpeechStructure(e.target.value);
                        syncToAllViews();
                    });
                }
                return;
            }

            // Parse speech into structural sections
            const sections = createStructuredSections(speechData.raw);
            container.innerHTML = `
                <div class="structure-view">
                    <div class="structure-header">
                        <h2>🏗️ Speech Structure</h2>
                        <p>Edit individual sections and see your speech's organization</p>
                    </div>
                    <div class="structure-sections">
                        ${sections.map((section, index) => `
                            <div class="structure-section" data-section="${index}">
                                <div class="section-header">
                                    <span class="section-type-label">${section.type}</span>
                                    <span class="section-stats">${section.wordCount} words</span>
                                </div>
                                <div class="section-content" contenteditable="true" data-section-index="${index}">
                                    ${section.content}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            setupStructureListeners();
        }

        function createStructuredSections(text) {
            const paragraphs = text.split(/\n+/).map(p => p.trim()).filter(p => p.length > 0);
            return paragraphs.map((para, index) => {
                let type = 'Body Paragraph';
                const wordCount = para.split(/\s+/).length;

                // Classify section type
                if (index === 0) {
                    type = 'Opening';
                } else if (index === paragraphs.length - 1) {
                    type = 'Closing';
                } else if (para.includes('"') || para.includes('"') || para.includes('"')) {
                    type = 'Quote';
                } else if (para.length < 100) {
                    type = 'Headline';
                }

                return {
                    type,
                    content: para,
                    wordCount
                };
            });
        }

        function setupStructureListeners() {
            document.querySelectorAll('.section-content').forEach((element) => {
                element.addEventListener('input', (e) => {
                    // Rebuild speech data from all sections
                    const allSections = Array.from(document.querySelectorAll('.section-content'));
                    const updatedText = allSections.map(section => section.textContent).join('\n\n');
                    speechData.raw = updatedText;
                    syncToAllViews();
                });
            });
        }

        // Fix teleprompter rendering to use correct container
        function fixTeleprompterView() {
            if (currentView === 'teleprompter') {
                renderTeleprompterView();
            }
        }

        // FLOW VIEW: Shows speech flow structure, pacing, and transitions
        function renderFlowView() {
            const container = document.getElementById('speech-container');

            if (!speechData.raw || speechData.raw.trim().length === 0) {
                container.innerHTML = `
                    <div class="flow-view">
                        <div class="empty-state">
                            <h2>🌊 Speech Flow</h2>
                            <p>View and edit your speech as a continuous flow - the pure words as they will be spoken</p>
                            <textarea class="initial-paste-area" id="flow-input"
                                placeholder="Enter your speech content to see it as a continuous flow..."></textarea>
                        </div>
                    </div>
                `;
                const flowInput = document.getElementById('flow-input');
                if (flowInput) {
                    flowInput.addEventListener('input', (e) => {
                        speechData.raw = e.target.value;
                        updateStats(e.target.value);
                        parseSpeechStructure(e.target.value);
                        syncToAllViews();
                    });
                }
                return;
            }

            // Extract just the speech content without metadata
            let flowContent = speechData.raw;

            // Remove common metadata patterns (title, date, location, source)
            flowContent = flowContent
                .replace(/^TRANSCRIPT:\s*.+$/gm, '')  // Remove transcript lines
                .replace(/^(January|February|March|April|May|June|July|August|September|October|November|December)\s+\d{1,2},?\s+\d{4}.*$/gm, '') // Remove dates
                .replace(/^[A-Z][A-Za-z\s]+,\s*[A-Z]{2}\s*[-–—].*$/gm, '') // Remove location lines
                .replace(/^Source:.*$/gm, '') // Remove source lines
                .replace(/^This transcript.*$/gm, '') // Remove transcript descriptions
                .trim();

            // Clean up extra line breaks
            flowContent = flowContent.replace(/\n{3,}/g, '\n\n').trim();

            container.innerHTML = `
                <div class="flow-view" style="padding: 40px; max-width: 800px; margin: 0 auto;">
                    <div style="margin-bottom: 20px; text-align: center;">
                        <h2 style="color: #1e293b; margin-bottom: 8px;">🌊 Speech Flow</h2>
                        <p style="color: #64748b; font-size: 14px;">The pure words as they will be spoken - a continuous monologue</p>
                    </div>

                    <div class="flow-content"
                         contenteditable="true"
                         id="flow-content"
                         style="
                            background: white;
                            border: 1px solid #e5e7eb;
                            border-radius: 8px;
                            padding: 30px;
                            font-size: 18px;
                            line-height: 1.8;
                            color: #1e293b;
                            font-family: Georgia, serif;
                            white-space: pre-wrap;
                            min-height: 500px;
                            outline: none;
                         ">
${flowContent}
                    </div>

                    <div style="margin-top: 20px; padding: 16px; background: #f8fafc; border-radius: 8px;">
                        <p style="color: #64748b; font-size: 13px; margin: 0;">
                            💡 <strong>Tip:</strong> This view shows only the speech content - no titles, dates, or source information.
                            Just the words as they flow from beginning to end. Edit directly to refine the flow and rhythm.
                        </p>
                    </div>
                </div>
            `;

            // Setup listener for edits
            const flowContentEl = document.getElementById('flow-content');
            if (flowContentEl) {
                flowContentEl.addEventListener('input', (e) => {
                    // Update speechData but preserve metadata
                    const currentMetadata = extractMetadataFromRaw(speechData.raw);
                    speechData.raw = reconstructSpeechWithMetadata(e.target.innerText, currentMetadata);
                    updateStats(speechData.raw);
                    parseSpeechStructure(speechData.raw);
                });
            }
        }

        // Helper functions for flow view
        function extractMetadataFromRaw(rawText) {
            const lines = rawText.split('\n');
            const metadata = {
                title: '',
                date: '',
                location: '',
                source: ''
            };

            // Extract title (first line with TRANSCRIPT:)
            const titleLine = lines.find(line => line.includes('TRANSCRIPT:'));
            if (titleLine) metadata.title = titleLine;

            // Extract date and location
            const dateLine = lines.find(line => /\w+\s+\d{1,2},?\s+\d{4}/.test(line));
            if (dateLine) metadata.date = dateLine;

            // Extract source (last lines)
            const sourceLines = lines.filter(line =>
                line.toLowerCase().includes('source:') ||
                line.toLowerCase().includes('this transcript')
            );
            if (sourceLines.length > 0) metadata.source = sourceLines.join('\n');

            return metadata;
        }

        function reconstructSpeechWithMetadata(speechContent, metadata) {
            let result = '';
            if (metadata.title) result += metadata.title + '\n\n';
            if (metadata.date) result += metadata.date + '\n\n';
            result += speechContent;
            if (metadata.source) result += '\n\n' + metadata.source;
            return result;
                    }
                    .flow-element:hover {
                        border-color: #3b82f6;
                        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
                    }
                    .element-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px 16px;
                        background: #f9fafb;
                        border-bottom: 1px solid #e5e7eb;
                    }
                    .element-type {
                        font-weight: 600;
                        color: #374151;
                        font-size: 14px;
                    }
                    .element-stats {
                        font-size: 12px;
                        color: #6b7280;
                    }
                    .element-content {
                        padding: 16px;
                        line-height: 1.6;
                        min-height: 60px;
                        outline: none;
                        border: none;
                    }
                    .element-content:focus {
                        background: #fffbeb;
                    }
                    .element-flow-tips {
                        padding: 12px 16px;
                        background: #fef3c7;
                        border-top: 1px solid #f59e0b;
                        font-size: 13px;
                        color: #92400e;
                        font-style: italic;
                    }
                    .flow-recommendations {
                        background: #eff6ff;
                        padding: 20px;
                        border-radius: 12px;
                        border: 1px solid #3b82f6;
                    }
                    .flow-recommendations h3 {
                        color: #1d4ed8;
                        margin-bottom: 12px;
                    }
                    .flow-recommendations ul {
                        margin: 0;
                        padding-left: 20px;
                        color: #1e40af;
                    }
                    .flow-recommendations li {
                        margin-bottom: 8px;
                    }
                `;
                document.head.appendChild(style);
            }
        }

        function analyzeFlowStructure(text) {
            const sentences = text.split(/[.!?]+/).map(s => s.trim()).filter(s => s.length > 5);
            const paragraphs = text.split(/\n+/).map(p => p.trim()).filter(p => p.length > 0);
            const totalWords = text.split(/\s+/).length;

            // Calculate flow metrics
            const avgSentenceLength = Math.round(sentences.reduce((sum, s) => sum + s.split(/\s+/).length, 0) / sentences.length);
            const transitions = countTransitions(text);
            const flowScore = calculateFlowScore(sentences, transitions);

            // Analyze each paragraph as a flow element
            const elements = paragraphs.map((para, index) => {
                const wordCount = para.split(/\s+/).length;
                const sentiment = analyzeSentiment(para);
                const position = index / (paragraphs.length - 1);

                let type, icon, label, flowTip;

                if (index === 0) {
                    type = 'opening';
                    icon = '🎯';
                    label = 'Opening Hook';
                    flowTip = 'Start with a compelling statement that grabs attention immediately.';
                } else if (index === paragraphs.length - 1) {
                    type = 'closing';
                    icon = '🏁';
                    label = 'Closing Impact';
                    flowTip = 'End with a memorable statement that reinforces your main message.';
                } else if (position < 0.3) {
                    type = 'building';
                    icon = '⚡';
                    label = 'Building Energy';
                    flowTip = 'Build momentum by establishing context and importance.';
                } else if (position > 0.7) {
                    type = 'climax';
                    icon = '🎉';
                    label = 'Key Point';
                    flowTip = 'This is your moment - make your strongest argument here.';
                } else {
                    type = 'transition';
                    icon = '🔄';
                    label = 'Transition';
                    flowTip = 'Bridge your ideas smoothly to maintain audience engagement.';
                }

                return {
                    type, icon, label, flowTip,
                    text: para,
                    wordCount,
                    sentiment
                };
            });

            // Generate flow improvement suggestions
            const suggestions = generateFlowSuggestions(sentences, elements, transitions, avgSentenceLength);

            return {
                flowScore,
                avgSentenceLength,
                transitions,
                sentences,
                elements,
                suggestions
            };
        }

        function countTransitions(text) {
            const transitionWords = /\b(however|but|yet|therefore|thus|meanwhile|furthermore|moreover|additionally|consequently|as a result|on the other hand|in contrast|similarly|likewise|for example|for instance|in conclusion|finally)\b/gi;
            return (text.match(transitionWords) || []).length;
        }

        function analyzeSentiment(text) {
            const positiveWords = /\b(great|excellent|amazing|wonderful|fantastic|outstanding|successful|victory|triumph|hope|dream|future|opportunity|together|unite|strong)\b/gi;
            const negativeWords = /\b(problem|issue|challenge|difficulty|crisis|struggle|concern|worry|fear|threat|danger|failure|broken|wrong)\b/gi;

            const positive = (text.match(positiveWords) || []).length;
            const negative = (text.match(negativeWords) || []).length;

            if (positive > negative) return 'Positive';
            if (negative > positive) return 'Challenging';
            return 'Neutral';
        }

        function calculateFlowScore(sentences, transitions) {
            let score = 0;

            // Sentence variety bonus
            const lengths = sentences.map(s => s.split(/\s+/).length);
            const variance = calculateVariance(lengths);
            if (variance > 20) score += 25; // Good sentence variety

            // Transition bonus
            if (transitions > sentences.length * 0.1) score += 25; // Good transition usage

            // Opening/closing bonus
            const firstSentence = sentences[0] || '';
            const lastSentence = sentences[sentences.length - 1] || '';
            if (firstSentence.length > 50) score += 15; // Strong opening
            if (lastSentence.includes('thank') || lastSentence.includes('together')) score += 15; // Strong closing

            // Momentum bonus (building sentence length pattern)
            let momentum = 0;
            for (let i = 1; i < Math.min(5, lengths.length); i++) {
                if (lengths[i] >= lengths[i-1]) momentum++;
            }
            if (momentum > 2) score += 20; // Good early momentum

            return Math.min(score, 100);
        }

        function calculateVariance(numbers) {
            const mean = numbers.reduce((a, b) => a + b, 0) / numbers.length;
            const squaredDiffs = numbers.map(num => Math.pow(num - mean, 2));
            return squaredDiffs.reduce((a, b) => a + b, 0) / numbers.length;
        }

        function generateFlowSuggestions(sentences, elements, transitions, avgSentenceLength) {
            const suggestions = [];

            if (avgSentenceLength > 25) {
                suggestions.push("🔸 Consider shorter sentences for better flow and impact.");
            }

            if (avgSentenceLength < 10) {
                suggestions.push("🔸 Some longer sentences could add depth and sophistication.");
            }

            if (transitions < sentences.length * 0.08) {
                suggestions.push("🔸 Add more transition words to improve flow between ideas.");
            }

            const openingElement = elements[0];
            if (openingElement && openingElement.wordCount < 20) {
                suggestions.push("🔸 Expand your opening to create a stronger hook.");
            }

            const closingElement = elements[elements.length - 1];
            if (closingElement && !closingElement.text.toLowerCase().includes('thank')) {
                suggestions.push("🔸 Consider adding appreciation or gratitude in your closing.");
            }

            const climaxElements = elements.filter(e => e.type === 'climax');
            if (climaxElements.length === 0) {
                suggestions.push("🔸 Identify and strengthen your key message moment for maximum impact.");
            }

            if (suggestions.length === 0) {
                suggestions.push("🔸 Excellent flow structure! Your speech has good pacing and transitions.");
            }

            return suggestions;
        }

        function renderFlowChart(sentences) {
            const totalWidth = Math.max(600, sentences.length * 40);
            const segmentWidth = totalWidth / sentences.length;

            return sentences.map((sentence, index) => {
                const position = (index * segmentWidth);
                const width = segmentWidth - 2;
                const wordCount = sentence.split(/\s+/).length;

                let type = 'building';
                if (index === 0) type = 'opening';
                else if (index === sentences.length - 1) type = 'closing';
                else if (wordCount > 20 || sentence.includes('!')) type = 'climax';
                else if (sentence.match(/\b(however|but|therefore|thus)\b/i)) type = 'transition';

                const height = Math.min(Math.max(wordCount, 8), 40);

                return `<div class="flow-bar ${type}"
                           style="left: ${position}px; width: ${width}px; height: ${height}px; top: ${50 - height/2}px"
                           title="Sentence ${index + 1}: ${wordCount} words">
                    ${index + 1}
                </div>`;
            }).join('');
        }

        function setupFlowListeners() {
            document.querySelectorAll('.element-content').forEach((element) => {
                element.addEventListener('input', (e) => {
                    // Rebuild speech data from all flow elements
                    const allElements = Array.from(document.querySelectorAll('.element-content'));
                    const updatedText = allElements.map(el => el.textContent).join('\n\n');
                    speechData.raw = updatedText;
                    syncToAllViews();
                });
            });
        }

        // Story Workflow Functions
        function toggleWorkflowStep(stepNumber) {
            const content = document.getElementById(`step-${stepNumber}-content`);
            const isVisible = content.style.display !== 'none';

            // Close all other steps
            for (let i = 1; i <= 5; i++) {
                const otherContent = document.getElementById(`step-${i}-content`);
                if (otherContent) otherContent.style.display = 'none';
            }

            // Toggle current step
            if (content) {
                content.style.display = isVisible ? 'none' : 'block';
            }
        }

        function startEmpathyWalk() {
            showEmpathyWalkDialog();
        }

        function showEmpathyWalkDialog() {
            const modal = document.createElement('div');
            modal.className = 'workflow-modal';
            modal.innerHTML = `
                <div class="workflow-modal-content">
                    <div class="workflow-header">
                        <h2>🚶 Step 1: Empathy Walk</h2>
                        <p>Understanding your audience deeply is the foundation of effective communication.</p>
                        <button onclick="this.closest('.workflow-modal').remove()" class="close-btn">✕</button>
                    </div>

                    <div class="workflow-form">
                        <div class="form-section">
                            <label>👥 Who is your primary audience? (Select up to 3)</label>
                            <div class="choice-group">
                                <label><input type="checkbox" name="audience" value="Local community members"> Local community members</label>
                                <label><input type="checkbox" name="audience" value="Campaign supporters"> Campaign supporters</label>
                                <label><input type="checkbox" name="audience" value="Undecided voters"> Undecided voters</label>
                                <label><input type="checkbox" name="audience" value="Business leaders"> Business leaders</label>
                                <label><input type="checkbox" name="audience" value="Union members"> Union members</label>
                                <label><input type="checkbox" name="audience" value="Students/young voters"> Students/young voters</label>
                                <label><input type="checkbox" name="audience" value="Senior citizens"> Senior citizens</label>
                                <input type="text" id="audience-other" placeholder="Other audience groups...">
                            </div>
                        </div>

                        <div class="form-section">
                            <label>💝 What do they care about most? (Select up to 3)</label>
                            <div class="choice-group">
                                <label><input type="checkbox" name="cares" value="Healthcare"> Healthcare</label>
                                <label><input type="checkbox" name="cares" value="Jobs and economy"> Jobs and economy</label>
                                <label><input type="checkbox" name="cares" value="Education"> Education</label>
                                <label><input type="checkbox" name="cares" value="Public safety"> Public safety</label>
                                <label><input type="checkbox" name="cares" value="Housing costs"> Housing costs</label>
                                <label><input type="checkbox" name="cares" value="Climate and environment"> Climate and environment</label>
                                <label><input type="checkbox" name="cares" value="Transportation"> Transportation</label>
                                <label><input type="checkbox" name="cares" value="Government accountability"> Government accountability</label>
                                <label><input type="checkbox" name="cares" value="Social justice"> Social justice</label>
                                <input type="text" id="cares-other" placeholder="Other important issues...">
                            </div>
                        </div>

                        <div class="form-section">
                            <label>😟 What are their main concerns or fears? (Select up to 3)</label>
                            <div class="choice-group">
                                <label><input type="checkbox" name="concerns" value="Rising costs of living"> Rising costs of living</label>
                                <label><input type="checkbox" name="concerns" value="Job security"> Job security</label>
                                <label><input type="checkbox" name="concerns" value="Trust in government"> Trust in government</label>
                                <label><input type="checkbox" name="concerns" value="Personal safety"> Personal safety</label>
                                <label><input type="checkbox" name="concerns" value="Children's future"> Children's future</label>
                                <label><input type="checkbox" name="concerns" value="Political division"> Political division</label>
                                <label><input type="checkbox" name="concerns" value="Economic recession"> Economic recession</label>
                                <label><input type="checkbox" name="concerns" value="Healthcare access"> Healthcare access</label>
                                <label><input type="checkbox" name="concerns" value="Climate change"> Climate change</label>
                                <input type="text" id="concerns-other" placeholder="Other concerns...">
                            </div>
                        </div>

                        <div class="form-section">
                            <label>🎯 What emotional state are they in when they hear your message?</label>
                            <select id="emotional-state">
                                <option value="">Select emotional state...</option>
                                <option value="Hopeful but cautious">Hopeful but cautious</option>
                                <option value="Frustrated and angry">Frustrated and angry</option>
                                <option value="Worried and anxious">Worried and anxious</option>
                                <option value="Excited and engaged">Excited and engaged</option>
                                <option value="Skeptical and distrustful">Skeptical and distrustful</option>
                                <option value="Tired and overwhelmed">Tired and overwhelmed</option>
                                <option value="Curious and open-minded">Curious and open-minded</option>
                            </select>
                        </div>

                        <div class="form-actions">
                            <button onclick="processEmpathyWalk()" class="btn-primary">💡 Analyze Audience</button>
                            <button onclick="this.closest('.workflow-modal').remove()" class="btn-secondary">Cancel</button>
                        </div>
                    </div>
                </div>
            `;

            // Add modal styles
            if (!document.getElementById('workflow-modal-styles')) {
                const style = document.createElement('style');
                style.id = 'workflow-modal-styles';
                style.textContent = `
                    .workflow-modal {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.8);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 2000;
                        animation: fadeIn 0.3s ease;
                    }
                    .workflow-modal-content {
                        background: white;
                        border-radius: 12px;
                        max-width: 700px;
                        max-height: 90vh;
                        overflow-y: auto;
                        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
                        animation: slideUp 0.3s ease;
                    }
                    .workflow-header {
                        background: linear-gradient(135deg, #1f2937, #374151);
                        color: white;
                        padding: 24px;
                        border-radius: 12px 12px 0 0;
                        position: relative;
                    }
                    .workflow-header h2 {
                        margin: 0 0 8px 0;
                        font-size: 24px;
                    }
                    .workflow-header p {
                        margin: 0;
                        opacity: 0.9;
                        font-size: 16px;
                    }
                    .close-btn {
                        position: absolute;
                        top: 20px;
                        right: 20px;
                        background: none;
                        border: none;
                        color: white;
                        font-size: 24px;
                        cursor: pointer;
                        padding: 4px;
                    }
                    .workflow-form {
                        padding: 24px;
                    }
                    .form-section {
                        margin-bottom: 32px;
                    }
                    .form-section label {
                        display: block;
                        font-weight: 600;
                        margin-bottom: 12px;
                        color: #374151;
                        font-size: 16px;
                    }
                    .choice-group {
                        display: grid;
                        gap: 8px;
                    }
                    .choice-group label {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        padding: 8px 12px;
                        border: 1px solid #e5e7eb;
                        border-radius: 6px;
                        cursor: pointer;
                        font-weight: 400;
                        font-size: 14px;
                        transition: all 0.2s;
                    }
                    .choice-group label:hover {
                        background: #f3f4f6;
                        border-color: #3b82f6;
                    }
                    .choice-group input[type="radio"]:checked + span,
                    .choice-group input[type="checkbox"]:checked + span {
                        color: #3b82f6;
                        font-weight: 500;
                    }
                    .choice-group input[type="text"] {
                        flex: 1;
                        border: none;
                        outline: none;
                        padding: 4px 8px;
                        margin-left: 8px;
                        border-bottom: 1px solid #d1d5db;
                        font-size: 14px;
                    }
                    select {
                        width: 100%;
                        padding: 12px;
                        border: 1px solid #d1d5db;
                        border-radius: 6px;
                        font-size: 14px;
                        background: white;
                    }
                    .form-actions {
                        display: flex;
                        gap: 12px;
                        justify-content: flex-end;
                        padding-top: 20px;
                        border-top: 1px solid #e5e7eb;
                        margin-top: 20px;
                    }
                    .btn-primary {
                        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 6px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.2s;
                    }
                    .btn-primary:hover {
                        transform: translateY(-1px);
                        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
                    }
                    .btn-secondary {
                        background: white;
                        color: #6b7280;
                        border: 1px solid #d1d5db;
                        padding: 12px 24px;
                        border-radius: 6px;
                        cursor: pointer;
                        transition: all 0.2s;
                    }
                    .btn-secondary:hover {
                        background: #f9fafb;
                        border-color: #9ca3af;
                    }
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideUp {
                        from { transform: translateY(30px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }

            document.body.appendChild(modal);

            // Handle checkbox limit for all three sections
            const audienceCheckboxes = modal.querySelectorAll('input[name="audience"]');
            const caresCheckboxes = modal.querySelectorAll('input[name="cares"]');
            const concernsCheckboxes = modal.querySelectorAll('input[name="concerns"]');

            function limitCheckboxes(checkboxes, limit) {
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        const checked = Array.from(checkboxes).filter(cb => cb.checked);
                        if (checked.length > limit) {
                            checkbox.checked = false;
                            showToast(`Please select only ${limit} options`, 'warning');
                        }
                    });
                });
            }

            limitCheckboxes(audienceCheckboxes, 3);
            limitCheckboxes(caresCheckboxes, 3);
            limitCheckboxes(concernsCheckboxes, 3);
        }

        function processEmpathyWalk() {
            const modal = document.querySelector('.workflow-modal');

            // Collect audience selections (now multiple checkboxes)
            const audienceChecked = Array.from(modal.querySelectorAll('input[name="audience"]:checked'))
                .map(cb => cb.value);
            const audienceOther = modal.querySelector('#audience-other').value;
            if (audienceOther) audienceChecked.push(audienceOther);

            // Collect care-abouts
            const caresChecked = Array.from(modal.querySelectorAll('input[name="cares"]:checked'))
                .map(cb => cb.value);
            const caresOther = modal.querySelector('#cares-other').value;
            if (caresOther) caresChecked.push(caresOther);

            // Collect concerns
            const concernsChecked = Array.from(modal.querySelectorAll('input[name="concerns"]:checked'))
                .map(cb => cb.value);
            const concernsOther = modal.querySelector('#concerns-other').value;
            if (concernsOther) concernsChecked.push(concernsOther);

            // Collect emotional state
            const emotionalState = modal.querySelector('#emotional-state').value;

            // Validation
            if (audienceChecked.length === 0) {
                showToast('❌ Please select at least one audience group', 'error');
                return;
            }

            if (caresChecked.length === 0) {
                showToast('❌ Please select what your audience cares about', 'error');
                return;
            }

            // Create comprehensive audience profile
            const audienceProfile = {
                audience: audienceChecked.join(', '),  // Join multiple audiences
                audiences: audienceChecked,  // Keep array for detailed analysis
                caresAbout: caresChecked,
                concerns: concernsChecked,
                emotionalState: emotionalState,
                timestamp: new Date().toISOString()
            };

            // Generate insights
            const insights = generateAudienceInsights(audienceProfile);

            // Store data
            localStorage.setItem('audienceProfile', JSON.stringify(audienceProfile));
            localStorage.setItem('audienceInsights', JSON.stringify(insights));

            // Close modal
            modal.remove();

            // Mark complete and show results
            markStepComplete(1);
            showAudienceInsights(audienceProfile, insights);

            setTimeout(() => toggleWorkflowStep(2), 2000);
        }

        function generateAudienceInsights(profile) {
            const insights = {
                communicationStyle: '',
                keyMessages: [],
                avoidTopics: [],
                emotionalApproach: '',
                credibilityFactors: []
            };

            // Handle multiple audiences - create blended communication style
            const audiences = profile.audiences || [profile.audience];
            const styles = [];
            const credFactors = new Set();

            audiences.forEach(aud => {
                switch (aud) {
                    case 'Business leaders':
                        styles.push('professional and data-driven');
                        credFactors.add('Economic expertise');
                        credFactors.add('Business experience');
                        break;
                    case 'Union members':
                        styles.push('direct and worker-focused');
                        credFactors.add('Labor support record');
                        credFactors.add('Fair wages commitment');
                        break;
                    case 'Students/young voters':
                        styles.push('energetic and future-focused');
                        credFactors.add('Progressive values');
                        credFactors.add('Climate action');
                        break;
                    case 'Senior citizens':
                        styles.push('respectful and clear');
                        credFactors.add('Healthcare expertise');
                        credFactors.add('Social security protection');
                        break;
                    case 'Undecided voters':
                        styles.push('balanced and non-partisan');
                        credFactors.add('Independent thinking');
                        credFactors.add('Common sense solutions');
                        break;
                    case 'Campaign supporters':
                        styles.push('passionate and motivational');
                        credFactors.add('Shared values');
                        credFactors.add('Campaign commitment');
                        break;
                    default:
                        styles.push('conversational and relatable');
                        credFactors.add('Local connection');
                        credFactors.add('Community service');
                }
            });

            // Combine communication styles intelligently
            if (styles.length === 1) {
                insights.communicationStyle = styles[0].charAt(0).toUpperCase() + styles[0].slice(1);
            } else if (styles.length === 2) {
                insights.communicationStyle = `Blend of ${styles[0]} with ${styles[1]}`;
            } else {
                insights.communicationStyle = `Multi-faceted approach: ${styles.join(', ')}`;
            }

            insights.credibilityFactors = Array.from(credFactors).slice(0, 4);

            // Emotional approach
            switch (profile.emotionalState) {
                case 'Frustrated and angry':
                    insights.emotionalApproach = 'Acknowledge frustration, channel anger into action, provide clear solutions';
                    break;
                case 'Worried and anxious':
                    insights.emotionalApproach = 'Provide reassurance, offer concrete plans, emphasize stability';
                    break;
                case 'Hopeful but cautious':
                    insights.emotionalApproach = 'Build on hope, address caution with specifics, show realistic progress';
                    break;
                case 'Skeptical and distrustful':
                    insights.emotionalApproach = 'Acknowledge skepticism, provide evidence, demonstrate transparency';
                    break;
                default:
                    insights.emotionalApproach = 'Match their energy, be authentic, focus on shared values';
            }

            // Key messages based on care-abouts
            profile.caresAbout.forEach(care => {
                switch (care) {
                    case 'Healthcare':
                        insights.keyMessages.push('Affordable, accessible healthcare for everyone');
                        break;
                    case 'Jobs and economy':
                        insights.keyMessages.push('Good-paying jobs and economic opportunity');
                        break;
                    case 'Education':
                        insights.keyMessages.push('Quality education and opportunity for all children');
                        break;
                    case 'Public safety':
                        insights.keyMessages.push('Safe communities through smart, fair approaches');
                        break;
                    case 'Housing costs':
                        insights.keyMessages.push('Affordable housing solutions for working families');
                        break;
                    case 'Climate and environment':
                        insights.keyMessages.push('Clean energy jobs and environmental protection');
                        break;
                }
            });

            return insights;
        }

        function showAudienceInsights(profile, insights) {
            const toast = document.createElement('div');
            toast.className = 'insights-toast';
            toast.innerHTML = `
                <div class="insights-content">
                    <h3>🎯 Audience Analysis Complete</h3>
                    <div class="insight-item">
                        <strong>Primary Audience:</strong> ${profile.audience}
                    </div>
                    <div class="insight-item">
                        <strong>Top Concerns:</strong> ${profile.caresAbout.slice(0, 2).join(', ')}
                    </div>
                    <div class="insight-item">
                        <strong>Communication Style:</strong> ${insights.communicationStyle}
                    </div>
                    <div class="insight-item">
                        <strong>Emotional Approach:</strong> ${insights.emotionalApproach}
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="close-insights">✓ Got it</button>
                </div>
            `;

            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border-radius: 12px;
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
                z-index: 3000;
                max-width: 500px;
                animation: slideUp 0.5s ease;
            `;

            const style = document.createElement('style');
            style.textContent = `
                .insights-content {
                    padding: 24px;
                }
                .insights-content h3 {
                    margin: 0 0 16px 0;
                    color: #059669;
                    font-size: 18px;
                }
                .insight-item {
                    margin: 12px 0;
                    padding: 8px 0;
                    border-bottom: 1px solid #f3f4f6;
                    font-size: 14px;
                }
                .insight-item strong {
                    color: #374151;
                    display: block;
                    margin-bottom: 4px;
                }
                .close-insights {
                    background: #059669;
                    color: white;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 6px;
                    cursor: pointer;
                    margin-top: 16px;
                    font-weight: 500;
                }
            `;

            document.head.appendChild(style);
            document.body.appendChild(toast);

            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 8000);

            showToast('🎯 Audience understanding captured! Now define your big idea.', 'success');
        }

        function defineBigIdea() {
            showBigIdeaDialog();
        }

        function showBigIdeaDialog() {
            // Get stored audience profile for context
            const audienceProfile = JSON.parse(localStorage.getItem('audienceProfile') || '{}');
            const insights = JSON.parse(localStorage.getItem('audienceInsights') || '{}');

            const modal = document.createElement('div');
            modal.className = 'workflow-modal';
            modal.innerHTML = `
                <div class="workflow-modal-content">
                    <div class="workflow-header">
                        <h2>💡 Step 2: Define Your Big Idea</h2>
                        <p>What's the ONE thing you want your audience to remember and act on?</p>
                        <button onclick="this.closest('.workflow-modal').remove()" class="close-btn">✕</button>
                    </div>

                    <div class="workflow-form">
                        ${audienceProfile.audience ? `
                        <div class="context-section">
                            <h4>📊 Your Audience Context</h4>
                            <div class="context-grid">
                                <div class="context-item">
                                    <strong>Audience:</strong> ${audienceProfile.audience}
                                </div>
                                <div class="context-item">
                                    <strong>Top Concerns:</strong> ${audienceProfile.caresAbout ? audienceProfile.caresAbout.slice(0, 2).join(', ') : 'Not specified'}
                                </div>
                                <div class="context-item">
                                    <strong>Emotional State:</strong> ${audienceProfile.emotionalState || 'Not specified'}
                                </div>
                            </div>
                        </div>
                        ` : ''}

                        <div class="form-section">
                            <label>🎯 What type of message are you trying to deliver?</label>
                            <div class="choice-group">
                                <label><input type="radio" name="message-type" value="Action/Policy"> Call for specific action or policy</label>
                                <label><input type="radio" name="message-type" value="Vision"> Vision of a better future</label>
                                <label><input type="radio" name="message-type" value="Problem-solving"> Solution to a current problem</label>
                                <label><input type="radio" name="message-type" value="Unity"> Bringing people together</label>
                                <label><input type="radio" name="message-type" value="Change"> Need for change</label>
                                <label><input type="radio" name="message-type" value="Support"> Building support for something</label>
                                <label><input type="radio" name="message-type" value="Other"> Other: <input type="text" id="message-type-other" placeholder="Specify..."></label>
                            </div>
                        </div>

                        <div class="form-section">
                            <label>💎 Your Big Idea (Complete this sentence)</label>
                            <div class="big-idea-constructor">
                                <div class="constructor-row">
                                    <span class="constructor-label">We can</span>
                                    <input type="text" id="action-verb" placeholder="achieve, create, build, improve, solve..." style="width: 150px;">
                                    <input type="text" id="what-outcome" placeholder="what outcome/result?" style="flex: 1;">
                                </div>
                                <div class="constructor-row">
                                    <span class="constructor-label">by</span>
                                    <input type="text" id="how-method" placeholder="what specific method/action?" style="flex: 1;">
                                </div>
                                <div class="constructor-row">
                                    <span class="constructor-label">which will</span>
                                    <input type="text" id="benefit" placeholder="what benefit for the audience?" style="flex: 1;">
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <label>📋 Or choose from suggested ideas based on your audience:</label>
                            <div class="suggested-ideas" id="suggested-ideas">
                                ${generateSuggestedIdeas(audienceProfile).map((idea, index) => `
                                    <div class="suggested-idea" onclick="selectSuggestedIdea('${idea}')">
                                        <span class="idea-icon">💡</span>
                                        <span class="idea-text">${idea}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="form-section">
                            <label>🎯 What specific action do you want your audience to take?</label>
                            <div class="choice-group">
                                <label><input type="checkbox" name="actions" value="Vote for me"> Vote for me/my cause</label>
                                <label><input type="checkbox" name="actions" value="Contact officials"> Contact their representatives</label>
                                <label><input type="checkbox" name="actions" value="Attend event"> Attend an event or meeting</label>
                                <label><input type="checkbox" name="actions" value="Volunteer"> Volunteer time</label>
                                <label><input type="checkbox" name="actions" value="Donate"> Make a donation</label>
                                <label><input type="checkbox" name="actions" value="Share message"> Share the message with others</label>
                                <label><input type="checkbox" name="actions" value="Sign petition"> Sign a petition</label>
                                <input type="text" id="actions-other" placeholder="Other specific action...">
                            </div>
                        </div>

                        <div class="form-actions">
                            <button onclick="processBigIdea()" class="btn-primary">🚀 Create Big Idea</button>
                            <button onclick="this.closest('.workflow-modal').remove()" class="btn-secondary">Cancel</button>
                        </div>
                    </div>
                </div>
            `;

            // Add additional styles for Big Idea dialog
            if (!document.getElementById('big-idea-styles')) {
                const style = document.createElement('style');
                style.id = 'big-idea-styles';
                style.textContent = `
                    .context-section {
                        background: #f0f9ff;
                        border: 1px solid #0ea5e9;
                        border-radius: 8px;
                        padding: 16px;
                        margin-bottom: 24px;
                    }
                    .context-section h4 {
                        margin: 0 0 12px 0;
                        color: #0c4a6e;
                        font-size: 14px;
                    }
                    .context-grid {
                        display: grid;
                        gap: 8px;
                    }
                    .context-item {
                        font-size: 13px;
                        color: #0c4a6e;
                    }
                    .context-item strong {
                        color: #075985;
                    }
                    .big-idea-constructor {
                        background: #fefbeb;
                        border: 2px solid #f59e0b;
                        border-radius: 8px;
                        padding: 20px;
                        margin-top: 8px;
                    }
                    .constructor-row {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        margin-bottom: 12px;
                    }
                    .constructor-row:last-child {
                        margin-bottom: 0;
                    }
                    .constructor-label {
                        font-weight: 600;
                        color: #92400e;
                        min-width: 60px;
                        font-size: 14px;
                    }
                    .constructor-row input {
                        padding: 8px 12px;
                        border: 1px solid #d1d5db;
                        border-radius: 4px;
                        font-size: 14px;
                    }
                    .constructor-row input:focus {
                        outline: none;
                        border-color: #f59e0b;
                        box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.1);
                    }
                    .suggested-ideas {
                        display: grid;
                        gap: 8px;
                        margin-top: 8px;
                    }
                    .suggested-idea {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 12px;
                        border: 1px solid #e5e7eb;
                        border-radius: 6px;
                        cursor: pointer;
                        transition: all 0.2s;
                        background: white;
                    }
                    .suggested-idea:hover {
                        border-color: #3b82f6;
                        background: #f0f9ff;
                    }
                    .idea-icon {
                        font-size: 18px;
                    }
                    .idea-text {
                        flex: 1;
                        font-size: 14px;
                        color: #374151;
                    }
                    .suggested-idea.selected {
                        border-color: #10b981;
                        background: #ecfdf5;
                    }
                `;
                document.head.appendChild(style);
            }

            document.body.appendChild(modal);

            // Handle "Other" message type
            const otherRadio = modal.querySelector('input[value="Other"]');
            const otherText = modal.querySelector('#message-type-other');

            if (otherRadio && otherText) {
                otherRadio.addEventListener('change', () => {
                    if (otherRadio.checked) {
                        otherText.focus();
                    }
                });

                otherText.addEventListener('input', () => {
                    if (otherText.value) {
                        otherRadio.checked = true;
                    }
                });
            }

            // Auto-combine constructor inputs
            const constructorInputs = modal.querySelectorAll('.constructor-row input');
            function updateBigIdea() {
                const action = modal.querySelector('#action-verb').value;
                const outcome = modal.querySelector('#what-outcome').value;
                const method = modal.querySelector('#how-method').value;
                const benefit = modal.querySelector('#benefit').value;

                if (action && outcome && method) {
                    let bigIdea = `We can ${action} ${outcome} by ${method}`;
                    if (benefit) {
                        bigIdea += `, which will ${benefit}`;
                    }
                    // Store partially constructed idea
                    modal.constructedIdea = bigIdea;
                }
            }

            constructorInputs.forEach(input => {
                input.addEventListener('input', updateBigIdea);
            });
        }

        function generateSuggestedIdeas(profile) {
            const ideas = [];

            if (!profile.audience) {
                return [
                    "We can create good-paying jobs by investing in local businesses and infrastructure",
                    "We can improve healthcare access by expanding community health centers",
                    "We can make housing affordable by building more homes and protecting renters"
                ];
            }

            // Generate ideas based on audience and their concerns
            const concerns = profile.caresAbout || [];

            if (concerns.includes('Healthcare')) {
                ideas.push("We can guarantee healthcare for all by creating a public option that covers everyone");
                ideas.push("We can lower prescription costs by allowing Medicare to negotiate drug prices");
            }

            if (concerns.includes('Jobs and economy')) {
                ideas.push("We can create 50,000 good-paying jobs by investing in clean energy manufacturing");
                ideas.push("We can strengthen our economy by supporting small businesses and entrepreneurs");
            }

            if (concerns.includes('Education')) {
                ideas.push("We can ensure every child gets a quality education by fully funding our schools");
                ideas.push("We can make college affordable by expanding financial aid and reducing student debt");
            }

            if (concerns.includes('Housing costs')) {
                ideas.push("We can solve the housing crisis by building affordable homes and protecting renters");
                ideas.push("We can help families buy homes by providing down payment assistance");
            }

            if (concerns.includes('Climate and environment')) {
                ideas.push("We can fight climate change while creating jobs through clean energy investment");
                ideas.push("We can protect our environment by transitioning to renewable energy");
            }

            if (concerns.includes('Public safety')) {
                ideas.push("We can make communities safer by investing in community policing and prevention");
                ideas.push("We can reduce crime by addressing root causes like poverty and lack of opportunity");
            }

            // Ensure we have at least 3 suggestions
            if (ideas.length < 3) {
                ideas.push("We can build a stronger community by bringing people together around shared values");
                ideas.push("We can create lasting change by empowering local voices and grassroots action");
                ideas.push("We can solve our biggest challenges by working together across party lines");
            }

            return ideas.slice(0, 5); // Limit to 5 suggestions
        }

        function selectSuggestedIdea(idea) {
            const modal = document.querySelector('.workflow-modal');

            // Clear other selections
            modal.querySelectorAll('.suggested-idea').forEach(item => {
                item.classList.remove('selected');
            });

            // Mark this one as selected
            event.target.closest('.suggested-idea').classList.add('selected');

            // Store the selected idea
            modal.selectedIdea = idea;

            // Clear constructor inputs since they're using a pre-made idea
            modal.querySelectorAll('.constructor-row input').forEach(input => {
                input.value = '';
            });
        }

        function processBigIdea() {
            const modal = document.querySelector('.workflow-modal');

            // Get message type
            const messageTypeRadio = modal.querySelector('input[name="message-type"]:checked');
            let messageType = '';
            if (messageTypeRadio) {
                if (messageTypeRadio.value === 'Other') {
                    messageType = modal.querySelector('#message-type-other').value || 'Not specified';
                } else {
                    messageType = messageTypeRadio.value;
                }
            }

            // Get big idea (either constructed or selected)
            let bigIdea = '';
            if (modal.selectedIdea) {
                bigIdea = modal.selectedIdea;
            } else if (modal.constructedIdea) {
                bigIdea = modal.constructedIdea;
            } else {
                // Try to construct from individual fields
                const action = modal.querySelector('#action-verb').value;
                const outcome = modal.querySelector('#what-outcome').value;
                const method = modal.querySelector('#how-method').value;
                const benefit = modal.querySelector('#benefit').value;

                if (action && outcome && method) {
                    bigIdea = `We can ${action} ${outcome} by ${method}`;
                    if (benefit) {
                        bigIdea += `, which will ${benefit}`;
                    }
                }
            }

            // Get desired actions
            const actionsChecked = Array.from(modal.querySelectorAll('input[name="actions"]:checked'))
                .map(cb => cb.value);
            const actionsOther = modal.querySelector('#actions-other').value;
            if (actionsOther) actionsChecked.push(actionsOther);

            // Validation
            if (!messageType) {
                showToast('❌ Please select your message type', 'error');
                return;
            }

            if (!bigIdea) {
                showToast('❌ Please create your big idea using the constructor or select a suggestion', 'error');
                return;
            }

            if (actionsChecked.length === 0) {
                showToast('❌ Please select what action you want your audience to take', 'error');
                return;
            }

            // Create big idea profile
            const bigIdeaProfile = {
                messageType: messageType,
                bigIdea: bigIdea,
                desiredActions: actionsChecked,
                timestamp: new Date().toISOString()
            };

            // Store data
            localStorage.setItem('bigIdeaProfile', JSON.stringify(bigIdeaProfile));

            // Close modal
            modal.remove();

            // Mark complete and show results
            markStepComplete(2);
            showBigIdeaResult(bigIdeaProfile);

            setTimeout(() => toggleWorkflowStep(3), 2000);
        }

        function showBigIdeaResult(profile) {
            const toast = document.createElement('div');
            toast.className = 'insights-toast';
            toast.innerHTML = `
                <div class="insights-content">
                    <h3>💡 Big Idea Defined</h3>
                    <div class="insight-item">
                        <strong>Message Type:</strong> ${profile.messageType}
                    </div>
                    <div class="insight-item big-idea-text">
                        <strong>Your Big Idea:</strong><br>
                        "${profile.bigIdea}"
                    </div>
                    <div class="insight-item">
                        <strong>Call to Action:</strong> ${profile.desiredActions.join(', ')}
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="close-insights">✓ Perfect</button>
                </div>
            `;

            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border-radius: 12px;
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
                z-index: 3000;
                max-width: 600px;
                animation: slideUp 0.5s ease;
            `;

            // Add special styling for big idea text
            const style = document.createElement('style');
            style.textContent = `
                .big-idea-text {
                    background: #fef3c7;
                    padding: 12px;
                    border-radius: 6px;
                    border-left: 4px solid #f59e0b;
                    font-style: italic;
                }
                .big-idea-text strong {
                    color: #92400e;
                }
            `;
            document.head.appendChild(style);

            document.body.appendChild(toast);

            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 10000);

            showToast('💡 Big Idea defined! Now create your flow structure.', 'success');
        }

        function markStepComplete(stepNumber) {
            const status = document.getElementById(`step-${stepNumber}-status`);
            if (status) {
                status.textContent = '✓';
                status.classList.add('completed');
            }
        }

        // Make functions globally accessible for onclick handlers
        window.newSpeech = newSpeech;
        window.saveSpeech = saveSpeech;
        window.openDashboard = openDashboard;
        window.updateMetadata = updateMetadata;
        window.switchView = switchView;
        window.startScroll = startScroll;
        window.pauseScroll = pauseScroll;
        window.resetScroll = resetScroll;
        window.adjustSpeed = adjustSpeed;
        window.toggleCoachingTips = toggleCoachingTips;
        window.toggleTextToSpeech = toggleTextToSpeech;
        window.setupTeleprompterKeyboard = setupTeleprompterKeyboard;
        window.copySection = copySection;
        window.deleteSection = deleteSection;
        window.addNewSection = addNewSection;
        // ============ COMMUNICATIONS BRIEF INTEGRATION ============

        function checkForCommunicationsBrief() {
            const briefData = localStorage.getItem('currentCommunicationsBrief');
            if (briefData) {
                const brief = JSON.parse(briefData);
                displayCommunicationsBrief(brief);
                // Clear the brief data so it doesn't show again
                localStorage.removeItem('currentCommunicationsBrief');
            }
        }

        function displayCommunicationsBrief(brief) {
            // Create a prominent brief display banner
            const briefBanner = document.createElement('div');
            briefBanner.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: linear-gradient(135deg, #3b82f6, #8b5cf6);
                color: white;
                padding: 16px 20px;
                z-index: 1000;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                transform: translateY(-100%);
                transition: transform 0.5s ease;
            `;

            briefBanner.innerHTML = `
                <div style="max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 4px;">
                            📋 Communications Brief: ${brief.title}
                        </div>
                        <div style="font-size: 14px; opacity: 0.9;">
                            From: ${brief.createdBy} | Due: ${brief.dueDate ? new Date(brief.dueDate).toLocaleDateString() : 'No due date'}
                        </div>
                    </div>
                    <div>
                        <button onclick="showBriefDetails()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-right: 8px;">
                            📝 View Brief
                        </button>
                        <button onclick="dismissBrief()" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer;">×</button>
                    </div>
                </div>
            `;

            document.body.appendChild(briefBanner);

            // Store brief data globally
            window.currentBrief = brief;

            // Animate in
            setTimeout(() => {
                briefBanner.style.transform = 'translateY(0)';
                document.body.style.paddingTop = '80px';
            }, 100);

            // Auto-show details after 2 seconds
            setTimeout(() => {
                showBriefDetails();
            }, 2000);
        }

        function showBriefDetails() {
            if (!window.currentBrief) return;

            const brief = window.currentBrief;
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1001;
                opacity: 0;
                transition: opacity 0.3s;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto; position: relative;">
                    <div style="padding: 24px 24px 16px; border-bottom: 1px solid #e5e7eb;">
                        <h2 style="margin: 0 0 8px; color: #1f2937; display: flex; align-items: center; gap: 12px;">
                            📋 Communications Brief
                        </h2>
                        <h3 style="margin: 0; color: #3b82f6; font-size: 20px;">${brief.title}</h3>
                        <p style="margin: 8px 0 0; color: #6b7280; font-size: 14px;">
                            From: ${brief.createdBy} • Due: ${brief.dueDate ? new Date(brief.dueDate).toLocaleDateString() : 'No due date'}
                        </p>
                    </div>

                    <div style="padding: 24px;">
                        ${brief.description ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #374151; margin: 0 0 8px; font-size: 16px;">📝 Description</h4>
                                <p style="margin: 0; color: #6b7280; line-height: 1.5;">${brief.description}</p>
                            </div>
                        ` : ''}

                        ${brief.audience ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #374151; margin: 0 0 8px; font-size: 16px;">👥 Target Audience</h4>
                                <p style="margin: 0; color: #6b7280; line-height: 1.5;">${brief.audience}</p>
                            </div>
                        ` : ''}

                        ${brief.tone ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #374151; margin: 0 0 8px; font-size: 16px;">🎭 Tone & Style</h4>
                                <p style="margin: 0; color: #6b7280; line-height: 1.5;">${brief.tone}</p>
                            </div>
                        ` : ''}

                        ${brief.keyPoints ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #374151; margin: 0 0 8px; font-size: 16px;">🎯 Key Messages & Themes</h4>
                                <div style="margin: 0; color: #6b7280; line-height: 1.5; white-space: pre-wrap;">${brief.keyPoints}</div>
                            </div>
                        ` : ''}

                        ${brief.context ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #374151; margin: 0 0 8px; font-size: 16px;">📖 Context & Background</h4>
                                <div style="margin: 0; color: #6b7280; line-height: 1.5; white-space: pre-wrap;">${brief.context}</div>
                            </div>
                        ` : ''}
                    </div>

                    <div style="padding: 16px 24px; border-top: 1px solid #e5e7eb; display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" style="padding: 8px 16px; border: 1px solid #d1d5db; background: white; color: #374151; border-radius: 6px; cursor: pointer;">
                            Close
                        </button>
                        <button onclick="startSpeechFromBrief(); this.closest('div[style*=\"position: fixed\"]').remove();" style="padding: 8px 16px; border: none; background: #3b82f6; color: white; border-radius: 6px; cursor: pointer;">
                            ✨ Start Writing
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            setTimeout(() => modal.style.opacity = '1', 50);

            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function startSpeechFromBrief() {
            if (!window.currentBrief) return;

            const brief = window.currentBrief;

            // Create a starter template based on the brief
            let speechStarter = '';

            if (brief.description) {
                speechStarter += `SPEECH BRIEF: ${brief.description}\n\n`;
            }

            if (brief.audience) {
                speechStarter += `AUDIENCE: ${brief.audience}\n`;
            }

            if (brief.tone) {
                speechStarter += `TONE: ${brief.tone}\n`;
            }

            speechStarter += `\n--- BEGIN SPEECH ---\n\n`;

            if (brief.keyPoints) {
                speechStarter += `Key Messages to Cover:\n${brief.keyPoints}\n\n`;
            }

            speechStarter += `[Start writing your speech here. Use the key messages above as your guide.]\n\n`;

            // Set the speech content
            const speechInput = document.getElementById('speech-input');
            speechInput.value = speechStarter;
            speechData.raw = speechStarter;

            // Process the content
            handleSpeechInput();
            showMetadataSection();

            // Show a success message
            showToast('Speech template created from brief! You can now start writing.', 'success');
        }

        function dismissBrief() {
            const banner = document.querySelector('div[style*="position: fixed"][style*="background: linear-gradient"]');
            if (banner) {
                banner.style.transform = 'translateY(-100%)';
                document.body.style.paddingTop = '0';
                setTimeout(() => banner.remove(), 500);
            }
            window.currentBrief = null;
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                color: white;
                font-size: 14px;
                z-index: 10000;
                opacity: 0;
                transition: opacity 0.3s;
                max-width: 400px;
            `;

            if (type === 'success') {
                toast.style.background = '#10b981';
            } else if (type === 'error') {
                toast.style.background = '#ef4444';
            } else {
                toast.style.background = '#3b82f6';
            }

            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.style.opacity = '1', 100);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 4000);
        }

        // Make functions globally available
        window.showBriefDetails = showBriefDetails;
        window.startSpeechFromBrief = startSpeechFromBrief;
        window.dismissBrief = dismissBrief;

        window.exportWordPress = exportWordPress;
        window.analyzeStoryStructure = analyzeStoryStructure;
        window.useStoryTemplate = useStoryTemplate;
        window.toggleWorkflowStep = toggleWorkflowStep;
        window.startEmpathyWalk = startEmpathyWalk;
        window.defineBigIdea = defineBigIdea;
    </script>
</body>
</html>