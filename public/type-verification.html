<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Release Type Verification</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .progress {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #4CAF50;
            transition: width 0.3s;
        }

        .progress-text {
            color: #666;
            font-size: 14px;
            white-space: nowrap;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
        }

        .document-panel, .verification-panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .panel-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            color: #333;
        }

        .document-content {
            padding: 20px;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
            color: #333;
        }

        .verification-content {
            padding: 20px;
        }

        .field-group {
            margin-bottom: 20px;
        }

        .field-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }

        .field-group select, .field-group input, .field-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        .field-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .detected-info {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .detected-info .label {
            font-weight: 600;
            color: #666;
            margin-bottom: 5px;
        }

        .detected-info .value {
            color: #333;
        }

        .confidence-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .confidence-high { background: #d4edda; color: #155724; }
        .confidence-medium { background: #fff3cd; color: #856404; }
        .confidence-low { background: #f8d7da; color: #721c24; }
        .confidence-none { background: #e2e3e5; color: #6c757d; }

        .indicators-list {
            margin-top: 8px;
            padding-left: 20px;
        }

        .indicators-list li {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .scores-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .score-item {
            background: #fff;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            font-size: 12px;
        }

        .score-label {
            font-weight: 600;
            color: #666;
        }

        .score-value {
            color: #333;
            float: right;
        }

        .nav-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            padding: 12px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-export {
            background: #007bff;
            color: white;
            margin-top: 10px;
        }

        .btn-export:hover {
            background: #0069d9;
        }

        .verified-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .verified-yes { background: #4CAF50; }
        .verified-no { background: #ccc; }

        select option {
            padding: 8px;
        }

        .subtype-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #007bff;
            color: white;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 13px;
            font-weight: 500;
        }

        .subtype-tag button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .subtype-tag button:hover {
            background: rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Press Release Type Verification</h1>
            <p style="color: #666; margin-top: 5px;">Review and correct detected release types (real press releases only)</p>
            <div class="progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">0 / 0 reviewed</div>
            </div>
        </header>

        <div class="main-grid">
            <!-- Left panel: Document text -->
            <div class="document-panel">
                <div class="panel-header">
                    <span class="verified-indicator" id="verifiedIndicator"></span>
                    <span id="fileNameDisplay">No file selected</span>
                </div>
                <div class="document-content" id="documentContent">
                    Loading...
                </div>
            </div>

            <!-- Right panel: Type verification -->
            <div class="verification-panel">
                <div class="panel-header">Type Verification</div>
                <div class="verification-content">
                    <!-- Detected type info -->
                    <div class="detected-info">
                        <div class="label">Detected Type</div>
                        <div class="value">
                            <strong id="detectedType">-</strong>
                            <span class="confidence-badge" id="confidenceBadge">-</span>
                        </div>
                        <div class="label" style="margin-top: 10px;">Score: <span id="detectedScore">-</span></div>
                    </div>

                    <!-- Indicators -->
                    <div class="detected-info" id="indicatorsSection" style="display: none;">
                        <div class="label">Detection Indicators</div>
                        <ul class="indicators-list" id="indicatorsList"></ul>
                    </div>

                    <!-- All scores -->
                    <div class="detected-info" id="scoresSection" style="display: none;">
                        <div class="label">All Type Scores</div>
                        <div class="scores-grid" id="scoresGrid"></div>
                    </div>

                    <!-- Verification fields -->
                    <div class="field-group">
                        <label for="correctedType">Correct Type</label>
                        <select id="correctedType">
                            <option value="">-- Select Type --</option>
                            <option value="STATEMENT">STATEMENT - Released statement format</option>
                            <option value="NEWS_RELEASE">NEWS_RELEASE - Traditional news release</option>
                            <option value="MEDIA_ADVISORY">MEDIA_ADVISORY - Event announcement</option>
                            <option value="LETTER">LETTER - Letter format</option>
                            <option value="TRANSCRIPT">TRANSCRIPT - Speech/Q&A transcript</option>
                            <option value="FACT_SHEET">FACT_SHEET - Bullet points/data</option>
                            <option value="UNKNOWN">UNKNOWN - Cannot classify</option>
                        </select>
                    </div>

                    <div class="field-group">
                        <label for="subtypesContainer">Subtypes (select multiple)</label>
                        <div id="subtypesContainer" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; min-height: 40px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;">
                            <!-- Subtype tags will be added here -->
                        </div>
                        <select id="subtypeSelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">-- Add subtype --</option>
                            <option value="campaign_launch">Campaign Launch</option>
                            <option value="endorsement">Endorsement</option>
                            <option value="policy_announcement">Policy Announcement</option>
                            <option value="response_opposition">Response to Opposition</option>
                            <option value="fundraising">Fundraising</option>
                            <option value="event_announcement">Event Announcement</option>
                            <option value="milestone">Campaign Milestone</option>
                            <option value="crisis_response">Crisis Response</option>
                            <option value="legislative_action">Legislative Action</option>
                            <option value="debate">Debate Related</option>
                            <option value="attack">Attack on Opponent</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="field-group">
                        <label for="issuesContainer">Issue(s) (select multiple)</label>
                        <div id="issuesContainer" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; min-height: 40px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;">
                            <!-- Issue tags will be added here -->
                        </div>
                        <select id="issueSelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px;">
                            <option value="">-- Add issue/topic --</option>
                            <optgroup label="Domestic Policy">
                                <option value="healthcare">Healthcare</option>
                                <option value="education">Education</option>
                                <option value="economy_jobs">Economy/Jobs</option>
                                <option value="taxes">Taxes/Tax Policy</option>
                                <option value="social_security">Social Security/Medicare</option>
                                <option value="housing">Housing/Affordability</option>
                                <option value="infrastructure">Infrastructure/Transportation</option>
                                <option value="climate_environment">Climate/Environment</option>
                                <option value="energy">Energy Policy</option>
                            </optgroup>
                            <optgroup label="Rights & Justice">
                                <option value="immigration">Immigration</option>
                                <option value="criminal_justice">Criminal Justice</option>
                                <option value="gun_control">Gun Control</option>
                                <option value="reproductive_rights">Reproductive Rights</option>
                                <option value="voting_rights">Voting Rights/Democracy</option>
                                <option value="civil_rights">Civil Rights/Equality</option>
                                <option value="lgbtq_rights">LGBTQ+ Rights</option>
                            </optgroup>
                            <optgroup label="Governance">
                                <option value="government_shutdown">Government Shutdown/Budget</option>
                                <option value="corruption_ethics">Corruption/Ethics/Transparency</option>
                                <option value="campaign_finance">Campaign Finance</option>
                                <option value="government_accountability">Government Accountability</option>
                            </optgroup>
                            <optgroup label="Foreign Policy & Security">
                                <option value="foreign_policy">Foreign Policy (General)</option>
                                <option value="israel_palestine">Israel/Palestine</option>
                                <option value="china">China Relations</option>
                                <option value="russia_ukraine">Russia/Ukraine</option>
                                <option value="national_security">National Security/Defense</option>
                                <option value="veterans">Veterans Affairs</option>
                            </optgroup>
                            <optgroup label="Economic & Financial">
                                <option value="trade">Trade Policy</option>
                                <option value="cryptocurrency">Cryptocurrency/Financial Regulation</option>
                                <option value="banking">Banking/Financial Services</option>
                                <option value="labor">Labor/Workers Rights</option>
                                <option value="small_business">Small Business</option>
                            </optgroup>
                            <optgroup label="Technology & Media">
                                <option value="tech_regulation">Tech/Big Tech Regulation</option>
                                <option value="ai">Artificial Intelligence</option>
                                <option value="privacy">Privacy/Data Protection</option>
                                <option value="broadband">Broadband/Digital Access</option>
                            </optgroup>
                            <optgroup label="Other">
                                <option value="opponent_record">Opponent's Record/Attacks</option>
                                <option value="personal_background">Personal Background/Bio</option>
                                <option value="other">Other (specify below)</option>
                            </optgroup>
                        </select>
                        <input type="text" id="customIssue" placeholder="If 'Other', specify issue here..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; display: none;">
                    </div>

                    <div class="field-group">
                        <label for="notes">Notes / Feedback</label>
                        <textarea id="notes" placeholder="Describe what makes this type, patterns to detect, etc."></textarea>
                    </div>

                    <!-- Navigation buttons -->
                    <div class="nav-buttons">
                        <button class="btn-secondary" id="prevBtn">← Previous</button>
                        <button class="btn-primary" id="saveNextBtn">Save & Next →</button>
                        <button class="btn-secondary" id="skipBtn">Skip →</button>
                    </div>

                    <button class="btn-export" id="exportBtn">Export Corrections</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let examples = [];
        let currentIndex = 0;
        let verifications = {};
        let detectionResults = null;
        let currentSubtypes = []; // Array of current subtypes
        let currentIssues = []; // Array of current issues

        // Type-specific subtypes
        const subtypesByType = {
            'STATEMENT': [
                { value: 'response_statement', label: 'Response Statement' },
                { value: 'condemnation', label: 'Condemnation' },
                { value: 'support_statement', label: 'Support/Praise' },
                { value: 'policy_position', label: 'Policy Position' }
            ],
            'NEWS_RELEASE': [
                { value: 'campaign_announcement', label: 'Campaign Announcement' },
                { value: 'endorsement', label: 'Endorsement' },
                { value: 'response_opposition', label: 'Response to Opposition' },
                { value: 'policy_announcement', label: 'Policy Announcement' },
                { value: 'legislative_action', label: 'Legislative Action' },
                { value: 'funding_announcement', label: 'Funding Announcement' },
                { value: 'personnel_announcement', label: 'Personnel Announcement' },
                { value: 'poll_results', label: 'Poll/Survey Results' },
                // Attack subtypes
                { value: 'attack_policy', label: 'Attack: Policy-Based' },
                { value: 'attack_character', label: 'Attack: Character' },
                { value: 'attack_competence', label: 'Attack: Competence/Effectiveness' },
                { value: 'attack_values', label: 'Attack: Values/Identity' },
                { value: 'attack_association', label: 'Attack: Association' },
                { value: 'attack_hypocrisy', label: 'Attack: Hypocrisy' },
                { value: 'attack_ethics', label: 'Attack: Ethics/Corruption' },
                { value: 'attack_fear', label: 'Attack: Fear/Risk' },
                { value: 'attack_contrast', label: 'Attack: Contrast' },
                { value: 'attack_rapid_response', label: 'Attack: Rapid Response' }
            ],
            'MEDIA_ADVISORY': [
                { value: 'press_conference', label: 'Press Conference' },
                { value: 'photo_opportunity', label: 'Photo Opportunity' },
                { value: 'interview_availability', label: 'Interview Availability' },
                { value: 'event_announcement', label: 'Event Announcement' }
            ],
            'LETTER': [
                { value: 'call_to_action', label: 'Call to Action' },
                { value: 'inquiry_letter', label: 'Inquiry Letter' }
            ],
            'TRANSCRIPT': [
                { value: 'debate_transcript', label: 'Debate Transcript' },
                { value: 'interview_transcript', label: 'Interview Transcript' },
                { value: 'speech_transcript', label: 'Speech Transcript' }
            ],
            'FACT_SHEET': [
                { value: 'policy_brief', label: 'Policy Brief' },
                { value: 'data_summary', label: 'Data Summary' }
            ],
            'UNKNOWN': [
                { value: 'general', label: 'General/Unknown' }
            ]
        };

        // Load from localStorage on start
        function loadVerifications() {
            const saved = localStorage.getItem('type_verifications');
            if (saved) {
                verifications = JSON.parse(saved);
            }
        }

        // Save to localStorage
        function saveVerifications() {
            localStorage.setItem('type_verifications', JSON.stringify(verifications));
        }

        // Add subtype
        function addSubtype(subtype) {
            if (!subtype || currentSubtypes.includes(subtype)) return;
            currentSubtypes.push(subtype);
            renderSubtypes();
        }

        // Remove subtype
        function removeSubtype(subtype) {
            currentSubtypes = currentSubtypes.filter(s => s !== subtype);
            renderSubtypes();
        }

        // Render subtype tags
        function renderSubtypes() {
            const container = document.getElementById('subtypesContainer');
            if (currentSubtypes.length === 0) {
                container.innerHTML = '<span style="color: #999; font-size: 13px;">No subtypes selected</span>';
                return;
            }

            container.innerHTML = currentSubtypes.map(subtype => {
                const label = document.querySelector(`#subtypeSelect option[value="${subtype}"]`)?.textContent || subtype;
                return `
                    <div class="subtype-tag">
                        <span>${label}</span>
                        <button onclick="removeSubtype('${subtype}')" title="Remove">&times;</button>
                    </div>
                `;
            }).join('');
        }

        // Update subtype dropdown based on selected type
        function updateSubtypeOptions(releaseType) {
            const subtypeSelect = document.getElementById('subtypeSelect');
            const options = subtypesByType[releaseType] || [];

            // Clear existing options except the first one
            subtypeSelect.innerHTML = '<option value="">-- Add subtype --</option>';

            // Add type-specific options
            options.forEach(option => {
                const optionEl = document.createElement('option');
                optionEl.value = option.value;
                optionEl.textContent = option.label;
                subtypeSelect.appendChild(optionEl);
            });

            // Filter current subtypes to only valid ones for this type
            const validSubtypes = options.map(o => o.value);
            currentSubtypes = currentSubtypes.filter(st => validSubtypes.includes(st) || st === 'general');
            renderSubtypes();
        }

        // Add issue
        function addIssue(issue) {
            if (!issue) return;

            // Handle "other" option
            if (issue === 'other') {
                document.getElementById('customIssue').style.display = 'block';
                document.getElementById('customIssue').focus();
                return;
            }

            if (currentIssues.includes(issue)) return;
            currentIssues.push(issue);
            renderIssues();
        }

        // Add custom issue
        function addCustomIssue() {
            const customInput = document.getElementById('customIssue');
            const customValue = customInput.value.trim();
            if (!customValue) return;

            const customIssue = 'custom:' + customValue;
            if (!currentIssues.includes(customIssue)) {
                currentIssues.push(customIssue);
                renderIssues();
            }
            customInput.value = '';
            customInput.style.display = 'none';
        }

        // Remove issue
        function removeIssue(issue) {
            currentIssues = currentIssues.filter(i => i !== issue);
            renderIssues();
        }

        // Render issue tags
        function renderIssues() {
            const container = document.getElementById('issuesContainer');
            if (currentIssues.length === 0) {
                container.innerHTML = '<span style="color: #999; font-size: 13px;">No issues selected</span>';
                return;
            }

            container.innerHTML = currentIssues.map(issue => {
                let label;
                if (issue.startsWith('custom:')) {
                    label = issue.substring(7); // Remove 'custom:' prefix
                } else {
                    label = document.querySelector(`#issueSelect option[value="${issue}"]`)?.textContent || issue;
                }
                return `
                    <div class="subtype-tag">
                        <span>${label}</span>
                        <button onclick="removeIssue('${issue.replace(/'/g, "\\'")}')" title="Remove">&times;</button>
                    </div>
                `;
            }).join('');
        }

        // Fetch list of examples
        async function loadExamples() {
            try {
                console.log('Loading examples...');
                const response = await fetch('/api/parser/examples');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                console.log('Examples loaded:', data.examples.length);

                // Filter out hybrid files and Jane Smith fake examples (only keep real press releases)
                const allExamples = data.examples;
                examples = allExamples
                    .filter(f => !f.filename.startsWith('hybrid_') && !f.filename.startsWith('release_'))
                    .sort((a, b) => a.filename.localeCompare(b.filename));

                console.log(`Filtered to ${examples.length} real press releases (excluded ${allExamples.length - examples.length} synthetic files)`);

                // Load detection results
                console.log('Loading detection results...');
                const detectionResponse = await fetch('/type-detection-results.json');
                if (!detectionResponse.ok) throw new Error(`HTTP ${detectionResponse.status}`);
                detectionResults = await detectionResponse.json();
                console.log('Detection results loaded:', detectionResults.results.length);

                updateProgress();
                loadFile(0);
            } catch (error) {
                console.error('Error loading examples:', error);
                document.getElementById('documentContent').textContent = `Error loading examples: ${error.message}\n\nPlease check browser console for details.`;
            }
        }

        // Load specific file
        async function loadFile(index) {
            if (index < 0 || index >= examples.length) {
                console.error('Invalid index:', index, 'Examples length:', examples.length);
                return;
            }

            currentIndex = index;
            const file = examples[index];
            console.log('Loading file:', file.filename);

            try {
                // Load file content
                const response = await fetch(`/api/parser/examples/${file.filename}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();

                // Display file
                document.getElementById('fileNameDisplay').textContent = file.filename;
                document.getElementById('documentContent').textContent = data.content;

            // Find detection result
            const detection = detectionResults.results.find(r => r.file === file.filename);

            // Display detected type
            if (detection) {
                document.getElementById('detectedType').textContent = detection.type;
                document.getElementById('detectedScore').textContent = detection.score;

                const badge = document.getElementById('confidenceBadge');
                badge.textContent = detection.confidence.toUpperCase();
                badge.className = 'confidence-badge confidence-' + detection.confidence;

                // Show indicators
                if (detection.indicators && detection.indicators.length > 0) {
                    document.getElementById('indicatorsSection').style.display = 'block';
                    const list = document.getElementById('indicatorsList');
                    list.innerHTML = detection.indicators.map(ind => `<li>${ind}</li>`).join('');
                } else {
                    document.getElementById('indicatorsSection').style.display = 'none';
                }

                // Show all scores
                const scores = Object.entries(detection.all_scores).filter(([_, score]) => score > 0);
                if (scores.length > 0) {
                    document.getElementById('scoresSection').style.display = 'block';
                    const grid = document.getElementById('scoresGrid');
                    grid.innerHTML = scores.map(([type, score]) => `
                        <div class="score-item">
                            <span class="score-label">${type}</span>
                            <span class="score-value">${score}</span>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('scoresSection').style.display = 'none';
                }
            }

            // Load saved verification if exists
            const saved = verifications[file.filename];
            if (saved) {
                document.getElementById('correctedType').value = saved.correctedType || '';
                updateSubtypeOptions(saved.correctedType || (detection ? detection.type : ''));
                currentSubtypes = saved.subtypes || [];
                currentIssues = saved.issues || [];
                document.getElementById('notes').value = saved.notes || '';
                document.getElementById('verifiedIndicator').className = 'verified-indicator verified-yes';
            } else {
                // Pre-fill with detected type
                const detectedType = detection ? detection.type : '';
                document.getElementById('correctedType').value = detectedType;
                updateSubtypeOptions(detectedType);
                currentSubtypes = [];
                currentIssues = [];
                document.getElementById('notes').value = '';
                document.getElementById('verifiedIndicator').className = 'verified-indicator verified-no';
            }
            renderSubtypes();
            renderIssues();

            updateProgress();
            updateButtons();
            } catch (error) {
                console.error('Error loading file:', error);
                document.getElementById('documentContent').textContent = `Error loading file: ${error.message}`;
            }
        }

        // Save current verification
        async function saveCurrentVerification() {
            const file = examples[currentIndex];
            const detection = detectionResults.results.find(r => r.file === file.filename);

            const verificationData = {
                timestamp: new Date().toISOString(),
                detectedType: detection ? detection.type : 'UNKNOWN',
                detectedConfidence: detection ? detection.confidence : 'none',
                detectedScore: detection ? detection.score : 0,
                correctedType: document.getElementById('correctedType').value,
                subtypes: currentSubtypes, // Array of subtypes
                issues: currentIssues, // Array of issues
                notes: document.getElementById('notes').value,
                changed: document.getElementById('correctedType').value !== (detection ? detection.type : '')
            };

            verifications[file.filename] = verificationData;
            saveVerifications();

            // Also save to database
            try {
                const response = await fetch('/api/parser/type-verification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: file.filename,
                        detectedType: verificationData.detectedType,
                        detectedConfidence: verificationData.detectedConfidence,
                        detectedScore: verificationData.detectedScore,
                        correctedType: verificationData.correctedType,
                        subtypes: verificationData.subtypes,
                        issues: verificationData.issues,
                        notes: verificationData.notes
                    })
                });
                if (response.ok) {
                    console.log('✓ Saved to database:', file.filename);
                } else {
                    console.error('Failed to save to database:', await response.text());
                }
            } catch (error) {
                console.error('Error saving to database:', error);
            }
        }

        // Update progress bar
        function updateProgress() {
            const verified = Object.keys(verifications).length;
            const total = examples.length;
            const percentage = (verified / total) * 100;

            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${verified} / ${total} reviewed`;
        }

        // Update button states
        function updateButtons() {
            document.getElementById('prevBtn').disabled = currentIndex === 0;
            document.getElementById('saveNextBtn').disabled = currentIndex === examples.length - 1;
            document.getElementById('skipBtn').disabled = currentIndex === examples.length - 1;
        }

        // Export corrections
        function exportCorrections() {
            const data = {
                timestamp: new Date().toISOString(),
                total_files: examples.length,
                verified_count: Object.keys(verifications).length,
                verifications: verifications
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `type-verifications-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        // Event listeners
        document.getElementById('prevBtn').addEventListener('click', () => {
            if (currentIndex > 0) {
                loadFile(currentIndex - 1);
            }
        });

        document.getElementById('saveNextBtn').addEventListener('click', () => {
            saveCurrentVerification();
            if (currentIndex < examples.length - 1) {
                loadFile(currentIndex + 1);
            }
        });

        document.getElementById('skipBtn').addEventListener('click', () => {
            if (currentIndex < examples.length - 1) {
                loadFile(currentIndex + 1);
            }
        });

        document.getElementById('exportBtn').addEventListener('click', exportCorrections);

        // Type selection change - update subtype options
        document.getElementById('correctedType').addEventListener('change', (e) => {
            const selectedType = e.target.value;
            if (selectedType) {
                updateSubtypeOptions(selectedType);
            }
        });

        // Subtype selection
        document.getElementById('subtypeSelect').addEventListener('change', (e) => {
            if (e.target.value) {
                addSubtype(e.target.value);
                e.target.value = ''; // Reset dropdown
            }
        });

        // Issue selection
        document.getElementById('issueSelect').addEventListener('change', (e) => {
            if (e.target.value) {
                addIssue(e.target.value);
                e.target.value = ''; // Reset dropdown
            }
        });

        // Custom issue input
        document.getElementById('customIssue').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addCustomIssue();
            }
        });

        document.getElementById('customIssue').addEventListener('blur', () => {
            addCustomIssue();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft' && currentIndex > 0) {
                loadFile(currentIndex - 1);
            } else if (e.key === 'ArrowRight' && currentIndex < examples.length - 1) {
                saveCurrentVerification();
                loadFile(currentIndex + 1);
            }
        });

        // Initialize
        loadVerifications();
        loadExamples();
    </script>
</body>
</html>
