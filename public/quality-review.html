<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quality Control Dashboard - AI Categorization Review</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 20px 40px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .header-stats {
            display: flex;
            gap: 24px;
            font-size: 14px;
            color: #64748b;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-value {
            font-weight: 600;
            color: #0f172a;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px;
        }

        .filters {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .filter-row {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select, input[type="text"] {
            padding: 8px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 14px;
            min-width: 150px;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #cbd5e1;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .review-queue {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .review-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid #cbd5e1;
            display: flex;
            gap: 0;
            overflow: hidden;
        }

        .review-card.flagged {
            border-left-color: #f59e0b;
        }

        .review-card.low-confidence {
            border-left-color: #ef4444;
        }

        .review-left-panel {
            flex: 0 0 50%;
            padding: 24px;
            max-height: 800px;
            overflow-y: auto;
        }

        .panel-resizer {
            width: 4px;
            background: #cbd5e1;
            cursor: col-resize;
            position: relative;
            flex-shrink: 0;
        }

        .panel-resizer:hover {
            background: #3b82f6;
        }

        .panel-resizer:active {
            background: #2563eb;
        }

        .review-right-panel {
            flex: 1;
            padding: 24px;
            background: #f8fafc;
            max-height: 800px;
            overflow-y: auto;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 8px;
        }

        .card-meta {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            font-size: 13px;
            color: #64748b;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-red {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-orange {
            background: #fed7aa;
            color: #9a3412;
        }

        .badge-blue {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-green {
            background: #dcfce7;
            color: #166534;
        }

        .badge-purple {
            background: #e9d5ff;
            color: #6b21a8;
        }

        .content-preview {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 16px;
            margin: 16px 0;
            font-size: 14px;
            line-height: 1.8;
            white-space: pre-wrap;
            font-family: 'Georgia', serif;
        }

        .confidence-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .conf-high {
            background: #dcfce7;
            color: #166534;
        }

        .conf-medium {
            background: #fef3c7;
            color: #92400e;
        }

        .conf-low {
            background: #fee2e2;
            color: #991b1b;
        }

        .categorization-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #e2e8f0;
        }

        .cat-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 20px;
        }

        .cat-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .cat-label {
            font-size: 13px;
            font-weight: 600;
            color: #475569;
        }

        .ai-value {
            padding: 12px;
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 6px;
            font-size: 14px;
        }

        .tags-container {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .tag {
            padding: 6px 12px;
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 13px;
        }

        .tag.removable {
            cursor: pointer;
            position: relative;
            padding-right: 28px;
        }

        .tag.removable:hover {
            background: #fee2e2;
            border-color: #fca5a5;
        }

        .tag .remove {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
            color: #ef4444;
        }

        .add-tag-input {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .flags-section {
            margin-top: 16px;
            padding: 12px;
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 6px;
        }

        .flag-title {
            font-size: 13px;
            font-weight: 600;
            color: #92400e;
            margin-bottom: 8px;
        }

        .flag-item {
            font-size: 13px;
            color: #78350f;
            margin-left: 16px;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #e2e8f0;
        }

        .btn-approve {
            background: #10b981;
            color: white;
        }

        .btn-approve:hover {
            background: #059669;
        }

        .btn-needs-work {
            background: #f59e0b;
            color: white;
        }

        .btn-needs-work:hover {
            background: #d97706;
        }

        .reviewer-input {
            margin-left: auto;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .empty-state {
            text-align: center;
            padding: 80px 40px;
            background: white;
            border-radius: 12px;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .empty-state-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .empty-state-text {
            color: #64748b;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>🎯 Quality Control Dashboard</h1>
            <p style="font-size: 13px; color: #64748b; margin-top: 4px;">AI Categorization Quality Review - Low Confidence, Flagged Issues & Random Sampling</p>
        </div>
        <div class="header-stats">
            <div class="stat-item">
                <span>Needs Review:</span>
                <span class="stat-value" id="queue-count" style="color: #f59e0b;">-</span>
            </div>
            <div class="stat-item">
                <span>Verified:</span>
                <span class="stat-value" id="reviewed-count" style="color: #10b981;">-</span>
            </div>
            <div class="stat-item">
                <span>Flagged Issues:</span>
                <span class="stat-value" id="flagged-count" style="color: #ef4444;">-</span>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label>QC Filter</label>
                    <select id="filter-type" onchange="loadReviewQueue()">
                        <option value="needs_review">🎯 Smart Queue (Low Conf + Flags + Auto)</option>
                        <option value="flagged">⚠️ Flagged Issues Only</option>
                        <option value="low_confidence">📊 Low Confidence Only (&lt;85%)</option>
                        <option value="random_sample">🎲 Random Sample (10%)</option>
                        <option value="all_unreviewed">📋 All Unreviewed</option>
                        <option value="all">📁 All Releases</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Reviewer Name</label>
                    <input type="text" id="reviewer-name" placeholder="Your name" value="" />
                </div>
                <button class="btn btn-primary" onclick="loadReviewQueue()">Refresh Queue</button>
                <button class="btn btn-secondary" onclick="exportReviewData()">Export CSV</button>
            </div>
        </div>

        <!-- QC Info Panel -->
        <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 16px; margin-bottom: 24px; display: flex; gap: 12px; align-items: start;">
            <div style="font-size: 20px;">ℹ️</div>
            <div style="flex: 1;">
                <div style="font-weight: 600; color: #1e40af; margin-bottom: 4px;">Quality Control Dashboard</div>
                <div style="font-size: 13px; color: #1e40af; line-height: 1.6;">
                    This dashboard surfaces releases that need quality review: <strong>low confidence scores (&lt;85%)</strong>,
                    <strong>flagged categorization issues</strong> (ICYMI mismatches, missing tags, false positives),
                    <strong>all auto-categorized releases</strong>, plus <strong>random samples</strong> for ongoing quality checks.
                    Reviews are tracked with your name and timestamps.
                </div>
            </div>
        </div>

        <div id="review-queue" class="review-queue">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>

    <script>
        // Available options for dropdowns
        const RELEASE_TYPES = [
            'policy_position', 'campaign_announcement', 'endorsement', 'attack_ad',
            'response_statement', 'media_appearance', 'event_announcement',
            'coalition_building', 'legislative_action'
        ];

        const RELEASE_SUBTYPES = [
            'contrast', 'fact_check', 'rapid_response', 'coalition_building',
            'grassroots_mobilization', 'media_strategy', 'policy_rollout',
            'opposition_research', 'defensive', 'proactive',
            'campaign_milestone', 'voter_mobilization', 'campaign_statement'
        ];

        const ISSUE_TAGS = [
            'healthcare', 'local_economy', 'national_economy', 'education', 'climate',
            'immigration', 'abortion', 'gun_control', 'taxes', 'jobs', 'infrastructure',
            'national_security', 'veterans', 'social_security', 'medicare',
            'criminal_justice', 'voting_rights', 'housing', 'transportation',
            'technology', 'trade', 'foreign_policy', 'energy', 'agriculture',
            'federal_workforce'
        ];

        let currentReleases = [];

        async function loadReviewQueue() {
            const filterType = document.getElementById('filter-type').value;
            const queueContainer = document.getElementById('review-queue');

            queueContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #64748b;">Loading...</div>';

            try {
                const response = await fetch(`http://localhost:3001/api/press-releases/review-queue?filter=${filterType}`);
                const data = await response.json();

                if (data.success) {
                    // Normalize data to ensure subtypes and issues are arrays of strings
                    currentReleases = data.releases.map(release => ({
                        ...release,
                        subtypes: normalizeArray(release.subtypes),
                        issues: normalizeArray(release.issues)
                    }));
                    renderReviewQueue(currentReleases);
                    updateStats(data.stats);
                }
            } catch (error) {
                console.error('Error loading review queue:', error);
                queueContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Error loading releases</div>';
            }
        }

        // Normalize array data to ensure it's an array of strings
        function normalizeArray(data) {
            if (!data) return [];
            if (typeof data === 'string') {
                try {
                    data = JSON.parse(data);
                } catch (e) {
                    return [];
                }
            }
            if (!Array.isArray(data)) return [];

            // Convert each item to string if it's an object
            return data.map(item => {
                if (typeof item === 'string') return item;
                if (typeof item === 'object' && item !== null) {
                    // Handle specific structures: {subtype: "value", confidence: X} or {issue: "value", confidence: X}
                    if (item.subtype) return item.subtype;
                    if (item.issue) return item.issue;
                    // Fallback to other common properties
                    return item.name || item.value || item.tag || JSON.stringify(item);
                }
                return String(item);
            });
        }

        function renderReviewQueue(releases) {
            const container = document.getElementById('review-queue');

            if (releases.length === 0) {
                const filterType = document.getElementById('filter-type').value;
                let message = 'No releases need quality review right now.';
                if (filterType === 'flagged') message = 'No flagged issues found. All categorizations look good!';
                if (filterType === 'low_confidence') message = 'No low confidence scores found. AI is performing well!';
                if (filterType === 'random_sample') message = 'Random sample queue is empty. Refresh to generate new sample.';

                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">✅</div>
                        <div class="empty-state-title">Quality Check Complete</div>
                        <div class="empty-state-text">${message}</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = releases.map(release => renderReviewCard(release)).join('');

            // Apply saved panel split after rendering
            setTimeout(() => applySavedPanelSplit(), 0);
        }

        function getConfidenceBadge(value) {
            // Convert to number and validate
            const numValue = typeof value === 'number' ? value : parseFloat(value);
            if (!numValue || isNaN(numValue) || numValue <= 0) {
                return '<span class="confidence-badge conf-low">No Score</span>';
            }
            const pct = numValue * 100;
            if (pct >= 90) return `<span class="confidence-badge conf-high">${pct.toFixed(0)}%</span>`;
            if (pct >= 75) return `<span class="confidence-badge conf-medium">${pct.toFixed(0)}%</span>`;
            return `<span class="confidence-badge conf-low">${pct.toFixed(0)}%</span>`;
        }

        function renderReviewCard(release) {
            const flags = analyzeFlags(release);
            const cardClass = flags.length > 0 ? 'flagged' : (release.confidence && release.confidence < 0.85 ? 'low-confidence' : '');

            // Get confidence scores for each field - check multiple possible locations
            const typeConf = release.confidence ||
                           release.parsed_data?.release_type?.confidence ||
                           release.parsed_data?.confidence ||
                           null;
            const subtypesConf = release.parsed_data?.subtypes_confidence || null;
            const issuesConf = release.parsed_data?.issues_confidence || null;

            return `
                <div class="review-card ${cardClass}" data-id="${release.id}">
                    <!-- LEFT PANEL: Content -->
                    <div class="review-left-panel" data-panel="left">
                        <div style="margin-bottom: 16px;">
                            <div class="card-title" style="margin-bottom: 8px;">${release.title}</div>
                            <div class="card-meta">
                                <span>ID: ${release.id}</span>
                                <span>•</span>
                                <span>Source: ${release.source_file || 'Manual Entry'}</span>
                            </div>
                        </div>

                        ${flags.length > 0 ? `
                            <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px 16px; margin-bottom: 16px; border-radius: 6px;">
                                <div style="font-weight: 600; color: #92400e; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                                    <span style="font-size: 16px;">⚠️</span>
                                    <span>Quality Issues Detected (${flags.length})</span>
                                </div>
                                ${flags.map(flag => `<div style="font-size: 13px; color: #78350f; margin-left: 22px; margin-bottom: 4px;">• ${flag}</div>`).join('')}
                            </div>
                        ` : ''}

                        <div style="font-size: 13px; font-weight: 600; color: #475569; margin-bottom: 8px;">Full Content:</div>
                        <div class="content-preview">${release.content}</div>
                    </div>

                    <!-- RESIZER -->
                    <div class="panel-resizer"></div>

                    <!-- RIGHT PANEL: Categorization -->
                    <div class="review-right-panel">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid #e2e8f0;">
                            <div style="font-weight: 600; color: #0f172a; font-size: 16px;">AI Categorization</div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="text" id="reviewer-${release.id}" placeholder="Your name"
                                       value="${document.getElementById('reviewer-name')?.value || ''}"
                                       style="width: 120px; padding: 5px 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 12px;" />
                                <button class="btn btn-success btn-sm" onclick="approveRelease(${release.id})">✓ Approve</button>
                                <button class="btn btn-secondary btn-sm" onclick="saveChanges(${release.id})">💾 Save</button>
                            </div>
                        </div>

                        <div class="cat-group" style="margin-bottom: 20px;">
                            <div class="cat-label">
                                Release Type
                                ${getConfidenceBadge(typeConf)}
                            </div>
                            <div class="ai-value" style="margin-bottom: 8px;">${release.release_type || 'Not categorized'}</div>
                            <select id="type-${release.id}" class="edit-field">
                                <option value="">-- Select Type --</option>
                                ${RELEASE_TYPES.map(type => `
                                    <option value="${type}" ${type === release.release_type ? 'selected' : ''}>${type}</option>
                                `).join('')}
                            </select>
                        </div>

                        <div class="cat-group" style="margin-bottom: 20px;">
                            <div class="cat-label">
                                Subtypes
                                ${getConfidenceBadge(subtypesConf)}
                            </div>
                            <div class="tags-container">
                                ${(release.subtypes || []).map(subtype => `
                                    <span class="tag removable" onclick="removeTag(${release.id}, 'subtype', '${subtype}')">
                                        ${subtype}<span class="remove">×</span>
                                    </span>
                                `).join('')}
                            </div>
                            <div class="add-tag-input">
                                <select id="add-subtype-${release.id}">
                                    <option value="">-- Add Subtype --</option>
                                    ${RELEASE_SUBTYPES.map(st => `<option value="${st}">${st}</option>`).join('')}
                                </select>
                                <button class="btn btn-secondary" onclick="addTag(${release.id}, 'subtype')">Add</button>
                            </div>
                        </div>

                        <div class="cat-group">
                            <div class="cat-label">
                                Issues
                                ${getConfidenceBadge(issuesConf)}
                            </div>
                            <div class="tags-container">
                                ${(release.issues || []).map(issue => `
                                    <span class="tag removable" onclick="removeTag(${release.id}, 'issue', '${issue}')">
                                        ${issue}<span class="remove">×</span>
                                    </span>
                                `).join('')}
                            </div>
                            <div class="add-tag-input">
                                <select id="add-issue-${release.id}" style="flex: 1;">
                                    <option value="">-- Select Issue --</option>
                                    ${ISSUE_TAGS.map(tag => `<option value="${tag}">${tag}</option>`).join('')}
                                </select>
                                <button class="btn btn-secondary btn-sm" onclick="addTag(${release.id}, 'issue')">Add</button>
                            </div>
                            <div class="add-tag-input" style="margin-top: 8px;">
                                <input type="text" id="custom-issue-${release.id}" placeholder="Or enter custom issue tag..."
                                       style="flex: 1; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px;" />
                                <button class="btn btn-secondary btn-sm" onclick="addCustomTag(${release.id}, 'issue')">Add Custom</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function analyzeFlags(release) {
            const flags = [];

            // Check for ICYMI media appearances
            if (release.title?.includes('ICYMI') && release.release_type !== 'media_appearance') {
                flags.push('ICYMI release not categorized as media_appearance');
            }

            // Check for missing federal_workforce tag
            const content = (release.title + ' ' + release.content).toLowerCase();
            if ((content.includes('doge') || content.includes('mass firing') || content.includes('federal employees'))
                && !(release.issues || []).includes('federal_workforce')) {
                flags.push('Contains DOGE/federal employee content but missing federal_workforce tag');
            }

            // Check for veterans false positive
            if ((release.issues || []).includes('veterans') &&
                (content.includes('fire fighter') || content.includes('firefighter')) &&
                !content.includes('veteran')) {
                flags.push('Veterans tag may be false positive (fire fighters are not necessarily veterans)');
            }

            // Check for low confidence
            if (release.confidence && release.confidence < 0.85) {
                flags.push(`Low confidence score: ${(release.confidence * 100).toFixed(1)}%`);
            }

            return flags;
        }

        function removeTag(releaseId, type, value) {
            const release = currentReleases.find(r => r.id === releaseId);
            if (!release) return;

            if (type === 'subtype') {
                release.subtypes = (release.subtypes || []).filter(st => st !== value);
            } else if (type === 'issue') {
                release.issues = (release.issues || []).filter(i => i !== value);
            }

            renderReviewQueue(currentReleases);
        }

        function addTag(releaseId, type) {
            const release = currentReleases.find(r => r.id === releaseId);
            if (!release) return;

            const selectId = type === 'subtype' ? `add-subtype-${releaseId}` : `add-issue-${releaseId}`;
            const value = document.getElementById(selectId).value;

            if (!value) return;

            if (type === 'subtype') {
                if (!release.subtypes) release.subtypes = [];
                if (!release.subtypes.includes(value)) {
                    release.subtypes.push(value);
                }
            } else if (type === 'issue') {
                if (!release.issues) release.issues = [];
                if (!release.issues.includes(value)) {
                    release.issues.push(value);
                }
            }

            // Clear the dropdown
            document.getElementById(selectId).value = '';

            renderReviewQueue(currentReleases);
        }

        function addCustomTag(releaseId, type) {
            const release = currentReleases.find(r => r.id === releaseId);
            if (!release) return;

            const inputId = type === 'subtype' ? `custom-subtype-${releaseId}` : `custom-issue-${releaseId}`;
            const input = document.getElementById(inputId);
            const value = input.value.trim();

            if (!value) {
                alert('Please enter a custom tag');
                return;
            }

            // Convert to snake_case
            const normalizedValue = value.toLowerCase()
                .replace(/[^a-z0-9\s]/g, '')
                .replace(/\s+/g, '_');

            if (type === 'subtype') {
                if (!release.subtypes) release.subtypes = [];
                if (!release.subtypes.includes(normalizedValue)) {
                    release.subtypes.push(normalizedValue);
                }
            } else if (type === 'issue') {
                if (!release.issues) release.issues = [];
                if (!release.issues.includes(normalizedValue)) {
                    release.issues.push(normalizedValue);
                }
            }

            // Clear the input
            input.value = '';

            renderReviewQueue(currentReleases);
        }

        async function approveRelease(releaseId) {
            await saveChanges(releaseId, true);
        }

        async function saveChanges(releaseId, isApproval = false) {
            const release = currentReleases.find(r => r.id === releaseId);
            if (!release) return;

            const reviewerName = document.getElementById(`reviewer-${releaseId}`).value.trim();

            // Require reviewer name for both approval and save
            if (!reviewerName) {
                alert('Please enter your name before ' + (isApproval ? 'approving' : 'saving'));
                return;
            }

            // Check for unsaved custom issue
            const customIssueInput = document.getElementById(`custom-issue-${releaseId}`);
            if (customIssueInput && customIssueInput.value.trim()) {
                const customValue = customIssueInput.value.trim();
                const normalizedValue = customValue.toLowerCase()
                    .replace(/[^a-z0-9\s]/g, '')
                    .replace(/\s+/g, '_');

                if (!release.issues) release.issues = [];
                if (!release.issues.includes(normalizedValue)) {
                    release.issues.push(normalizedValue);
                }
            }

            const newType = document.getElementById(`type-${releaseId}`).value;

            const updateData = {
                id: releaseId,
                title: release.title,
                content: release.content,
                release_type: newType || release.release_type,
                release_subtype: release.subtypes?.[0] || null,
                confidence: release.confidence,
                subtypes: release.subtypes || [],
                issues: release.issues || [],
                metadata: release.metadata || {},
                parsed_data: release.parsed_data || {},
                source_file: release.source_file,
                reviewed_by: reviewerName || null
            };

            try {
                const response = await fetch('http://localhost:3001/api/press-releases/save-parsed', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });

                const result = await response.json();

                if (result.success) {
                    // Update stored reviewer name
                    if (reviewerName) {
                        document.getElementById('reviewer-name').value = reviewerName;
                    }

                    // Show success message
                    const message = isApproval ? '✓ Release approved and marked as reviewed!' : '💾 Changes saved and marked as reviewed!';
                    alert(message);

                    // Reload the queue to get fresh data and update stats
                    await loadReviewQueue();
                } else {
                    alert('Error saving: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving changes:', error);
                alert('Error saving changes');
            }
        }

        function updateStats(stats) {
            if (stats) {
                document.getElementById('queue-count').textContent = stats.needs_review || 0;
                document.getElementById('reviewed-count').textContent = stats.reviewed || 0;
                document.getElementById('flagged-count').textContent = stats.flagged || 0;
            }
        }

        async function exportReviewData() {
            try {
                const response = await fetch('http://localhost:3001/api/press-releases/review-export');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `review-data-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error exporting data:', error);
                alert('Error exporting data');
            }
        }

        // Panel resizing functionality
        function initPanelResizers() {
            document.addEventListener('mousedown', (e) => {
                if (!e.target.classList.contains('panel-resizer')) return;

                const resizer = e.target;
                const card = resizer.closest('.review-card');
                const leftPanel = card.querySelector('.review-left-panel');
                const startX = e.clientX;
                const startWidth = leftPanel.offsetWidth;
                const cardWidth = card.offsetWidth;

                function onMouseMove(e) {
                    const deltaX = e.clientX - startX;
                    const newWidth = startWidth + deltaX;
                    const newWidthPercent = (newWidth / cardWidth) * 100;

                    // Limit between 20% and 80%
                    if (newWidthPercent >= 20 && newWidthPercent <= 80) {
                        leftPanel.style.flex = `0 0 ${newWidthPercent}%`;
                        localStorage.setItem('panelSplitPercent', newWidthPercent);
                    }
                }

                function onMouseUp() {
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                }

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        }

        // Apply saved panel split on load
        function applySavedPanelSplit() {
            const savedPercent = localStorage.getItem('panelSplitPercent');
            if (savedPercent) {
                document.querySelectorAll('.review-left-panel').forEach(panel => {
                    panel.style.flex = `0 0 ${savedPercent}%`;
                });
            }
        }

        // Load on page load
        window.addEventListener('load', () => {
            loadReviewQueue();
            initPanelResizers();
        });
    </script>
</body>
</html>
