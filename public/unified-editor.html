<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Campaign Editor - Polis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #5568d3;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-700: #374151;
            --gray-900: #111827;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: white;
            color: var(--primary);
        }

        .btn-primary:hover {
            background: var(--gray-100);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Main Layout */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
        }

        /* Stage Navigation */
        .stage-nav {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stage-nav h3 {
            font-size: 14px;
            text-transform: uppercase;
            color: var(--gray-700);
            margin-bottom: 16px;
            letter-spacing: 0.5px;
        }

        .stages {
            display: flex;
            gap: 8px;
        }

        .stage {
            flex: 1;
            padding: 12px;
            background: var(--gray-100);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            position: relative;
        }

        .stage.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary-dark);
        }

        .stage.completed {
            background: var(--success);
            color: white;
        }

        .stage:hover:not(.active) {
            background: var(--gray-200);
        }

        .stage-num {
            font-size: 18px;
            font-weight: 700;
            display: block;
        }

        .stage-name {
            font-size: 11px;
            display: block;
            margin-top: 4px;
        }

        /* Editor Area */
        .editor-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stage-content {
            display: none;
        }

        .stage-content.active {
            display: block;
        }

        /* Stage 1: Import */
        .import-area {
            border: 2px dashed var(--gray-300);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: var(--gray-50);
        }

        .import-area h2 {
            font-size: 20px;
            margin-bottom: 8px;
        }

        .import-area p {
            color: var(--gray-700);
            margin-bottom: 20px;
        }

        .import-options {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
        }

        textarea.import-text {
            width: 100%;
            min-height: 300px;
            padding: 16px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            margin-top: 16px;
        }

        /* Section Detection */
        .section-detection {
            margin-top: 24px;
        }

        .section-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: var(--gray-50);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .section-item.found {
            background: #ecfdf5;
            border-left: 4px solid var(--success);
        }

        .section-item.missing {
            background: #fef2f2;
            border-left: 4px solid var(--danger);
        }

        .section-icon {
            font-size: 20px;
            margin-right: 12px;
        }

        .section-name {
            flex: 1;
            font-weight: 500;
        }

        .section-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .section-status.found {
            background: var(--success);
            color: white;
        }

        .section-status.missing {
            background: var(--danger);
            color: white;
        }

        .section-status.optional {
            background: var(--warning);
            color: white;
        }

        /* Enhancement Categories */
        .category-list {
            margin-top: 20px;
        }

        .category-card {
            background: var(--gray-50);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid var(--gray-300);
        }

        .category-card:hover {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .category-card.active {
            border-left-color: var(--primary);
            background: white;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-title {
            font-weight: 600;
            font-size: 16px;
        }

        .category-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .badge-danger {
            background: #fee2e2;
            color: var(--danger);
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .category-desc {
            font-size: 13px;
            color: var(--gray-700);
            margin-top: 8px;
        }

        /* Recommendations Panel */
        .recommendations {
            margin-top: 20px;
        }

        .recommendation-item {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .rec-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .rec-title {
            font-weight: 600;
            color: var(--gray-900);
        }

        .rec-severity {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .severity-blocking {
            background: var(--danger);
            color: white;
        }

        .severity-warning {
            background: var(--warning);
            color: white;
        }

        .severity-suggestion {
            background: var(--success);
            color: white;
        }

        .rec-description {
            font-size: 14px;
            color: var(--gray-700);
            margin-bottom: 12px;
        }

        .rec-suggestion {
            background: var(--gray-50);
            border-left: 3px solid var(--primary);
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 12px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .rec-actions {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-outline {
            background: white;
            border: 1px solid var(--gray-300);
            color: var(--gray-700);
        }

        .btn-outline:hover {
            background: var(--gray-100);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .sidebar-card h3 {
            font-size: 16px;
            margin-bottom: 16px;
            color: var(--gray-900);
        }

        /* Progress Summary */
        .progress-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .progress-item:last-child {
            border-bottom: none;
        }

        .progress-label {
            font-size: 14px;
            color: var(--gray-700);
        }

        .progress-value {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        /* Document Preview */
        .doc-preview {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 16px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 13px;
            line-height: 1.8;
        }

        .doc-preview h4 {
            font-size: 16px;
            margin-bottom: 12px;
            color: var(--gray-900);
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .quick-action-btn {
            width: 100%;
            text-align: left;
            padding: 12px;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-action-btn:hover {
            background: var(--gray-100);
            border-color: var(--primary);
        }

        .quick-action-btn strong {
            display: block;
            margin-bottom: 4px;
        }

        .quick-action-btn small {
            color: var(--gray-700);
            font-size: 12px;
        }

        /* Hidden helper */
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>📝 Unified Campaign Editor</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="saveDraft()">💾 Save Draft</button>
            <button class="btn btn-primary" onclick="exportDocument()">📤 Export</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Editor Section -->
        <div>
            <!-- Stage Navigation -->
            <div class="stage-nav">
                <h3>Workflow Stages</h3>
                <div class="stages">
                    <div class="stage active" data-stage="1" onclick="switchStage(1)">
                        <span class="stage-num">1</span>
                        <span class="stage-name">Import</span>
                    </div>
                    <div class="stage" data-stage="2" onclick="switchStage(2)">
                        <span class="stage-num">2</span>
                        <span class="stage-name">Structure</span>
                    </div>
                    <div class="stage" data-stage="3" onclick="switchStage(3)">
                        <span class="stage-num">3</span>
                        <span class="stage-name">Enhance</span>
                    </div>
                    <div class="stage" data-stage="4" onclick="switchStage(4)">
                        <span class="stage-num">4</span>
                        <span class="stage-name">Review</span>
                    </div>
                </div>
            </div>

            <!-- Main Editor Area -->
            <div class="editor-section">
                <!-- Stage 1: Import -->
                <div class="stage-content active" id="stage-1">
                    <div class="import-area">
                        <h2>Import Document</h2>
                        <p>Start by pasting your press release text or uploading a file</p>
                        <div class="import-options">
                            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                                📁 Upload File
                            </button>
                            <button class="btn btn-secondary" onclick="showPasteArea()">
                                📋 Paste Text
                            </button>
                        </div>
                        <input type="file" id="fileInput" class="hidden" accept=".txt,.md,.html" onchange="handleFileUpload(event)">
                        <textarea class="import-text hidden" id="pasteArea" placeholder="Paste your press release text here..."></textarea>
                        <button class="btn btn-primary hidden" id="analyzeBtn" onclick="analyzeDocument()" style="margin-top: 16px;">
                            🔍 Analyze Document
                        </button>
                    </div>
                </div>

                <!-- Stage 2: Structure -->
                <div class="stage-content" id="stage-2">
                    <h2>Document Structure Analysis</h2>
                    <p style="color: var(--gray-700); margin-bottom: 24px;">
                        Review identified sections and address any missing required elements.
                    </p>
                    <div class="section-detection" id="sectionList">
                        <!-- Populated by JS -->
                    </div>
                    <button class="btn btn-primary" onclick="switchStage(3)" style="margin-top: 24px;">
                        ✓ Continue to Enhancements
                    </button>
                </div>

                <!-- Stage 3: Enhance -->
                <div class="stage-content" id="stage-3">
                    <h2>Enhancement Recommendations</h2>
                    <p style="color: var(--gray-700); margin-bottom: 24px;">
                        Select a category to review and apply recommendations. Work through categories in order or jump to priority items.
                    </p>
                    <div class="category-list" id="categoryList">
                        <!-- Populated by JS -->
                    </div>
                    <div class="recommendations" id="recommendationPanel">
                        <p style="text-align: center; color: var(--gray-700);">
                            Select a category above to see recommendations
                        </p>
                    </div>
                </div>

                <!-- Stage 4: Review -->
                <div class="stage-content" id="stage-4">
                    <h2>Final Review & Export</h2>
                    <p style="color: var(--gray-700); margin-bottom: 24px;">
                        Review your enhanced document and export in your preferred format.
                    </p>
                    <div class="doc-preview" id="finalPreview">
                        <!-- Populated by JS -->
                    </div>
                    <div style="margin-top: 24px; display: flex; gap: 12px;">
                        <button class="btn btn-primary" onclick="exportDocument('html')">📄 Export HTML</button>
                        <button class="btn btn-secondary" onclick="exportDocument('json')">📋 Export JSON-LD</button>
                        <button class="btn btn-secondary" onclick="exportDocument('markdown')">📝 Export Markdown</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Progress Summary -->
            <div class="sidebar-card">
                <h3>Progress Summary</h3>
                <div class="progress-item">
                    <span class="progress-label">🔴 Blocking Issues</span>
                    <span class="progress-value badge-danger" id="blockingCount">0</span>
                </div>
                <div class="progress-item">
                    <span class="progress-label">🟡 Warnings</span>
                    <span class="progress-value badge-warning" id="warningCount">0</span>
                </div>
                <div class="progress-item">
                    <span class="progress-label">🟢 Suggestions</span>
                    <span class="progress-value badge-success" id="suggestionCount">0</span>
                </div>
                <div class="progress-item">
                    <span class="progress-label">📊 Overall Score</span>
                    <span class="progress-value" id="overallScore">--</span>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="sidebar-card">
                <h3>Quick Actions</h3>
                <div class="quick-actions">
                    <button class="quick-action-btn" onclick="autoFix('all')">
                        <strong>🔧 Auto-fix All Safe Issues</strong>
                        <small>Automatically apply low-risk suggestions</small>
                    </button>
                    <button class="quick-action-btn" onclick="showTemplates()">
                        <strong>📋 Apply Template</strong>
                        <small>Use pre-built press release structure</small>
                    </button>
                    <button class="quick-action-btn" onclick="runCompliance()">
                        <strong>⚖️ Run Compliance Check</strong>
                        <small>Verify FEC and legal requirements</small>
                    </button>
                </div>
            </div>

            <!-- Document Metadata -->
            <div class="sidebar-card" id="metadataPanel">
                <h3>Document Info</h3>
                <div class="progress-item">
                    <span class="progress-label">Word Count</span>
                    <span class="progress-value" id="wordCount">0</span>
                </div>
                <div class="progress-item">
                    <span class="progress-label">Last Saved</span>
                    <span class="progress-value" id="lastSaved">Never</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // NOTE: Module imports removed for standalone operation
        // TODO: Re-enable imports once module path is configured

        // Simplified scoring function (replaces scoreCoverage import)
        function scoreCoverage(opts) {
            // Mock implementation - returns basic score
            return { score: 65, report: [], entities: {}, family: 'ANN', totalWeight: 1.0 };
        }

        // Global state
        window.editorState = {
            currentStage: 1,
            document: {
                raw: '',
                sections: {},
                metadata: {},
                recommendations: []
            },
            completed: {
                stage1: false,
                stage2: false,
                stage3: false
            }
        };

        // Stage switching
        window.switchStage = function(stageNum) {
            // Update stage navigation
            document.querySelectorAll('.stage').forEach(el => {
                el.classList.remove('active');
                if (parseInt(el.dataset.stage) === stageNum) {
                    el.classList.add('active');
                }
            });

            // Update content
            document.querySelectorAll('.stage-content').forEach(el => {
                el.classList.remove('active');
            });
            document.getElementById(`stage-${stageNum}`).classList.add('active');

            window.editorState.currentStage = stageNum;
        };

        // File upload handler
        window.handleFileUpload = function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const text = e.target.result;
                    document.getElementById('pasteArea').value = text;
                    document.getElementById('pasteArea').classList.remove('hidden');
                    document.getElementById('analyzeBtn').classList.remove('hidden');
                };
                reader.readAsText(file);
            }
        };

        // Show paste area
        window.showPasteArea = function() {
            document.getElementById('pasteArea').classList.remove('hidden');
            document.getElementById('analyzeBtn').classList.remove('hidden');
            document.getElementById('pasteArea').focus();
        };

        // Document analysis
        window.analyzeDocument = async function() {
            const text = document.getElementById('pasteArea').value.trim();
            if (!text) {
                alert('Please paste or upload document text first');
                return;
            }

            window.editorState.document.raw = text;

            // Parse sections
            const sections = parseDocumentSections(text);
            window.editorState.document.sections = sections;

            // Mark stage 1 complete and move to stage 2
            markStageComplete(1);
            switchStage(2);

            // Display section analysis
            displaySectionAnalysis(sections);

            // Run all checks in background
            await runAllChecks();
        };

        // Parse document sections
        function parseDocumentSections(text) {
            const lines = text.split('\n').filter(l => l.trim());
            const sections = {
                headline: null,
                dateline: null,
                lede: null,
                body: [],
                quotes: [],
                boilerplate: null,
                contact: null
            };

            // Simple heuristic parsing
            // Headline: First substantial line
            if (lines.length > 0) {
                sections.headline = lines[0];
            }

            // Date pattern: Look for date mentions
            const datePattern = /\b(january|february|march|april|may|june|july|august|september|october|november|december|\d{1,2}\/\d{1,2}\/\d{2,4})\b/i;
            for (let i = 0; i < Math.min(5, lines.length); i++) {
                if (datePattern.test(lines[i])) {
                    sections.dateline = lines[i];
                    break;
                }
            }

            // Body: Everything in middle
            const bodyStart = sections.dateline ? lines.indexOf(sections.dateline) + 1 : 1;
            sections.body = lines.slice(bodyStart, -2);

            // Quotes: Lines with quotation marks
            sections.quotes = lines.filter(l => l.includes('"') || l.includes('"') || l.includes('"'));

            // Contact: Last line if it has email/phone
            if (lines.length > 0) {
                const lastLine = lines[lines.length - 1];
                if (lastLine.match(/@|phone|contact/i)) {
                    sections.contact = lastLine;
                }
            }

            // Boilerplate: Look for "###" or "About" marker
            const boilerplateIdx = lines.findIndex(l => l.match(/^###|^about /i));
            if (boilerplateIdx > -1) {
                sections.boilerplate = lines.slice(boilerplateIdx).join('\n');
            }

            return sections;
        }

        // Display section analysis
        function displaySectionAnalysis(sections) {
            const requiredSections = [
                { key: 'headline', name: 'Headline', icon: '📰', required: true },
                { key: 'dateline', name: 'Date/Location', icon: '📅', required: true },
                { key: 'lede', name: 'Opening Paragraph', icon: '📝', required: true },
                { key: 'body', name: 'Body Text', icon: '📄', required: true },
                { key: 'quotes', name: 'Quotes', icon: '💬', required: false },
                { key: 'boilerplate', name: 'Boilerplate', icon: 'ℹ️', required: false },
                { key: 'contact', name: 'Contact Info', icon: '📧', required: true }
            ];

            const html = requiredSections.map(sec => {
                const found = sections[sec.key] && (
                    Array.isArray(sections[sec.key]) ? sections[sec.key].length > 0 : sections[sec.key]
                );
                const statusClass = found ? 'found' : 'missing';
                const statusText = found ? 'FOUND' : (sec.required ? 'MISSING' : 'OPTIONAL');
                const statusBadge = found ? 'found' : (sec.required ? 'missing' : 'optional');

                return `
                    <div class="section-item ${statusClass}">
                        <span class="section-icon">${sec.icon}</span>
                        <span class="section-name">${sec.name}</span>
                        <span class="section-status ${statusBadge}">${statusText}</span>
                    </div>
                `;
            }).join('');

            document.getElementById('sectionList').innerHTML = html;
        }

        // Run all checks
        async function runAllChecks() {
            const categories = await generateRecommendations();
            displayCategories(categories);
            updateProgressSummary(categories);
        }

        // Generate recommendations by category
        async function generateRecommendations() {
            const text = window.editorState.document.raw;
            const sections = window.editorState.document.sections;

            const categories = [
                {
                    id: 'compliance',
                    name: 'Legal Compliance',
                    description: 'FEC disclaimers, coordination language, prohibited content',
                    severity: 'blocking',
                    count: 0,
                    recommendations: []
                },
                {
                    id: 'factual',
                    name: 'Factual Claims',
                    description: 'Unsupported claims, plausible deniability language',
                    severity: 'warning',
                    count: 0,
                    recommendations: []
                },
                {
                    id: 'metadata',
                    name: 'Structured Metadata',
                    description: 'JSON-LD markup, SEO optimization, schema completeness',
                    severity: 'suggestion',
                    count: 0,
                    recommendations: []
                },
                {
                    id: 'style',
                    name: 'Style & Tone',
                    description: 'Grammar, passive voice, readability, consistency',
                    severity: 'suggestion',
                    count: 0,
                    recommendations: []
                }
            ];

            // TODO: Replace with real checks - for now, generate mock recommendations

            // Compliance checks (mock)
            if (!text.match(/paid for by/i)) {
                categories[0].recommendations.push({
                    title: 'Missing FEC Disclaimer',
                    description: 'Federal law requires "Paid for by" disclaimer on campaign communications.',
                    suggestion: 'Paid for by [Campaign Name]. Not authorized by any candidate or candidate\'s committee.',
                    severity: 'blocking',
                    autoFix: true
                });
                categories[0].count++;
            }

            // Factual claims (mock - simulate detect_pd.py)
            const pdPhrases = ['some say', 'many believe', 'it is said', 'critics claim'];
            pdPhrases.forEach(phrase => {
                if (text.toLowerCase().includes(phrase)) {
                    categories[1].recommendations.push({
                        title: 'Plausible Deniability Language Detected',
                        description: `Phrase "${phrase}" weakens the statement. Consider direct attribution or removal.`,
                        suggestion: 'Replace with specific source: "According to [Source], ..." or state directly.',
                        severity: 'warning',
                        autoFix: false
                    });
                    categories[1].count++;
                }
            });

            // Metadata/JSON-LD (mock - using prose_suggestion_engine.js)
            const mockJsonLd = {
                '@context': 'https://schema.org',
                '@type': 'PressRelease',
                'headline': sections.headline || '',
                'datePublished': '',
                'cpo:subtype': 'ANN.GEN.STATEMENT'
            };

            const coverage = scoreCoverage({
                proseText: text,
                jsonld: mockJsonLd
            });

            if (coverage.score < 70) {
                categories[2].recommendations.push({
                    title: 'Incomplete Structured Markup',
                    description: `Parity score: ${coverage.score}%. Missing key metadata fields.`,
                    suggestion: 'Add missing fields: datePublished, author, location',
                    severity: 'suggestion',
                    autoFix: false
                });
                categories[2].count++;
            }

            // Style checks (mock)
            const passivePattern = /\b(was|were|is|are|been)\s+\w+ed\b/gi;
            const passiveMatches = text.match(passivePattern);
            if (passiveMatches && passiveMatches.length > 3) {
                categories[3].recommendations.push({
                    title: 'Excessive Passive Voice',
                    description: `Found ${passiveMatches.length} instances of passive voice. Active voice is stronger.`,
                    suggestion: 'Review and convert to active voice where possible.',
                    severity: 'suggestion',
                    autoFix: false
                });
                categories[3].count++;
            }

            return categories;
        }

        // Display categories
        function displayCategories(categories) {
            const html = categories.map(cat => {
                const badgeClass = `badge-${cat.severity === 'blocking' ? 'danger' : (cat.severity === 'warning' ? 'warning' : 'success')}`;
                return `
                    <div class="category-card" data-category="${cat.id}" onclick="showCategoryRecommendations('${cat.id}')">
                        <div class="category-header">
                            <span class="category-title">${cat.name}</span>
                            <span class="category-badge ${badgeClass}">${cat.count} items</span>
                        </div>
                        <div class="category-desc">${cat.description}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('categoryList').innerHTML = html;
            window.editorState.document.recommendations = categories;
        }

        // Show category recommendations
        window.showCategoryRecommendations = function(categoryId) {
            // Update active category
            document.querySelectorAll('.category-card').forEach(el => {
                el.classList.remove('active');
                if (el.dataset.category === categoryId) {
                    el.classList.add('active');
                }
            });

            const category = window.editorState.document.recommendations.find(c => c.id === categoryId);
            if (!category || category.recommendations.length === 0) {
                document.getElementById('recommendationPanel').innerHTML = `
                    <p style="text-align: center; color: var(--gray-700);">
                        ✓ No issues found in this category
                    </p>
                `;
                return;
            }

            const html = category.recommendations.map((rec, idx) => `
                <div class="recommendation-item">
                    <div class="rec-header">
                        <span class="rec-title">${rec.title}</span>
                        <span class="rec-severity severity-${rec.severity}">${rec.severity}</span>
                    </div>
                    <div class="rec-description">${rec.description}</div>
                    <div class="rec-suggestion">${rec.suggestion}</div>
                    <div class="rec-actions">
                        <button class="btn btn-sm btn-success" onclick="applyRecommendation('${categoryId}', ${idx})">
                            ✓ Apply
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="editRecommendation('${categoryId}', ${idx})">
                            ✎ Edit & Apply
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="dismissRecommendation('${categoryId}', ${idx})">
                            ✕ Dismiss
                        </button>
                    </div>
                </div>
            `).join('');

            document.getElementById('recommendationPanel').innerHTML = html;
        };

        // Apply recommendation
        window.applyRecommendation = function(categoryId, recIdx) {
            const category = window.editorState.document.recommendations.find(c => c.id === categoryId);
            const rec = category.recommendations[recIdx];

            // Apply the suggestion (simplified - just append to document)
            window.editorState.document.raw += '\n\n' + rec.suggestion;

            // Remove from recommendations
            category.recommendations.splice(recIdx, 1);
            category.count--;

            // Refresh display
            showCategoryRecommendations(categoryId);
            updateProgressSummary(window.editorState.document.recommendations);

            alert('✓ Recommendation applied');
        };

        // Dismiss recommendation
        window.dismissRecommendation = function(categoryId, recIdx) {
            const category = window.editorState.document.recommendations.find(c => c.id === categoryId);
            category.recommendations.splice(recIdx, 1);
            category.count--;
            showCategoryRecommendations(categoryId);
            updateProgressSummary(window.editorState.document.recommendations);
        };

        // Edit recommendation
        window.editRecommendation = function(categoryId, recIdx) {
            const category = window.editorState.document.recommendations.find(c => c.id === categoryId);
            const rec = category.recommendations[recIdx];
            const edited = prompt('Edit suggestion:', rec.suggestion);
            if (edited) {
                window.editorState.document.raw += '\n\n' + edited;
                category.recommendations.splice(recIdx, 1);
                category.count--;
                showCategoryRecommendations(categoryId);
                updateProgressSummary(window.editorState.document.recommendations);
                alert('✓ Custom edit applied');
            }
        };

        // Update progress summary
        function updateProgressSummary(categories) {
            const blocking = categories.filter(c => c.severity === 'blocking').reduce((sum, c) => sum + c.count, 0);
            const warnings = categories.filter(c => c.severity === 'warning').reduce((sum, c) => sum + c.count, 0);
            const suggestions = categories.filter(c => c.severity === 'suggestion').reduce((sum, c) => sum + c.count, 0);

            document.getElementById('blockingCount').textContent = blocking;
            document.getElementById('warningCount').textContent = warnings;
            document.getElementById('suggestionCount').textContent = suggestions;

            // Calculate overall score (inverse of total issues)
            const totalIssues = blocking * 3 + warnings * 2 + suggestions;
            const score = Math.max(0, 100 - totalIssues * 5);
            document.getElementById('overallScore').textContent = `${score}%`;
            document.getElementById('overallScore').className = `progress-value ${score > 80 ? 'badge-success' : (score > 50 ? 'badge-warning' : 'badge-danger')}`;

            // Update word count
            const words = window.editorState.document.raw.split(/\s+/).length;
            document.getElementById('wordCount').textContent = words;
        }

        // Mark stage complete
        function markStageComplete(stageNum) {
            const stageEl = document.querySelector(`.stage[data-stage="${stageNum}"]`);
            if (stageEl && !stageEl.classList.contains('completed')) {
                stageEl.classList.add('completed');
            }
            window.editorState.completed[`stage${stageNum}`] = true;
        }

        // Save draft
        window.saveDraft = async function() {
            const draft = {
                timestamp: new Date().toISOString(),
                document: window.editorState.document,
                stage: window.editorState.currentStage
            };

            try {
                const response = await fetch('/api/drafts/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(draft)
                });

                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('lastSaved').textContent = new Date().toLocaleTimeString();
                    alert('✓ Draft saved successfully');
                } else {
                    throw new Error('Save failed');
                }
            } catch (err) {
                console.error('Save error:', err);
                alert('⚠️ Could not save draft. Check console for details.');
            }
        };

        // Export document
        window.exportDocument = function(format = 'html') {
            const text = window.editorState.document.raw;
            const sections = window.editorState.document.sections;

            if (format === 'html') {
                const html = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${sections.headline || 'Press Release'}</title>
</head>
<body>
    <h1>${sections.headline || ''}</h1>
    <p><em>${sections.dateline || ''}</em></p>
    <div>${text.replace(/\n/g, '<br>')}</div>
</body>
</html>`;
                downloadFile('press-release.html', html, 'text/html');
            } else if (format === 'json') {
                const jsonld = {
                    '@context': 'https://schema.org',
                    '@type': 'PressRelease',
                    'headline': sections.headline || '',
                    'datePublished': new Date().toISOString().split('T')[0],
                    'articleBody': text
                };
                downloadFile('press-release.json', JSON.stringify(jsonld, null, 2), 'application/json');
            } else if (format === 'markdown') {
                downloadFile('press-release.md', text, 'text/markdown');
            }
        };

        // Download helper
        function downloadFile(filename, content, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Auto-fix
        window.autoFix = function(scope) {
            if (!confirm('Apply all auto-fixable suggestions?')) return;

            let applied = 0;
            window.editorState.document.recommendations.forEach(category => {
                category.recommendations = category.recommendations.filter(rec => {
                    if (rec.autoFix) {
                        window.editorState.document.raw += '\n\n' + rec.suggestion;
                        category.count--;
                        applied++;
                        return false;
                    }
                    return true;
                });
            });

            updateProgressSummary(window.editorState.document.recommendations);
            alert(`✓ Applied ${applied} auto-fixes`);
        };

        // Templates
        window.showTemplates = function() {
            alert('Template feature coming soon!');
        };

        // Compliance check
        window.runCompliance = function() {
            alert('Running full compliance check...');
            runAllChecks();
        };

        // Initialize
        console.log('Unified Editor initialized');
    </script>
</body>
</html>
