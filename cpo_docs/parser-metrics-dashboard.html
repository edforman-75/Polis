<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Parser Metrics Dashboard</title>
<link rel="stylesheet" href="/cpo/docs/styles.css"/>
<style>
.metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0; }
.metric-card { background: linear-gradient(135deg, #1e2a44 0%, #2d3a5a 100%); padding: 20px; border-radius: 12px; border: 1px solid #3d4a6a; }
.metric-value { font-size: 36px; font-weight: bold; color: #7dd3fc; margin: 10px 0; }
.metric-label { color: #9fb3c8; font-size: 14px; }
.chart-container { background: #1e2a44; padding: 20px; border-radius: 12px; margin: 20px 0; }
.progress-bar { background: #0a1220; height: 20px; border-radius: 10px; overflow: hidden; margin-top: 5px; }
.progress-fill { background: linear-gradient(90deg, #0ea5e9, #7dd3fc); height: 100%; transition: width 0.3s; }
.field-stat { margin: 15px 0; }
.refresh-btn { background: #0ea5e9; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin: 10px 5px; }
.refresh-btn:hover { background: #0284c7; }
</style>
</head>
<body>
<div class="header">
  <h1>üìä Parser Metrics Dashboard</h1>
  <p class="small">Real-time performance metrics for the press release parser learning system</p>
</div>

<div class="container">

  <div class="card">
    <h2>‚ö° Quick Stats</h2>
    <div class="metrics-grid" id="quick-stats">
      <div class="metric-card">
        <div class="metric-label">Total Parses</div>
        <div class="metric-value" id="total-parses">--</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Total Corrections</div>
        <div class="metric-value" id="total-corrections">--</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Overall Accuracy</div>
        <div class="metric-value" id="overall-accuracy">--%</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Learning Progress</div>
        <div class="metric-value" id="learning-progress">--%</div>
      </div>
    </div>
    <button class="refresh-btn" onclick="loadMetrics()">üîÑ Refresh Metrics</button>
    <button class="refresh-btn" onclick="exportMetrics()">üì• Export Data</button>
  </div>

  <div class="chart-container">
    <h2>üìà Field-Level Accuracy</h2>
    <p class="small">Accuracy rates for each parsed field type</p>
    <div id="field-accuracy"></div>
  </div>

  <div class="chart-container">
    <h2>üéØ Top Performing Fields</h2>
    <div id="top-fields"></div>
  </div>

  <div class="chart-container">
    <h2>‚ö†Ô∏è Fields Needing Improvement</h2>
    <div id="improvement-fields"></div>
  </div>

  <div class="card">
    <h2>üìã Detailed Statistics</h2>
    <div id="detailed-stats"></div>
  </div>

  <div class="card">
    <h2>üîß Configuration Recommendations</h2>
    <div id="recommendations">
      <p class="small">Loading recommendations based on performance data...</p>
    </div>
  </div>

</div>

<div class="footer">
  <a href="/cpo" style="color: #7dd3fc;">‚Üê Return to CPO Portal</a> ¬∑
  <a href="/cpo/tools/ai-tuning-dashboard.html" style="color: #7dd3fc;">AI Tuning Dashboard ‚Üí</a>
</div>

<script>
let metricsData = null;

async function loadMetrics() {
  try {
    const response = await fetch('/api/press-release-parser/feedback/metrics');
    if (!response.ok) throw new Error('Failed to fetch metrics');

    metricsData = await response.json();
    displayMetrics(metricsData);
  } catch (error) {
    console.error('Error loading metrics:', error);
    document.getElementById('total-parses').textContent = 'Error';
    document.getElementById('total-corrections').textContent = 'Error';
  }
}

function displayMetrics(data) {
  const metrics = data.metrics || [];

  // Calculate quick stats
  let totalCorrections = 0;
  let totalAccuracy = 0;
  let fieldCount = 0;

  metrics.forEach(metric => {
    totalCorrections += metric.total_corrections || 0;
    totalAccuracy += metric.accuracy_rate || 0;
    fieldCount++;
  });

  const avgAccuracy = fieldCount > 0 ? (totalAccuracy / fieldCount) * 100 : 0;

  document.getElementById('total-parses').textContent = data.total_parses || '--';
  document.getElementById('total-corrections').textContent = totalCorrections;
  document.getElementById('overall-accuracy').textContent = Math.round(avgAccuracy) + '%';
  document.getElementById('learning-progress').textContent = totalCorrections > 10 ? '‚úì' : Math.round((totalCorrections / 10) * 100) + '%';

  // Display field-level accuracy
  displayFieldAccuracy(metrics);

  // Display top performers
  displayTopFields(metrics);

  // Display fields needing improvement
  displayImprovementFields(metrics);

  // Display detailed stats
  displayDetailedStats(metrics);

  // Generate recommendations
  generateRecommendations(metrics);
}

function displayFieldAccuracy(metrics) {
  const container = document.getElementById('field-accuracy');
  let html = '';

  metrics.forEach(metric => {
    const accuracy = Math.round((metric.accuracy_rate || 0) * 100);
    const color = accuracy >= 80 ? '#22c55e' : accuracy >= 60 ? '#eab308' : '#ef4444';

    html += `
      <div class="field-stat">
        <div style="display: flex; justify-content: space-between;">
          <span style="color: #e6edf3;">${metric.field_type}</span>
          <span style="color: ${color}; font-weight: bold;">${accuracy}%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${accuracy}%; background: ${color};"></div>
        </div>
        <div style="color: #9fb3c8; font-size: 12px; margin-top: 3px;">
          ${metric.total_corrections || 0} corrections ¬∑ Avg confidence: ${Math.round((metric.avg_confidence || 0) * 100)}%
        </div>
      </div>
    `;
  });

  container.innerHTML = html || '<p class="small">No field data available</p>';
}

function displayTopFields(metrics) {
  const container = document.getElementById('top-fields');
  const sorted = [...metrics].sort((a, b) => (b.accuracy_rate || 0) - (a.accuracy_rate || 0)).slice(0, 3);

  let html = '<div class="metrics-grid">';
  sorted.forEach((metric, index) => {
    const medals = ['ü•á', 'ü•à', 'ü•â'];
    const accuracy = Math.round((metric.accuracy_rate || 0) * 100);
    html += `
      <div class="metric-card">
        <div style="font-size: 32px;">${medals[index]}</div>
        <div style="color: #7dd3fc; font-size: 18px; margin: 5px 0;">${metric.field_type}</div>
        <div style="color: #22c55e; font-size: 24px; font-weight: bold;">${accuracy}%</div>
      </div>
    `;
  });
  html += '</div>';

  container.innerHTML = html;
}

function displayImprovementFields(metrics) {
  const container = document.getElementById('improvement-fields');
  const sorted = [...metrics].sort((a, b) => (a.accuracy_rate || 0) - (b.accuracy_rate || 0)).slice(0, 3);

  let html = '<div class="metrics-grid">';
  sorted.forEach(metric => {
    const accuracy = Math.round((metric.accuracy_rate || 0) * 100);
    html += `
      <div class="metric-card" style="border-left: 3px solid #ef4444;">
        <div style="color: #7dd3fc; font-size: 18px; margin-bottom: 5px;">${metric.field_type}</div>
        <div style="color: #ef4444; font-size: 24px; font-weight: bold;">${accuracy}%</div>
        <div style="color: #9fb3c8; font-size: 12px; margin-top: 5px;">
          Needs ${metric.total_corrections < 5 ? 'more training data' : 'tuning adjustment'}
        </div>
      </div>
    `;
  });
  html += '</div>';

  container.innerHTML = html;
}

function displayDetailedStats(metrics) {
  const container = document.getElementById('detailed-stats');
  let html = '<table style="width: 100%; color: #e6edf3; border-collapse: collapse;">';
  html += `
    <tr style="border-bottom: 1px solid #2d3a5a;">
      <th style="text-align: left; padding: 10px; color: #7dd3fc;">Field</th>
      <th style="text-align: right; padding: 10px; color: #7dd3fc;">Accuracy</th>
      <th style="text-align: right; padding: 10px; color: #7dd3fc;">Corrections</th>
      <th style="text-align: right; padding: 10px; color: #7dd3fc;">Avg Confidence</th>
    </tr>
  `;

  metrics.forEach(metric => {
    const accuracy = Math.round((metric.accuracy_rate || 0) * 100);
    const confidence = Math.round((metric.avg_confidence || 0) * 100);
    html += `
      <tr style="border-bottom: 1px solid #2d3a5a;">
        <td style="padding: 10px;">${metric.field_type}</td>
        <td style="padding: 10px; text-align: right;">${accuracy}%</td>
        <td style="padding: 10px; text-align: right;">${metric.total_corrections || 0}</td>
        <td style="padding: 10px; text-align: right;">${confidence}%</td>
      </tr>
    `;
  });

  html += '</table>';
  container.innerHTML = html;
}

function generateRecommendations(metrics) {
  const container = document.getElementById('recommendations');
  let recommendations = [];

  metrics.forEach(metric => {
    const accuracy = (metric.accuracy_rate || 0) * 100;
    const corrections = metric.total_corrections || 0;

    if (accuracy < 60) {
      recommendations.push({
        type: 'critical',
        message: `<strong>${metric.field_type}</strong>: Low accuracy (${Math.round(accuracy)}%). Consider lowering confidence threshold or providing more training examples.`
      });
    } else if (corrections < 3) {
      recommendations.push({
        type: 'info',
        message: `<strong>${metric.field_type}</strong>: Limited training data (${corrections} corrections). Parser will improve with more examples.`
      });
    } else if (accuracy >= 85) {
      recommendations.push({
        type: 'success',
        message: `<strong>${metric.field_type}</strong>: Excellent performance (${Math.round(accuracy)}%). Consider using as template for other fields.`
      });
    }
  });

  if (recommendations.length === 0) {
    container.innerHTML = '<p class="small" style="color: #22c55e;">‚úÖ All systems performing within acceptable ranges</p>';
    return;
  }

  let html = '<div style="display: grid; gap: 10px;">';
  recommendations.forEach(rec => {
    const colors = {
      critical: '#ef4444',
      info: '#3b82f6',
      success: '#22c55e'
    };
    html += `
      <div style="background: #1e2a44; padding: 12px; border-radius: 8px; border-left: 3px solid ${colors[rec.type]};">
        <div style="color: #e6edf3; font-size: 14px;">${rec.message}</div>
      </div>
    `;
  });
  html += '</div>';

  container.innerHTML = html;
}

function exportMetrics() {
  if (!metricsData) {
    alert('No data to export. Please load metrics first.');
    return;
  }

  const dataStr = JSON.stringify(metricsData, null, 2);
  const dataBlob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `parser-metrics-${new Date().toISOString().split('T')[0]}.json`;
  link.click();
}

// Auto-load on page load
window.addEventListener('DOMContentLoaded', loadMetrics);

// Auto-refresh every 30 seconds
setInterval(loadMetrics, 30000);
</script>

</body>
</html>
