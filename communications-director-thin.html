<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Communications Director Dashboard - Thin Client</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f8fafc;
            color: #334155;
        }

        .dashboard {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-header {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 24px;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: white;
            color: #64748b;
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #f8fafc;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stat-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-icon {
            font-size: 32px;
        }

        .stat-title {
            font-weight: 600;
            color: #1e293b;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #3b82f6;
        }

        .stat-description {
            font-size: 14px;
            color: #64748b;
            margin-top: 4px;
        }

        .content-sections {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .main-content, .side-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f1f5f9;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filters-bar {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-label {
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
        }

        .form-control {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .assignments-table {
            width: 100%;
            border-collapse: collapse;
        }

        .assignments-table th {
            background: #f8fafc;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
        }

        .assignments-table td {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
        }

        .assignments-table tr:hover {
            background: #f9fafb;
        }

        .assignment-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .assignment-meta {
            font-size: 12px;
            color: #64748b;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-pending { background: #fef3c7; color: #92400e; }
        .status-in_progress { background: #dbeafe; color: #1e40af; }
        .status-review { background: #e0e7ff; color: #3730a3; }
        .status-completed { background: #d1fae5; color: #059669; }
        .status-blocked { background: #fee2e2; color: #dc2626; }

        .priority-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
        }

        .priority-urgent { background: #fee2e2; color: #dc2626; }
        .priority-high { background: #fef3c7; color: #d97706; }
        .priority-medium { background: #dbeafe; color: #2563eb; }
        .priority-low { background: #f3f4f6; color: #6b7280; }

        .assignee-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .assignee-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #3b82f6;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }

        .due-date {
            font-size: 14px;
        }

        .due-overdue { color: #dc2626; }
        .due-today { color: #d97706; }
        .due-soon { color: #2563eb; }
        .due-normal { color: #64748b; }

        .actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background: white;
            color: #374151;
            font-size: 12px;
            cursor: pointer;
        }

        .action-btn:hover {
            background: #f9fafb;
        }

        .action-btn.primary {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .recent-activity {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 4px;
        }

        .activity-user {
            font-weight: 500;
            color: #1e293b;
        }

        .activity-time {
            font-size: 12px;
            color: #64748b;
        }

        .activity-description {
            font-size: 14px;
            color: #4b5563;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f1f5f9;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            color: #374151;
        }

        .form-textarea {
            width: 100%;
            min-height: 80px;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
            padding-top: 12px;
            border-top: 1px solid #f1f5f9;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }
        .toast.info { background: #3b82f6; }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="header-top">
                <h1>üìä Communications Director Dashboard</h1>
                <div class="header-actions">
                    <a href="/writers" class="btn btn-secondary">üë§ Writers Dashboard</a>
                    <a href="/" class="btn btn-secondary">üìù Editor</a>
                    <button class="btn btn-primary" onclick="showCreateAssignmentModal()">‚ûï New Assignment</button>
                    <button class="btn btn-success" onclick="showCreateBriefModal()">‚ú® New Brief</button>
                </div>
            </div>
        </div>

        <!-- Statistics Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">üìã</div>
                    <div>
                        <div class="stat-title">Total Assignments</div>
                        <div class="stat-value" id="totalAssignments">-</div>
                        <div class="stat-description">All active assignments</div>
                    </div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">‚è∞</div>
                    <div>
                        <div class="stat-title">Due Today</div>
                        <div class="stat-value" id="dueToday">-</div>
                        <div class="stat-description">Assignments due today</div>
                    </div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">üìù</div>
                    <div>
                        <div class="stat-title">Content Pieces</div>
                        <div class="stat-value" id="totalContent">-</div>
                        <div class="stat-description">All political content</div>
                    </div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">‚úÖ</div>
                    <div>
                        <div class="stat-title">Completed This Week</div>
                        <div class="stat-value" id="completedWeek">-</div>
                        <div class="stat-description">Completed assignments</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="content-sections">
            <div class="main-content">
                <div class="section-header">
                    <div class="section-title">üìã Assignments & Content</div>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="refreshData()">üîÑ Refresh</button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="filters-bar">
                    <div class="filter-group">
                        <label class="filter-label">Search</label>
                        <input type="text" id="searchInput" class="form-control" placeholder="Search assignments..." onkeyup="debounceFilter()">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Status</label>
                        <select id="statusFilter" class="form-control" onchange="filterAssignments()">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="in_progress">In Progress</option>
                            <option value="review">Review</option>
                            <option value="completed">Completed</option>
                            <option value="blocked">Blocked</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Assignee</label>
                        <select id="assigneeFilter" class="form-control" onchange="filterAssignments()">
                            <option value="">All Writers</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Priority</label>
                        <select id="priorityFilter" class="form-control" onchange="filterAssignments()">
                            <option value="">All Priority</option>
                            <option value="urgent">Urgent</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Due</label>
                        <select id="dueFilter" class="form-control" onchange="filterAssignments()">
                            <option value="">Any time</option>
                            <option value="overdue">Overdue</option>
                            <option value="today">Due Today</option>
                            <option value="tomorrow">Due Tomorrow</option>
                            <option value="week">This Week</option>
                        </select>
                    </div>
                </div>

                <!-- Assignments Table -->
                <div id="loadingAssignments" class="loading">Loading assignments...</div>
                <div id="assignmentsContainer" style="display: none;">
                    <table class="assignments-table">
                        <thead>
                            <tr>
                                <th>Assignment</th>
                                <th>Assignee</th>
                                <th>Status</th>
                                <th>Priority</th>
                                <th>Due Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="assignmentsBody">
                        </tbody>
                    </table>
                </div>
                <div id="emptyAssignments" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">üì≠</div>
                    <div>No assignments found</div>
                    <p style="margin-top: 8px; font-size: 14px;">Create your first assignment to get started</p>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="side-content">
                <div class="section-header">
                    <div class="section-title">üìà Recent Activity</div>
                </div>
                <div class="recent-activity" id="recentActivity">
                    <div class="loading">Loading activity...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Assignment Modal -->
    <div id="createAssignmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Create New Assignment</div>
                <button class="close-btn" onclick="hideCreateAssignmentModal()">&times;</button>
            </div>
            <form id="createAssignmentForm">
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" name="title" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Assignment Type</label>
                    <select name="assignment_type" class="form-control" required>
                        <option value="">Select content type</option>
                        <option value="speech">Speech</option>
                        <option value="talking-points">Talking Points</option>
                        <option value="press-release">Press Release</option>
                        <option value="blog-post">Blog Post</option>
                        <option value="social-media">Social Media</option>
                        <option value="op-ed">Op-Ed</option>
                        <option value="newsletter">Newsletter</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea name="description" class="form-control form-textarea" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Brief</label>
                    <textarea name="brief" class="form-control form-textarea" placeholder="Detailed brief for the writer"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Assign to</label>
                    <select name="assignee_id" class="form-control" id="assigneeSelect">
                        <option value="">Select writer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select name="priority" class="form-control">
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                        <option value="high">High</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Due Date</label>
                    <input type="datetime-local" name="due_date" class="form-control">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideCreateAssignmentModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Assignment</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Communications Brief Modal -->
    <div id="createBriefModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Create Communications Brief</div>
                <button class="close-btn" onclick="hideCreateBriefModal()">&times;</button>
            </div>
            <form id="createBriefForm">
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" name="title" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea name="description" class="form-control form-textarea" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Target Audience</label>
                    <input type="text" name="audience" class="form-control" placeholder="e.g., General public, Voters, Media">
                </div>
                <div class="form-group">
                    <label class="form-label">Tone</label>
                    <select name="tone" class="form-control">
                        <option value="professional">Professional</option>
                        <option value="conversational">Conversational</option>
                        <option value="urgent">Urgent</option>
                        <option value="inspiring">Inspiring</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Key Points (JSON format)</label>
                    <textarea name="key_points" class="form-control form-textarea" placeholder='["Point 1", "Point 2", "Point 3"]'></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Assigned to</label>
                    <select name="assigned_to" class="form-control" id="briefAssigneeSelect">
                        <option value="">Select writer</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideCreateBriefModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Brief</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        class CommunicationsDirectorDashboard {
            constructor() {
                this.assignments = [];
                this.users = [];
                this.briefs = [];
                this.content = [];
                this.filteredAssignments = [];
                this.filterTimeout = null;
            }

            async init() {
                try {
                    await this.loadData();
                    this.setupEventListeners();
                    this.renderDashboard();
                    console.log('‚úÖ Communications Director Dashboard initialized');
                } catch (error) {
                    console.error('‚ùå Failed to initialize dashboard:', error);
                    this.showToast('Failed to load dashboard', 'error');
                }
            }

            async loadData() {
                try {
                    // Load assignments
                    this.assignments = await this.apiCall('GET', '/assignments') || [];

                    // Load users for assignee dropdowns
                    this.users = await this.apiCall('GET', '/auth/users') || [];
                    this.populateUserDropdowns();

                    // Load communications briefs
                    this.briefs = await this.apiCall('GET', '/speeches/briefs') || [];

                    // Load all political content for statistics
                    await this.loadAllContent();

                    this.filteredAssignments = [...this.assignments];
                } catch (error) {
                    console.error('Failed to load data:', error);
                    // Use sample data if API fails
                    this.assignments = this.getSampleData();
                    this.filteredAssignments = [...this.assignments];
                }
            }

            async loadAllContent() {
                const contentTypes = ['speeches', 'social_posts', 'policy_documents', 'press_releases', 'campaign_materials', 'event_content', 'voter_outreach'];
                this.content = [];

                for (const type of contentTypes) {
                    try {
                        let items;
                        if (type === 'speeches') {
                            items = await this.apiCall('GET', '/speeches') || [];
                        } else {
                            items = await this.apiCall('GET', `/political-content/${type}`) || [];
                        }
                        this.content.push(...items);
                    } catch (error) {
                        console.warn(`Failed to load ${type}:`, error);
                    }
                }
            }

            populateUserDropdowns() {
                const writers = this.users.filter(user => user.role === 'writer' || user.role === 'reviewer');

                ['assigneeSelect', 'briefAssigneeSelect', 'assigneeFilter'].forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        const isFilter = selectId === 'assigneeFilter';
                        select.innerHTML = isFilter ? '<option value="">All Writers</option>' : '<option value="">Select writer</option>';

                        writers.forEach(writer => {
                            const option = document.createElement('option');
                            option.value = writer.id;
                            option.textContent = writer.name;
                            select.appendChild(option);
                        });
                    }
                });
            }

            renderDashboard() {
                this.updateStatistics();
                this.renderAssignments();
                this.renderRecentActivity();
                document.getElementById('loadingAssignments').style.display = 'none';
            }

            updateStatistics() {
                const today = new Date().toDateString();
                const weekStart = new Date();
                weekStart.setDate(weekStart.getDate() - 7);

                const stats = {
                    total: this.assignments.length,
                    dueToday: this.assignments.filter(a => new Date(a.due_date).toDateString() === today).length,
                    totalContent: this.content.length,
                    completedWeek: this.assignments.filter(a =>
                        a.status === 'completed' && new Date(a.updated_at) >= weekStart
                    ).length
                };

                document.getElementById('totalAssignments').textContent = stats.total;
                document.getElementById('dueToday').textContent = stats.dueToday;
                document.getElementById('totalContent').textContent = stats.totalContent;
                document.getElementById('completedWeek').textContent = stats.completedWeek;
            }

            renderAssignments() {
                const tbody = document.getElementById('assignmentsBody');
                const container = document.getElementById('assignmentsContainer');
                const emptyState = document.getElementById('emptyAssignments');

                if (this.filteredAssignments.length === 0) {
                    container.style.display = 'none';
                    emptyState.style.display = 'block';
                    return;
                }

                container.style.display = 'block';
                emptyState.style.display = 'none';

                tbody.innerHTML = this.filteredAssignments.map(assignment => {
                    const assignee = this.users.find(u => u.id === assignment.assignee_id);
                    const dueDate = assignment.due_date ? new Date(assignment.due_date) : null;
                    const priority = this.calculatePriority(assignment);

                    return `
                        <tr>
                            <td>
                                <div class="assignment-title">${assignment.title}</div>
                                <div class="assignment-meta">${assignment.id} ‚Ä¢ ${assignment.description || 'No description'}</div>
                            </td>
                            <td>
                                ${assignee ? `
                                    <div class="assignee-info">
                                        <div class="assignee-avatar" style="background: ${this.getAvatarColor(assignee.name)}">${this.getInitials(assignee.name)}</div>
                                        <span>${assignee.name}</span>
                                    </div>
                                ` : 'Unassigned'}
                            </td>
                            <td>
                                <span class="status-badge status-${assignment.status || 'pending'}">
                                    ${this.formatStatus(assignment.status || 'pending')}
                                </span>
                            </td>
                            <td>
                                <span class="priority-badge priority-${priority}">
                                    ${priority.charAt(0).toUpperCase() + priority.slice(1)}
                                </span>
                            </td>
                            <td>
                                <div class="due-date ${this.getDueDateClass(dueDate)}">
                                    ${this.formatDueDate(dueDate)}
                                </div>
                            </td>
                            <td>
                                <div class="actions">
                                    <button class="action-btn primary" onclick="dashboard.editAssignment('${assignment.id}')">Edit</button>
                                    <button class="action-btn" onclick="dashboard.updateStatus('${assignment.id}')">Update</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            renderRecentActivity() {
                const container = document.getElementById('recentActivity');

                // Create activity from recent assignments and content updates
                const activities = [];

                // Recent assignment updates
                this.assignments.slice(0, 5).forEach(assignment => {
                    const assignee = this.users.find(u => u.id === assignment.assignee_id);
                    activities.push({
                        user: assignee?.name || 'System',
                        action: `Assignment "${assignment.title}" ${assignment.status}`,
                        time: assignment.updated_at,
                        type: 'assignment'
                    });
                });

                // Recent content updates
                this.content.slice(0, 3).forEach(item => {
                    const user = this.users.find(u => u.id === item.created_by);
                    activities.push({
                        user: user?.name || 'Writer',
                        action: `Created ${item.title || 'new content'}`,
                        time: item.created_at,
                        type: 'content'
                    });
                });

                // Sort by time
                activities.sort((a, b) => new Date(b.time) - new Date(a.time));

                container.innerHTML = activities.slice(0, 10).map(activity => `
                    <div class="activity-item">
                        <div class="activity-header">
                            <span class="activity-user">${activity.user}</span>
                            <span class="activity-time">${this.formatTime(activity.time)}</span>
                        </div>
                        <div class="activity-description">${activity.action}</div>
                    </div>
                `).join('');
            }

            // Filtering and searching
            filterAssignments() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const statusFilter = document.getElementById('statusFilter').value;
                const assigneeFilter = document.getElementById('assigneeFilter').value;
                const priorityFilter = document.getElementById('priorityFilter').value;
                const dueFilter = document.getElementById('dueFilter').value;

                this.filteredAssignments = this.assignments.filter(assignment => {
                    // Search filter
                    if (searchTerm && !assignment.title.toLowerCase().includes(searchTerm) &&
                        !(assignment.description && assignment.description.toLowerCase().includes(searchTerm))) {
                        return false;
                    }

                    // Status filter
                    if (statusFilter && assignment.status !== statusFilter) {
                        return false;
                    }

                    // Assignee filter
                    if (assigneeFilter && assignment.assignee_id != assigneeFilter) {
                        return false;
                    }

                    // Priority filter
                    if (priorityFilter && this.calculatePriority(assignment) !== priorityFilter) {
                        return false;
                    }

                    // Due date filter
                    if (dueFilter && assignment.due_date) {
                        const dueDate = new Date(assignment.due_date);
                        const now = new Date();
                        const diffDays = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));

                        switch (dueFilter) {
                            case 'overdue':
                                if (diffDays >= 0) return false;
                                break;
                            case 'today':
                                if (diffDays !== 0) return false;
                                break;
                            case 'tomorrow':
                                if (diffDays !== 1) return false;
                                break;
                            case 'week':
                                if (diffDays > 7) return false;
                                break;
                        }
                    }

                    return true;
                });

                this.renderAssignments();
            }

            debounceFilter() {
                clearTimeout(this.filterTimeout);
                this.filterTimeout = setTimeout(() => {
                    this.filterAssignments();
                }, 300);
            }

            // API methods
            async apiCall(method, endpoint, data = null) {
                try {
                    const config = {
                        method,
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include'
                    };

                    if (data && (method === 'POST' || method === 'PUT')) {
                        config.body = JSON.stringify(data);
                    }

                    const response = await fetch(`/api${endpoint}`, config);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error(`API Error (${method} ${endpoint}):`, error);
                    throw error;
                }
            }

            // Event handlers
            setupEventListeners() {
                document.getElementById('createAssignmentForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.createAssignment();
                });

                document.getElementById('createBriefForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.createBrief();
                });
            }

            async createAssignment() {
                const formData = new FormData(document.getElementById('createAssignmentForm'));
                const data = {};

                for (let [key, value] of formData.entries()) {
                    data[key] = value;
                }

                // Generate assignment ID
                data.id = `A-${new Date().getFullYear()}-${String(this.assignments.length + 1).padStart(3, '0')}`;
                data.assignor_id = 1; // Current user ID
                data.status = 'pending';

                try {
                    const result = await this.apiCall('POST', '/assignments', data);
                    this.hideCreateAssignmentModal();
                    this.showToast(`${data.assignment_type?.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()) || 'Assignment'} created successfully with AI-generated brief`, 'success');
                    await this.refreshData();
                } catch (error) {
                    console.error('Create assignment failed:', error);
                    this.showToast('Failed to create assignment', 'error');
                }
            }

            async createBrief() {
                const formData = new FormData(document.getElementById('createBriefForm'));
                const data = {};

                for (let [key, value] of formData.entries()) {
                    if (key === 'key_points' && value) {
                        try {
                            data[key] = JSON.parse(value);
                        } catch (e) {
                            data[key] = value.split(',').map(s => s.trim());
                        }
                    } else {
                        data[key] = value;
                    }
                }

                try {
                    const result = await this.apiCall('POST', '/speeches/briefs', data);
                    this.hideCreateBriefModal();
                    this.showToast('Communications brief created successfully', 'success');
                    await this.loadData();
                } catch (error) {
                    console.error('Create brief failed:', error);
                    this.showToast('Failed to create brief', 'error');
                }
            }

            // Modal methods
            showCreateAssignmentModal() {
                document.getElementById('createAssignmentModal').classList.add('show');
            }

            hideCreateAssignmentModal() {
                document.getElementById('createAssignmentModal').classList.remove('show');
                document.getElementById('createAssignmentForm').reset();
            }

            showCreateBriefModal() {
                document.getElementById('createBriefModal').classList.add('show');
            }

            hideCreateBriefModal() {
                document.getElementById('createBriefModal').classList.remove('show');
                document.getElementById('createBriefForm').reset();
            }

            // Utility methods
            calculatePriority(assignment) {
                if (!assignment.due_date) return assignment.priority || 'medium';

                const dueDate = new Date(assignment.due_date);
                const now = new Date();
                const diffHours = (dueDate - now) / (1000 * 60 * 60);

                if (diffHours < 0) return 'urgent'; // Overdue
                if (diffHours <= 24) return 'urgent'; // Due within 24 hours
                if (diffHours <= 72) return 'high'; // Due within 3 days

                return assignment.priority || 'medium';
            }

            formatStatus(status) {
                return status.split('_').map(word =>
                    word.charAt(0).toUpperCase() + word.slice(1)
                ).join(' ');
            }

            formatDueDate(date) {
                if (!date) return 'No due date';

                const now = new Date();
                const diffMs = date - now;
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

                if (diffMs < 0) {
                    return `Overdue by ${Math.abs(diffDays)} day${Math.abs(diffDays) !== 1 ? 's' : ''}`;
                } else if (diffDays === 0) {
                    return 'Due today';
                } else if (diffDays === 1) {
                    return 'Due tomorrow';
                } else {
                    return `Due in ${diffDays} day${diffDays !== 1 ? 's' : ''}`;
                }
            }

            getDueDateClass(date) {
                if (!date) return 'due-normal';

                const now = new Date();
                const diffMs = date - now;

                if (diffMs < 0) return 'due-overdue';
                if (diffMs <= 24 * 60 * 60 * 1000) return 'due-today';
                if (diffMs <= 72 * 60 * 60 * 1000) return 'due-soon';
                return 'due-normal';
            }

            formatTime(timeStr) {
                const time = new Date(timeStr);
                const now = new Date();
                const diffMs = now - time;
                const diffMinutes = Math.floor(diffMs / (1000 * 60));
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

                if (diffMinutes < 60) return `${diffMinutes}m ago`;
                if (diffHours < 24) return `${diffHours}h ago`;
                if (diffDays < 7) return `${diffDays}d ago`;
                return time.toLocaleDateString();
            }

            getAvatarColor(name) {
                const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'];
                let hash = 0;
                for (let i = 0; i < name.length; i++) {
                    hash = name.charCodeAt(i) + ((hash << 5) - hash);
                }
                return colors[Math.abs(hash) % colors.length];
            }

            getInitials(name) {
                return name.split(' ').map(n => n[0]).join('').toUpperCase();
            }

            async refreshData() {
                try {
                    await this.loadData();
                    this.renderDashboard();
                    this.showToast('Data refreshed', 'success');
                } catch (error) {
                    this.showToast('Failed to refresh data', 'error');
                }
            }

            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => toast.classList.add('show'), 100);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            getSampleData() {
                return [
                    {
                        id: 'A-2024-001',
                        title: 'Healthcare Policy Statement',
                        description: 'Draft statement on Medicare expansion',
                        brief: 'Create comprehensive statement outlining position on Medicare expansion',
                        assignee_id: 2,
                        assignor_id: 1,
                        status: 'in_progress',
                        priority: 'high',
                        due_date: new Date(Date.now() + 48 * 60 * 60 * 1000).toISOString(),
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    }
                ];
            }
        }

        // Global functions for inline handlers
        let dashboard;

        function showCreateAssignmentModal() {
            dashboard.showCreateAssignmentModal();
        }

        function hideCreateAssignmentModal() {
            dashboard.hideCreateAssignmentModal();
        }

        function showCreateBriefModal() {
            dashboard.showCreateBriefModal();
        }

        function hideCreateBriefModal() {
            dashboard.hideCreateBriefModal();
        }

        function filterAssignments() {
            dashboard.filterAssignments();
        }

        function debounceFilter() {
            dashboard.debounceFilter();
        }

        function refreshData() {
            dashboard.refreshData();
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            dashboard = new CommunicationsDirectorDashboard();
            dashboard.init();
        });
    </script>
</body>
</html>